---
title: "Mod Builder"
editor: source
draft: true
---

```{r setup, include = F}
library(tidyverse)
library(nflfastR)
library(nflreadr)
library(ggimage)
library(ggrepel)
library(patchwork)
library(caret)
library(vip)
library(plotly)
library(Rcpp)
library(RcppParallel)
library(rsample)
library(gbm)
library(e1071)
library(gtsummary)

knitr::opts_chunk$set(
  fig.width = 7,
  fig.asp = .6,
  out.width = "95%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

`%nin%` = Negate(`%in%`)

set.seed(37564)

teams_colors_logos = teams_colors_logos %>% filter(team_abbr %nin% c("OAK", "SD", "STL", "LAR"))
```

# Load Data

```{r load data or somethin}
#reg20_df = 
#  load_pbp(2020) %>% 
#  filter(season_type == "REG")

# For weekly spreads vs results:
#weeks_1to4 = 
#  reg20_df %>% 
#  filter(game_seconds_remaining == 3600 & posteam %in% NA) %>%
#  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
#  pivot_longer(
#    c(home_team, away_team),
#    values_to = "team",
#    names_to = "home_away",
#    names_pattern = "(.*)_team"
#  ) %>% 
#  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
#         result = ifelse(home_away == "home", result, -result)) %>% 
#  select(week, team, spread, result) %>% 
#  filter(week %in% c(1:4)) %>% 
#  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
#  group_by(week, team) %>% 
#  ggplot(aes(x = spread, y = result)) +
#  geom_image(aes(image = team_logo_espn)) +
#  geom_abline(color = "black") +
#  facet_grid( ~ week)
#
#weeks_5to8 = 
#  reg20_df %>% 
#  filter(game_seconds_remaining == 3600 & posteam %in% NA) %>%
#  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
#  pivot_longer(
#    c(home_team, away_team),
#    values_to = "team",
#    names_to = "home_away",
#    names_pattern = "(.*)_team"
#  ) %>% 
#  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
#         result = ifelse(home_away == "home", result, -result)) %>% 
#  select(week, team, spread, result) %>% 
#  filter(week %in% c(5:8)) %>% 
#  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
#  group_by(week, team) %>% 
#  ggplot(aes(x = spread, y = result)) +
#  geom_image(aes(image = team_logo_espn)) +
#  geom_abline(color = "black") +
#  facet_grid( ~ week)
#
#weeks_9to12 = 
#  reg20_df %>% 
#  filter(game_seconds_remaining == 3600 & posteam %in% NA) %>%
#  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
#  pivot_longer(
#    c(home_team, away_team),
#    values_to = "team",
#    names_to = "home_away",
#    names_pattern = "(.*)_team"
#  ) %>% 
#  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
#         result = ifelse(home_away == "home", result, -result)) %>% 
#  select(week, team, spread, result) %>% 
#  filter(week %in% c(9:12)) %>% 
#  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
#  group_by(week, team) %>% 
#  ggplot(aes(x = spread, y = result)) +
#  geom_image(aes(image = team_logo_espn)) +
#  geom_abline(color = "black") +
#  facet_grid( ~ week)
#
#weeks_13to16 = 
#  reg20_df %>% 
#  filter(game_seconds_remaining == 3600 & posteam %in% NA) %>%
#  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
#  pivot_longer(
#    c(home_team, away_team),
#    values_to = "team",
#    names_to = "home_away",
#    names_pattern = "(.*)_team"
#  ) %>% 
#  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
#         result = ifelse(home_away == "home", result, -result)) %>% 
#  select(week, team, spread, result) %>% 
#  filter(week %in% c(13:16)) %>% 
#  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
#  group_by(week, team) %>% 
#  ggplot(aes(x = spread, y = result)) +
#  geom_image(aes(image = team_logo_espn)) +
#  geom_abline(color = "black") +
#  facet_grid( ~ week)
#
#layout = "
#AAAA
#BBBB
#CCCC
#DDDD"
#
#weeks_1to4 + weeks_5to8 + weeks_9to12 + weeks_13to16 + plot_layout(design = #layout)

future::plan("multisession")
szn_all = 
  load_pbp(2009:2024) %>%  
  filter(season_type == "REG")

szn_all_playoffs = 
  load_pbp(2009:2024)

roster_all_df = 
  fast_scraper_roster(2009:2025) %>% 
  rows_update(
    tibble(
      season = 2025,
      full_name = "Keenan Allen",
      team = "LAC"
    ),
    by = c("full_name", "season")
  )
```

# 2021

## Spreads and O/U vs Actual Results:

```{r 2021 stuff}
szn2021 = 
  load_pbp(2021) %>%  
  filter(season_type == "REG")

szn2022 = 
  load_pbp(2022) %>%  
  filter(season_type == "REG")

# spread vs results
week1_spreads = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 1) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result)) %>% 
  select(team, spread, result) %>% 
  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
  ggplot(aes(x = spread, y = result)) +
  geom_image(aes(image = team_logo_espn)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red")

# lines vs totals
week1_totals_df = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 1) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  unite("teams", home_team:away_team, sep = "_")

week1_totals = 
  week1_totals_df %>% 
  ggplot(aes(x = total_line, y = total)) +
  geom_point(aes(size = abs(result)), alpha = 0.75) + 
  geom_text_repel(aes(label = teams)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red") + 
  theme(legend.position = "none")

# spread vs results
week2_spreads = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 2) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result)) %>% 
  select(team, spread, result) %>% 
  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
  ggplot(aes(x = spread, y = result)) +
  geom_image(aes(image = team_logo_espn)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red")

# lines vs totals
week2_totals_df = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 2) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  unite("teams", home_team:away_team, sep = "_")

week2_totals = 
  week2_totals_df %>% 
  ggplot(aes(x = total_line, y = total)) +
  geom_point(aes(size = abs(result)), alpha = 0.75) + 
  geom_text_repel(aes(label = teams)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red") + 
  theme(legend.position = "none")

# spread vs results
week3_spreads = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 3) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result)) %>% 
  select(team, spread, result) %>% 
  left_join(teams_colors_logos, by = c("team" = "team_abbr")) %>% 
  ggplot(aes(x = spread, y = result)) +
  geom_image(aes(image = team_logo_espn)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red")

# lines vs totals
week3_totals_df = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  filter(week == 3) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  unite("teams", home_team:away_team, sep = "_")

week3_totals = 
  week3_totals_df %>% 
  ggplot(aes(x = total_line, y = total)) +
  geom_point(aes(size = abs(result)), alpha = 0.75) + 
  geom_text_repel(aes(label = teams)) +
  geom_abline(color = "black") + 
  geom_abline(linetype = "dotted", intercept = 3, color = "blue") + 
  geom_abline(linetype = "dotted", intercept = -3, color = "red") +
  geom_abline(intercept = 7, color = "blue") +
  geom_abline(intercept = -7, color = "red") + 
  theme(legend.position = "none")

# plots
week1_spreads + week2_spreads + week3_spreads
week1_totals + week2_totals + week3_totals
```

```{r spreads and o/u boxplots}
# Load 2021 data
szn2021 = 
  load_pbp(2021) %>%  
  filter(season_type == "REG")
 
ros2021 = 
  fast_scraper_roster(2021) 

# Spreads boxplots
spreads_df = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result),
         dif = result - spread) %>% 
  select(week, team, spread, result, dif)

med_spread_df = 
  spreads_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

spreads_df = 
  spreads_df %>% 
  left_join(med_spread_df)

spread_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_spread_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_spreads = 
  spreads_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = spread_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(title = "Game Results vs Spread", 
       x = "Point Difference (Result - Spread)", 
       y = "Team") + 
  theme(plot.title = element_text(hjust = 0.5))

# Totals boxplots
totals_df = 
  szn2021 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(dif = total - total_line) %>% 
  select(team, dif, total_line, total)

med_tot_df = 
  totals_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

totals_df = 
  totals_df %>% 
  left_join(med_tot_df)

tot_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_tot_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_totals = 
  totals_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = tot_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(
    title = "Game Totals vs O/U Line",
    x = "Point Difference (Total - Line)", 
    y = "Team") +
  theme(plot.title = element_text(hjust = 0.5))

plot_spreads + plot_totals
```

## QB

```{r passing stuff}

qb_att = 
  szn2021 %>% 
  filter(pass_attempt == 1) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer)

qb_epa = 
  szn2021 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(epa) %>% 
  summarize(mean_epa = mean(qb_epa)) %>% 
  arrange(-mean_epa) %>% 
  drop_na(passer) %>% 
  rowid_to_column("rank") %>% 
  mutate(passer_og = passer) %>% 
  unite("rank_name", rank, passer, sep = ". ") %>% 
  arrange(mean_epa) %>% 
  rename(passer = passer_og) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 199)

qb_epa_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_epa) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_epa)),
    passer = fct_reorder(passer, mean_epa),
    nud = ifelse(mean_epa > 0, -0.02 - mean_epa, 0.02 - mean_epa)
    )

qb_epa_cols %>% 
  ggplot(aes(x = mean_epa, y = passer)) +
  geom_bar(stat = "identity", fill = qb_epa_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_epa_cols$nud) +
  labs(title = "2021 Mean QB EPA (Min. 200 Attempts)",
       x = "Mean EPA",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_cpoe = 
  szn2021 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(cpoe) %>% 
  summarize(mean_cpoe = mean(cpoe)) %>% 
  arrange(desc(mean_cpoe)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 199)

qb_cpoe_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_cpoe) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_cpoe)),
    passer = fct_reorder(passer, mean_cpoe),
    nud = ifelse(mean_cpoe > 0, -0.65 - mean_cpoe, 0.65 - mean_cpoe)
    )

qb_cpoe_cols %>% 
  ggplot(aes(x = mean_cpoe, y = passer)) +
  geom_bar(stat = "identity", fill = qb_cpoe_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_cpoe_cols$nud) +
  labs(title = "Weeks 1-12 Mean QB CPOE (Min. 200 Attempts)",
       x = "Mean CPOE",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_adot = 
  szn2021 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(air_yards) %>% 
  summarize(adot = mean(air_yards)) %>% 
  arrange(desc(adot)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 199) %>% 
  left_join(qb_cpoe) %>% 
  rename(team_abbr = posteam)

adot_cols = 
  qb_adot %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_cpoe, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_cpoe))

qb_adot %>%
  ggplot(aes(x = adot, y = mean_cpoe)) +
  geom_point(color = adot_cols$team_color, cex = qb_adot$n_att / 80, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(adot_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(adot_cols$adot), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(adot_cols$mean_cpoe) - qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe)), ymax = mean(adot_cols$mean_cpoe) + qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(adot_cols$adot) - qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot)), xmax = mean(adot_cols$adot) + qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2021 QB CPOE vs Air Yards (Min. 200 Attempts)",
    x = "Mean Air Yards",
    y = "Mean CPOE"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

# CPOE vs EPA
cpoe_epa = 
  qb_cpoe %>%
  left_join(qb_epa)

cpoe_epa_cols = 
  cpoe_epa %>% 
  rename(team_abbr = posteam) %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_epa))

cpoe_epa %>% 
  ggplot(aes(x = mean_cpoe, y = mean_epa)) +
  geom_point(color = cpoe_epa_cols$team_color, cex = cpoe_epa_cols$n_att / 80, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(cpoe_epa_cols$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(cpoe_epa_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(cpoe_epa_cols$mean_epa) - qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa)), ymax = mean(cpoe_epa_cols$mean_epa) + qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(cpoe_epa_cols$mean_cpoe) - qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe)), xmax = mean(cpoe_epa_cols$mean_cpoe) + qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2021 QB EPA vs CPOE (Min. 200 Attempts)",
    x = "Mean CPOE",
    y = "Mean EPA"
  ) +
  theme(plot.title = element_text(hjust = 0.5))

```

## RB

```{r}
ryoe_github = read_csv(url("https://raw.githubusercontent.com/tejseth/RYOE/main/ryoe_github.csv"))

ryoe2021 = 
  ryoe_github %>% 
  separate(player, c("first", "last"), sep = " ") %>% 
  mutate(first = str_sub(first, 1, 1)) %>% 
  unite("player_name", first, last, sep = ".") %>% 
  mutate(
    player_name = ifelse(player_name == "J.Williams" & offense == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "D.Williams" & offense == "KC", "Da.Williams", player_name),
    player_name = ifelse(player_name == "M.Carter" & offense == "NYJ", "Mi.Williams", player_name),
    player_name = ifelse(player_name == "J.Taylor" & offense == "IND", "Jo.Taylor", player_name),
    player_name = ifelse(player_name == "D.Johnson" & offense == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "D.Harris" & offense == "NE", "Da.Harris", player_name),
    offense = ifelse(player_name == "M.Ingram", "NO", offense)
    ) %>% 
  filter(season == 2021)

ryoe_df = 
  ryoe2021 %>% 
  group_by(player_name) %>% 
  summarize(
    team_abbr = offense,
    ryoe = ryoe,
    rush = row_number(),
    n_att = n(),
    cum_ryoe = cumsum(ryoe)) %>% 
  filter(n_att >= 150)

med_ryoe = 
  ryoe_df %>% 
  group_by(player_name, team_abbr) %>% 
  summarize(med_ryoe = median(ryoe)) %>%  
  arrange(med_ryoe, team_abbr)

ryoe_df = 
  ryoe_df %>% 
  left_join(med_ryoe) %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe))

ryoe_cols = 
  teams_colors_logos %>% 
  left_join(med_ryoe, by = "team_abbr") %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe)) %>% 
  arrange(med_ryoe) %>% 
  drop_na(player_name)

ryoe_df %>% 
  ggplot(aes(x = player_name, y = ryoe, fill = player_name)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(alpha = 0.5) +
  labs(
    title = "2021 RYOE by RB (Min. 150 Attempts)",
    x = "RB",
    y = "RYOE"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = ryoe_cols$team_color)

# Rush yards
#rush_df = 
#  ryoe2021 %>% 
#  group_by(player_name) %>% 
#  summarize(
#    team_abbr = offense,
#    yards = yards,
#    rush = row_number(),
#    n_att = n()) %>% 
#  filter(n_att > 79)
#
#med_rush = 
#  rush_df %>% 
#  group_by(player_name, team_abbr) %>% 
#  summarize(med_yards = median(yards)) %>%  
#  arrange(med_yards, team_abbr)
#
#rush_df = 
#  rush_df %>% 
#  left_join(med_rush) %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards))
#
#rush_cols = 
#  teams_colors_logos %>% 
#  left_join(med_rush, by = "team_abbr") %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards)) %>% 
#  arrange(med_yards) %>% 
#  drop_na(player_name)
#
#rush_df %>% 
#  ggplot(aes(x = player_name, y = yards, color = player_name, fill = player_name)) +
#  #geom_point(alpha = 0.75) +
#  geom_jitter(width = 0.25, alpha = 0.75) +
#  labs(
#    title = "Rushing Yards by RB (Min. 80 Attempts)",
#    x = "Rusher",
#    y = "Rushing Yards"
#  ) +
#  theme(
#    plot.title = element_text(hjust = 0.5),
#    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#    legend.position = "None"
#    ) +
#  scale_color_manual(values = rush_cols$team_color)



```

## WR

```{r}
wr_epa = 
  ros2021 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2021, by = "receiver_id") %>% 
  filter(complete_pass == 1) %>% 
  rename(team_abbr = posteam) %>% 
  mutate(receiver = ifelse(receiver == "A.Brown" & team_abbr == "TB", "An.Brown", receiver)) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    epa = epa,
    mean_epa = mean(epa),
    med_epa = median(epa),
    n_rec = n()
  ) %>% 
  filter(n_rec >= 50, receiver %nin% NA) %>% 
  ungroup() %>% 
  mutate(receiver = fct_reorder(receiver, epa, median))

wr_epa_cols = 
  wr_epa %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    med_epa = median(epa)
  ) %>% 
  left_join(teams_colors_logos, by = "team_abbr") %>% 
  group_by(med_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), med_epa)) %>% 
  arrange(med_epa) %>% 
  drop_na(receiver)

wr_epa %>% 
  ggplot(aes(x = receiver, y = epa, fill = receiver)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(width = 0.25, alpha = 0.75) +
  labs(
    title = "2021 EPA/Catch by WR (Min. 50 Catches)",
    x = "WR",
    y = "EPA/Catch"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = wr_epa_cols$team_color)

# targets & EPA
wr_tar = 
  ros2021 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2021, by = "receiver_id") %>% 
  filter(pass_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  mutate(receiver = ifelse(receiver == "A.Brown" & team_abbr == "TB", "An.Brown", receiver)) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    targets = n()#,
    #mean_epa = mean(epa)
  ) %>% 
  filter(receiver %nin% NA) %>% 
  ungroup() %>% 
  left_join(distinct(select(wr_epa, -epa))) %>% 
  drop_na(mean_epa)

tar_cols = 
  wr_tar %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), mean_epa))

wr_tar %>%
  ggplot(aes(x = targets, y = mean_epa)) +
  geom_point(color = tar_cols$team_color, size = 4.2, alpha = 0.75) +
  geom_text_repel(aes(label = receiver), alpha = 4) +
  geom_hline(yintercept = mean(wr_tar$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(wr_tar$targets), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(wr_tar$mean_epa) - qnorm(0.975)*sd(wr_tar$mean_epa)/sqrt(length(wr_tar$mean_epa)), ymax = mean(wr_tar$mean_epa) + qnorm(0.975)*sd(wr_tar$mean_epa)/sqrt(length(wr_tar$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(wr_tar$targets) - qnorm(0.975)*sd(wr_tar$targets)/sqrt(length(wr_tar$targets)), xmax = mean(wr_tar$targets) + qnorm(0.975)*sd(wr_tar$targets)/sqrt(length(wr_tar$targets))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2021 WR EPA/Catch vs Targets (Min. 50 Catches)",
    x = "# of Targets",
    y = "Mean EPA/Catch"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

```

## Fantasy

```{r fantasy}
fantasy_df = 
  szn2021 %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5*receptions) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

# WR
wr_rec = 
  szn2021 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

wr_fpts = 
  fantasy_df %>% 
  left_join(wr_rec) %>% 
  filter(n_rec >= 50) %>% 
  inner_join(
    fast_scraper_roster(2021) %>% 
    filter(position == "WR") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_wr = 
  wr_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>%  
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

wr_fpts = 
  wr_fpts %>% 
  left_join(med_wr) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

wr_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_wr, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_wr = 
  wr_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = wr_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2021 WR PPG (Min. 50 Receptions)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "WR") + 
  theme(plot.title = element_text(hjust = 0.5))

# RB
rb_att = 
  szn2021 %>% 
  filter(rush_attempt == 1) %>% 
  group_by(posteam, rusher) %>% 
  summarize(n_att = n()) %>% 
  drop_na(rusher) %>% 
  rename(player_name = rusher) %>% 
  mutate(player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name))

rb_fpts = 
  fantasy_df %>% 
  left_join(rb_att) %>% 
  filter(n_att >= 150) %>% 
  inner_join(
    fast_scraper_roster(2021) %>% 
    filter(position == "RB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_rb = 
  rb_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

rb_fpts = 
  rb_fpts %>% 
  left_join(med_rb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

rb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_rb, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_rb = 
  rb_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = rb_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2021 RB PPG (Min. 150 Rushing Attempts)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "RB") + 
  theme(plot.title = element_text(hjust = 0.5))

# QB
qb_att = 
  szn2021 %>% 
  filter(pass_attempt == 1) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer) %>% 
  rename(player_name = passer)

qb_fpts = 
  fantasy_df %>% 
  left_join(qb_att) %>% 
  filter(n_att >= 200) %>% 
  inner_join(
    fast_scraper_roster(2021) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_qb = 
  qb_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

qb_fpts = 
  qb_fpts %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

qb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_qb = 
  qb_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = qb_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2021 QB PPG (Min. 200 Passing Attempts)", 
       x = "Fantasy PPG", 
       y = "QB") + 
  theme(plot.title = element_text(hjust = 0.5))

# TE
te_rec = 
  szn2021 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver)

te_fpts = 
  fantasy_df %>% 
  left_join(te_rec) %>% 
  filter(n_rec >= 30) %>% 
  inner_join(
    fast_scraper_roster(2021) %>% 
    filter(position == "TE") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_te = 
  te_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

te_fpts = 
  te_fpts %>% 
  left_join(med_te) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

te_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_te, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_te = 
  te_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = te_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2021 TE PPG (Min. 30 Receptions)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "TE") + 
  theme(plot.title = element_text(hjust = 0.5))

fan_rb + fan_wr
fan_qb + fan_te
```

```{r fantasy time}
future::plan("multisession")
fantasy_all = 
  szn_all %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5*receptions) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

qb_all = 
  fantasy_all %>% 
  inner_join(
    fast_scraper_roster(c(2009:2021)) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  group_by(season, player_name) %>% 
  summarize(ppg = mean(fantasy_points))

qb_all %>% 
  filter(player_name %in% c("A.Rodgers", "D.Brees", "M.Stafford", "T.Brady")) %>% 
  ggplot(aes(x = season, y = ppg, color = player_name)) +
  geom_line()


```

## Defenses

```{r}
View(
  szn2021 %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
  select(defteam, pass, epa) %>% 
  group_by(defteam, pass) %>% 
  summarize(epa = mean(epa)) %>% 
  pivot_wider(names_from = pass, values_from = epa) %>% 
  rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>% 
  arrange(-def_rush_epa)
  )
```


```{r rushing}
rb_act = 
  szn2021 %>% 
  select(rusher) %>% 
  unique() %>% 
  drop_na() %>% 
  arrange() %>% 
  mutate(active = 1)

qbs = 
  szn_all %>% 
  filter(pass == 1) %>% 
  select(passer, pass) %>% 
  group_by(passer) %>% 
  summarize(passes = n()) %>% 
  filter(passes > 100) %>% 
  rowid_to_column("QB_id") %>% 
  ungroup() %>% 
  mutate(rusher = passer) %>% 
  select(-passer)

rush_df = 
  szn_all %>% 
  select(desc, rush, play_type, run_location, run_gap, rusher, rushing_yards) %>% 
  mutate(run_gap = ifelse(run_location == "middle", "center", run_gap)) %>% 
  left_join(qbs) %>% 
  filter(play_type == "run" & QB_id %in% NA) %>% 
  drop_na(rusher) %>% 
  left_join(rb_act) %>% 
  filter(active == 1) %>% 
  drop_na(run_gap, run_location)

avg_att = 
  rush_df %>% 
  group_by(rusher) %>% 
  summarize(
    tot_att = n(),
    avg_att = sum(rushing_yards)/n()) %>% 
  filter(tot_att > 80)

# run gaps
gg_rush = 
  rush_df %>% 
  mutate(run_gap = fct_relevel(as.factor(run_gap), "center", "guard", "tackle", "end")) %>% 
  group_by(rusher, run_gap) %>% 
  summarize(
    att = n(),
    yds_att = sum(rushing_yards)/att) %>% 
  filter(att > 20) %>% 
  ungroup() %>% 
  left_join(avg_att) %>% 
  drop_na(avg_att) %>% 
  mutate(across(c(yds_att, avg_att), round, 2)) %>% 
  mutate(rusher = fct_reorder(rusher, avg_att),
         text_label = str_c("Overall Yds/Rush: ", avg_att, "\nAttempts: ", att))
#%>% 
#  ggplot(aes(x = yds_att, y = rusher, fill = run_gap)) +
#  geom_col() +
#  facet_grid(. ~run_gap)



gg_rush %>% 
  plot_ly(
    x = ~yds_att,
    y = ~rusher,
    type = "bar",
    color = ~run_gap,
    colors = "viridis",
    text = ~text_label
  ) %>% 
  layout(barmode = "stack")
  


```

# 2022

## Spreads and O/U vs Actual Results:

```{r spreads and o/u boxplots}
# Load 2022 data
szn2022 = 
  load_pbp(2022) %>%  
  filter(season_type == "REG")
 
ros2022 = 
  fast_scraper_roster(2022) 

# Spreads boxplots
spreads_df = 
  szn2022 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result),
         dif = result - spread) %>% 
  select(week, team, spread, result, dif)

med_spread_df = 
  spreads_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

spreads_df = 
  spreads_df %>% 
  left_join(med_spread_df)

spread_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_spread_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_spreads = 
  spreads_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = spread_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(title = "Game Results vs Spread", 
       x = "Point Difference (Result - Spread)", 
       y = "Team") + 
  theme(plot.title = element_text(hjust = 0.5))

# Totals boxplots
totals_df = 
  szn2022 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(dif = total - total_line) %>% 
  select(team, dif, total_line, total)

med_tot_df = 
  totals_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

totals_df = 
  totals_df %>% 
  left_join(med_tot_df)

tot_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_tot_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_totals = 
  totals_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = tot_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(
    title = "Game Totals vs O/U Line",
    x = "Point Difference (Total - Line)", 
    y = "Team") +
  theme(plot.title = element_text(hjust = 0.5))

plot_spreads + plot_totals
```

## QB

```{r passing stuff}

qb_att = 
  szn2022 %>% 
  filter(pass_attempt == 1) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer)

qb_epa = 
  szn2022 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(epa) %>% 
  summarize(mean_epa = mean(qb_epa)) %>% 
  arrange(-mean_epa) %>% 
  drop_na(passer) %>% 
  rowid_to_column("rank") %>% 
  mutate(passer_og = passer) %>% 
  unite("rank_name", rank, passer, sep = ". ") %>% 
  arrange(mean_epa) %>% 
  rename(passer = passer_og) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 10)

qb_epa_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_epa) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_epa)),
    passer = fct_reorder(passer, mean_epa),
    nud = ifelse(mean_epa > 0, -0.02 - mean_epa, 0.02 - mean_epa)
    )

qb_epa_cols %>% 
  ggplot(aes(x = mean_epa, y = passer)) +
  geom_bar(stat = "identity", fill = qb_epa_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_epa_cols$nud) +
  labs(title = "2022 Mean QB EPA (Min. 10 Attempts)",
       x = "Mean EPA",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_cpoe = 
  szn2022 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(cpoe) %>% 
  summarize(mean_cpoe = mean(cpoe)) %>% 
  arrange(desc(mean_cpoe)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 10)

qb_cpoe_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_cpoe) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_cpoe)),
    passer = fct_reorder(passer, mean_cpoe),
    nud = ifelse(mean_cpoe > 0, -0.65 - mean_cpoe, 0.65 - mean_cpoe)
    )

qb_cpoe_cols %>% 
  ggplot(aes(x = mean_cpoe, y = passer)) +
  geom_bar(stat = "identity", fill = qb_cpoe_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_cpoe_cols$nud) +
  labs(title = "Weeks 1-12 Mean QB CPOE (Min. 200 Attempts)",
       x = "Mean CPOE",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_adot = 
  szn2022 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(air_yards) %>% 
  summarize(adot = mean(air_yards)) %>% 
  arrange(desc(adot)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 199) %>% 
  left_join(qb_cpoe) %>% 
  rename(team_abbr = posteam)

adot_cols = 
  qb_adot %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_cpoe, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_cpoe))

qb_adot %>%
  ggplot(aes(x = adot, y = mean_cpoe)) +
  geom_point(color = adot_cols$team_color, cex = qb_adot$n_att / 80, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(adot_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(adot_cols$adot), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(adot_cols$mean_cpoe) - qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe)), ymax = mean(adot_cols$mean_cpoe) + qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(adot_cols$adot) - qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot)), xmax = mean(adot_cols$adot) + qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2022 QB CPOE vs Air Yards (Min. 200 Attempts)",
    x = "Mean Air Yards",
    y = "Mean CPOE"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

# CPOE vs EPA
cpoe_epa = 
  qb_cpoe %>%
  left_join(qb_epa)

cpoe_epa_cols = 
  cpoe_epa %>% 
  rename(team_abbr = posteam) %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_epa))

cpoe_epa %>% 
  ggplot(aes(x = mean_cpoe, y = mean_epa)) +
  geom_point(color = cpoe_epa_cols$team_color, cex = cpoe_epa_cols$n_att / 80, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(cpoe_epa_cols$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(cpoe_epa_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(cpoe_epa_cols$mean_epa) - qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa)), ymax = mean(cpoe_epa_cols$mean_epa) + qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(cpoe_epa_cols$mean_cpoe) - qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe)), xmax = mean(cpoe_epa_cols$mean_cpoe) + qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2021 QB EPA vs CPOE (Min. 200 Attempts)",
    x = "Mean CPOE",
    y = "Mean EPA"
  ) +
  theme(plot.title = element_text(hjust = 0.5))

```

## RB

```{r}
ryoe_github = read_csv(url("https://raw.githubusercontent.com/tejseth/RYOE/main/ryoe_github.csv"))

ryoe2022 = 
  ryoe_github %>% 
  separate(player, c("first", "last"), sep = " ") %>% 
  mutate(first = str_sub(first, 1, 1)) %>% 
  unite("player_name", first, last, sep = ".") %>% 
  mutate(
    player_name = ifelse(player_name == "J.Williams" & offense == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "D.Williams" & offense == "KC", "Da.Williams", player_name),
    player_name = ifelse(player_name == "M.Carter" & offense == "NYJ", "Mi.Williams", player_name),
    player_name = ifelse(player_name == "J.Taylor" & offense == "IND", "Jo.Taylor", player_name),
    player_name = ifelse(player_name == "D.Johnson" & offense == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "D.Harris" & offense == "NE", "Da.Harris", player_name),
    offense = ifelse(player_name == "M.Ingram", "NO", offense)
    ) %>% 
  filter(season == 2022)

ryoe_df = 
  ryoe2022 %>% 
  group_by(player_name) %>% 
  summarize(
    team_abbr = offense,
    ryoe = ryoe,
    rush = row_number(),
    n_att = n(),
    cum_ryoe = cumsum(ryoe)) %>% 
  filter(n_att >= 100)

med_ryoe = 
  ryoe_df %>% 
  group_by(player_name, team_abbr) %>% 
  summarize(med_ryoe = median(ryoe)) %>%  
  arrange(med_ryoe, team_abbr)

ryoe_df = 
  ryoe_df %>% 
  left_join(med_ryoe) %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe))

ryoe_cols = 
  teams_colors_logos %>% 
  left_join(med_ryoe, by = "team_abbr") %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe)) %>% 
  arrange(med_ryoe) %>% 
  drop_na(player_name)

ryoe_df %>% 
  ggplot(aes(x = player_name, y = ryoe, fill = player_name)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(alpha = 0.5) +
  labs(
    title = "2022 RYOE by RB (Min. 100 Attempts)",
    x = "RB",
    y = "RYOE"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = ryoe_cols$team_color)

# Rush yards
#rush_df = 
#  ryoe2021 %>% 
#  group_by(player_name) %>% 
#  summarize(
#    team_abbr = offense,
#    yards = yards,
#    rush = row_number(),
#    n_att = n()) %>% 
#  filter(n_att > 79)
#
#med_rush = 
#  rush_df %>% 
#  group_by(player_name, team_abbr) %>% 
#  summarize(med_yards = median(yards)) %>%  
#  arrange(med_yards, team_abbr)
#
#rush_df = 
#  rush_df %>% 
#  left_join(med_rush) %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards))
#
#rush_cols = 
#  teams_colors_logos %>% 
#  left_join(med_rush, by = "team_abbr") %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards)) %>% 
#  arrange(med_yards) %>% 
#  drop_na(player_name)
#
#rush_df %>% 
#  ggplot(aes(x = player_name, y = yards, color = player_name, fill = player_name)) +
#  #geom_point(alpha = 0.75) +
#  geom_jitter(width = 0.25, alpha = 0.75) +
#  labs(
#    title = "Rushing Yards by RB (Min. 80 Attempts)",
#    x = "Rusher",
#    y = "Rushing Yards"
#  ) +
#  theme(
#    plot.title = element_text(hjust = 0.5),
#    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#    legend.position = "None"
#    ) +
#  scale_color_manual(values = rush_cols$team_color)



```

## WR

```{r}
wr_epa = 
  ros2021 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2021, by = "receiver_id") %>% 
  filter(complete_pass == 1) %>% 
  rename(team_abbr = posteam) %>% 
  mutate(receiver = ifelse(receiver == "A.Brown" & team_abbr == "TB", "An.Brown", receiver)) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    epa = epa,
    mean_epa = mean(epa),
    med_epa = median(epa),
    n_rec = n()
  ) %>% 
  filter(n_rec >= 50, receiver %nin% NA) %>% 
  ungroup() %>% 
  mutate(receiver = fct_reorder(receiver, epa, median))

wr_epa_cols = 
  wr_epa %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    med_epa = median(epa)
  ) %>% 
  left_join(teams_colors_logos, by = "team_abbr") %>% 
  group_by(med_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), med_epa)) %>% 
  arrange(med_epa) %>% 
  drop_na(receiver)

wr_epa %>% 
  ggplot(aes(x = receiver, y = epa, fill = receiver)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(width = 0.25, alpha = 0.75) +
  labs(
    title = "2021 EPA/Catch by WR (Min. 50 Catches)",
    x = "WR",
    y = "EPA/Catch"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = wr_epa_cols$team_color)

# targets & EPA
wr_tar = 
  ros2021 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2021, by = "receiver_id") %>% 
  filter(pass_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  mutate(receiver = ifelse(receiver == "A.Brown" & team_abbr == "TB", "An.Brown", receiver)) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    targets = n()#,
    #mean_epa = mean(epa)
  ) %>% 
  filter(receiver %nin% NA) %>% 
  ungroup() %>% 
  left_join(distinct(select(wr_epa, -epa))) %>% 
  drop_na(mean_epa)

tar_cols = 
  wr_tar %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), mean_epa))

wr_tar %>%
  ggplot(aes(x = targets, y = mean_epa)) +
  geom_point(color = tar_cols$team_color, size = 4.2, alpha = 0.75) +
  geom_text_repel(aes(label = receiver), alpha = 4) +
  geom_hline(yintercept = mean(wr_tar$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(wr_tar$targets), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(wr_tar$mean_epa) - qnorm(0.975)*sd(wr_tar$mean_epa)/sqrt(length(wr_tar$mean_epa)), ymax = mean(wr_tar$mean_epa) + qnorm(0.975)*sd(wr_tar$mean_epa)/sqrt(length(wr_tar$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(wr_tar$targets) - qnorm(0.975)*sd(wr_tar$targets)/sqrt(length(wr_tar$targets)), xmax = mean(wr_tar$targets) + qnorm(0.975)*sd(wr_tar$targets)/sqrt(length(wr_tar$targets))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2021 WR EPA/Catch vs Targets (Min. 50 Catches)",
    x = "# of Targets",
    y = "Mean EPA/Catch"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

```

## Fantasy

```{r fantasy}
fantasy_df = 
  szn2022 %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5*receptions) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

# WR
wr_rec = 
  szn2022 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

wr_fpts = 
  fantasy_df %>% 
  left_join(wr_rec) %>% 
  filter(n_rec >= 20) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "WR") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_wr = 
  wr_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>%  
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

wr_fpts = 
  wr_fpts %>% 
  left_join(med_wr) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

wr_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_wr, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_wr = 
  wr_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = wr_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 WR PPG (Min. 15 Receptions)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "WR") + 
  theme(plot.title = element_text(hjust = 0.5))

# RB
rb_att = 
  szn2022 %>% 
  filter(rush_attempt == 1) %>% 
  group_by(posteam, rusher) %>% 
  summarize(n_att = n()) %>% 
  drop_na(rusher) %>% 
  rename(player_name = rusher) %>% 
  mutate(player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name))

rb_fpts = 
  fantasy_df %>% 
  left_join(rb_att) %>% 
  filter(n_att >= 36) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "RB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_rb = 
  rb_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

rb_fpts = 
  rb_fpts %>% 
  left_join(med_rb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

rb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_rb, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_rb = 
  rb_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = rb_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 RB PPG (Min. 30 Rushing Attempts)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "RB") + 
  theme(plot.title = element_text(hjust = 0.5))

# QB
qb_att = 
  szn2022 %>% 
  filter(pass_attempt == 1 & sack == 0) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer) %>% 
  rename(player_name = passer)

qb_fpts = 
  fantasy_df %>% 
  left_join(qb_att) %>% 
  filter(n_att >= 65) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_qb = 
  qb_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

qb_fpts = 
  qb_fpts %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

qb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_qb = 
  qb_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = qb_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 QB PPG (Min. 50 Passing Attempts)", 
       x = "Fantasy PPG", 
       y = "QB") + 
  theme(plot.title = element_text(hjust = 0.5))

# TE
te_rec = 
  szn2022 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver)

te_fpts = 
  fantasy_df %>% 
  left_join(te_rec) %>% 
  filter(n_rec >= 10) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "TE") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_te = 
  te_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

te_fpts = 
  te_fpts %>% 
  left_join(med_te) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

te_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_te, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_te = 
  te_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = te_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 TE PPG (Min. 8 Receptions)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "TE") + 
  theme(plot.title = element_text(hjust = 0.5))

fan_rb + fan_wr
fan_qb + fan_te
(fan_rb + fan_wr) / (fan_qb + fan_te)
```

```{r fantasy time}
future::plan("multisession")
fantasy_all = 
  szn_all %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5*receptions) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "D.Johnson" & posteam == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "A.Brown" & posteam == "TB", "An.Brown", player_name),
    player_name = ifelse(player_name == "J.Williams" & posteam == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "M.Williams" & posteam == "LAC", "Mi.Williams", player_name)
    )

qb_all = 
  fantasy_all %>% 
  inner_join(
    fast_scraper_roster(c(2009:2021)) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  group_by(season, player_name) %>% 
  summarize(ppg = mean(fantasy_points))

qb_all %>% 
  filter(player_name %in% c("A.Rodgers", "D.Brees", "M.Stafford", "T.Brady")) %>% 
  ggplot(aes(x = season, y = ppg, color = player_name)) +
  geom_line()


```

## Defenses

```{r}
View(
  szn2021 %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
  select(defteam, pass, epa) %>% 
  group_by(defteam, pass) %>% 
  summarize(epa = mean(epa)) %>% 
  pivot_wider(names_from = pass, values_from = epa) %>% 
  rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>% 
  arrange(-def_rush_epa)
  )
```


```{r rushing}
rb_act = 
  szn2021 %>% 
  select(rusher) %>% 
  unique() %>% 
  drop_na() %>% 
  arrange() %>% 
  mutate(active = 1)

qbs = 
  szn_all %>% 
  filter(pass == 1) %>% 
  select(passer, pass) %>% 
  group_by(passer) %>% 
  summarize(passes = n()) %>% 
  filter(passes > 100) %>% 
  rowid_to_column("QB_id") %>% 
  ungroup() %>% 
  mutate(rusher = passer) %>% 
  select(-passer)

rush_df = 
  szn_all %>% 
  select(desc, rush, play_type, run_location, run_gap, rusher, rushing_yards) %>% 
  mutate(run_gap = ifelse(run_location == "middle", "center", run_gap)) %>% 
  left_join(qbs) %>% 
  filter(play_type == "run" & QB_id %in% NA) %>% 
  drop_na(rusher) %>% 
  left_join(rb_act) %>% 
  filter(active == 1) %>% 
  drop_na(run_gap, run_location)

avg_att = 
  rush_df %>% 
  group_by(rusher) %>% 
  summarize(
    tot_att = n(),
    avg_att = sum(rushing_yards)/n()) %>% 
  filter(tot_att > 80)

# run gaps
gg_rush = 
  rush_df %>% 
  mutate(run_gap = fct_relevel(as.factor(run_gap), "center", "guard", "tackle", "end")) %>% 
  group_by(rusher, run_gap) %>% 
  summarize(
    att = n(),
    yds_att = sum(rushing_yards)/att) %>% 
  filter(att > 20) %>% 
  ungroup() %>% 
  left_join(avg_att) %>% 
  drop_na(avg_att) %>% 
  mutate(across(c(yds_att, avg_att), round, 2)) %>% 
  mutate(rusher = fct_reorder(rusher, avg_att),
         text_label = str_c("Overall Yds/Rush: ", avg_att, "\nAttempts: ", att))
#%>% 
#  ggplot(aes(x = yds_att, y = rusher, fill = run_gap)) +
#  geom_col() +
#  facet_grid(. ~run_gap)



gg_rush %>% 
  plot_ly(
    x = ~yds_att,
    y = ~rusher,
    type = "bar",
    color = ~run_gap,
    colors = "viridis",
    text = ~text_label
  ) %>% 
  layout(barmode = "stack")
  


```

# 2023

## Spreads and O/U vs Actual Results:

```{r spreads and ou boxplots}
# Load 2023 data
szn2023 = 
  load_pbp(2023) %>%  
  filter(season_type == "REG") %>% 
  filter(week >= 11)
 
ros2023 = 
  fast_scraper_roster(2023) 

# Spreads boxplots
spreads_df = 
  szn2023 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result),
         dif = result - spread) %>% 
  select(week, team, spread, result, dif)

med_spread_df = 
  spreads_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

spreads_df = 
  spreads_df %>% 
  left_join(med_spread_df)

spread_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_spread_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_spreads = 
  spreads_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = spread_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(title = "Game Results vs Spread", 
       x = "Point Difference (Result - Spread)", 
       y = "Team") + 
  theme(plot.title = element_text(hjust = 0.5))

# Totals boxplots
totals_df = 
  szn2023 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(game_id, posteam, home_team, away_team, total_line, total, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(dif = total - total_line) %>% 
  select(team, dif, total_line, total)

med_tot_df = 
  totals_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

totals_df = 
  totals_df %>% 
  left_join(med_tot_df)

tot_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_tot_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_totals = 
  totals_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = tot_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(
    title = "Game Totals vs O/U Line",
    x = "Point Difference (Total - Line)", 
    y = "Team") +
  theme(plot.title = element_text(hjust = 0.5))

plot_spreads + plot_totals
```


## QB

```{r passing stuff}

qb_att = 
  szn2023 %>% 
  filter(pass_attempt == 1) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer)

qb_epa = 
  szn2023 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(epa) %>% 
  summarize(mean_epa = mean(qb_epa)) %>% 
  arrange(-mean_epa) %>% 
  drop_na(passer) %>% 
  rowid_to_column("rank") %>% 
  mutate(passer_og = passer) %>% 
  unite("rank_name", rank, passer, sep = ". ") %>% 
  arrange(mean_epa) %>% 
  rename(passer = passer_og) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 20)

qb_epa_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_epa) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_epa)),
    passer = fct_reorder(passer, mean_epa),
    nud = ifelse(mean_epa > 0, -0.02 - mean_epa, 0.02 - mean_epa)
    )

qb_epa_cols %>% 
  ggplot(aes(x = mean_epa, y = passer)) +
  geom_bar(stat = "identity", fill = qb_epa_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_epa_cols$nud) +
  labs(title = "2023 Mean QB EPA (Min. 20 Attempts)",
       x = "Mean EPA",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_cpoe = 
  szn2023 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(cpoe) %>% 
  summarize(mean_cpoe = mean(cpoe)) %>% 
  arrange(desc(mean_cpoe)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 20)

qb_cpoe_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(qb_cpoe) %>% 
  mutate(
    team_color = fct_reorder(as.factor(team_color), desc(mean_cpoe)),
    passer = fct_reorder(passer, mean_cpoe),
    nud = ifelse(mean_cpoe > 0, -0.65 - mean_cpoe, 0.65 - mean_cpoe)
    )

qb_cpoe_cols %>% 
  ggplot(aes(x = mean_cpoe, y = passer)) +
  geom_bar(stat = "identity", fill = qb_cpoe_cols$team_color) +
  geom_text(aes(label = passer), nudge_x = qb_cpoe_cols$nud) +
  labs(title = "Weeks 1-12 Mean QB CPOE (Min. 200 Attempts)",
       x = "Mean CPOE",
       y = "QB") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

qb_adot = 
  szn2023 %>%
  filter(qb_dropback == 1) %>% 
  group_by(posteam, passer) %>% 
  drop_na(air_yards) %>% 
  summarize(adot = mean(air_yards)) %>% 
  arrange(desc(adot)) %>% 
  drop_na(passer) %>% 
  left_join(qb_att) %>% 
  filter(n_att > 199) %>% 
  left_join(qb_cpoe) %>% 
  rename(team_abbr = posteam)

adot_cols = 
  qb_adot %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_cpoe, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_cpoe))

qb_adot %>%
  ggplot(aes(x = adot, y = mean_cpoe)) +
  geom_point(color = adot_cols$team_color, cex = qb_adot$n_att / 80, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(adot_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(adot_cols$adot), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(adot_cols$mean_cpoe) - qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe)), ymax = mean(adot_cols$mean_cpoe) + qnorm(0.975)*sd(adot_cols$mean_cpoe)/sqrt(length(adot_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(adot_cols$adot) - qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot)), xmax = mean(adot_cols$adot) + qnorm(0.975)*sd(adot_cols$adot)/sqrt(length(adot_cols$adot))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2023 QB CPOE vs Air Yards (Min. 200 Attempts)",
    x = "Mean Air Yards",
    y = "Mean CPOE"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

# CPOE vs EPA
cpoe_epa = 
  qb_cpoe %>%
  left_join(qb_epa)

cpoe_epa_cols = 
  cpoe_epa %>% 
  rename(team_abbr = posteam) %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(passer = fct_reorder(as.factor(passer), mean_epa))

cpoe_epa %>% 
  ggplot(aes(x = mean_cpoe, y = mean_epa)) +
  geom_point(color = cpoe_epa_cols$team_color, cex = cpoe_epa_cols$n_att / 20, alpha = 0.75) +
  geom_text_repel(aes(label = passer), alpha = 4) +
  geom_hline(yintercept = mean(cpoe_epa_cols$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(cpoe_epa_cols$mean_cpoe), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(cpoe_epa_cols$mean_epa) - qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa)), ymax = mean(cpoe_epa_cols$mean_epa) + qnorm(0.975)*sd(cpoe_epa_cols$mean_epa)/sqrt(length(cpoe_epa_cols$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(cpoe_epa_cols$mean_cpoe) - qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe)), xmax = mean(cpoe_epa_cols$mean_cpoe) + qnorm(0.975)*sd(cpoe_epa_cols$mean_cpoe)/sqrt(length(cpoe_epa_cols$mean_cpoe))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2023 QB EPA vs CPOE (Min. 200 Attempts)",
    x = "Mean CPOE",
    y = "Mean EPA"
  ) +
  theme(plot.title = element_text(hjust = 0.5))

```

## RB - RYOE

```{r}
ryoe_github = read_csv(url("https://raw.githubusercontent.com/tejseth/RYOE/main/ryoe_github.csv"))

ryoe2023 = 
  ryoe_github %>% 
  separate(player, c("first", "last"), sep = " ") %>% 
  mutate(first = str_sub(first, 1, 1)) %>% 
  unite("player_name", first, last, sep = ".") %>% 
  mutate(
    player_name = ifelse(player_name == "J.Williams" & offense == "DEN", "Jav.Williams", player_name),
    player_name = ifelse(player_name == "D.Williams" & offense == "KC", "Da.Williams", player_name),
    player_name = ifelse(player_name == "M.Carter" & offense == "NYJ", "Mi.Williams", player_name),
    player_name = ifelse(player_name == "J.Taylor" & offense == "IND", "Jo.Taylor", player_name),
    player_name = ifelse(player_name == "D.Johnson" & offense == "HOU", "Da.Johnson", player_name),
    player_name = ifelse(player_name == "D.Harris" & offense == "NE", "Da.Harris", player_name),
    offense = ifelse(player_name == "M.Ingram", "NO", offense)
    ) %>% 
  filter(season == 2023)

ryoe_df = 
  ryoe2023 %>% 
  group_by(player_name) %>% 
  summarize(
    team_abbr = offense,
    ryoe = ryoe,
    rush = row_number(),
    n_att = n(),
    cum_ryoe = cumsum(ryoe)) %>% 
  filter(n_att >= 100)

med_ryoe = 
  ryoe_df %>% 
  group_by(player_name, team_abbr) %>% 
  summarize(med_ryoe = median(ryoe)) %>%  
  arrange(med_ryoe, team_abbr)

ryoe_df = 
  ryoe_df %>% 
  left_join(med_ryoe) %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe))

ryoe_cols = 
  teams_colors_logos %>% 
  left_join(med_ryoe, by = "team_abbr") %>% 
  group_by(med_ryoe, team_abbr) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_ryoe)) %>% 
  arrange(med_ryoe) %>% 
  drop_na(player_name)

ryoe_df %>% 
  ggplot(aes(x = player_name, y = ryoe, fill = player_name)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(alpha = 0.5) +
  labs(
    title = "2023 RYOE by RB (Min. 100 Attempts)",
    x = "RB",
    y = "RYOE"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = ryoe_cols$team_color)

# Rush yards
#rush_df = 
#  ryoe2021 %>% 
#  group_by(player_name) %>% 
#  summarize(
#    team_abbr = offense,
#    yards = yards,
#    rush = row_number(),
#    n_att = n()) %>% 
#  filter(n_att > 79)
#
#med_rush = 
#  rush_df %>% 
#  group_by(player_name, team_abbr) %>% 
#  summarize(med_yards = median(yards)) %>%  
#  arrange(med_yards, team_abbr)
#
#rush_df = 
#  rush_df %>% 
#  left_join(med_rush) %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards))
#
#rush_cols = 
#  teams_colors_logos %>% 
#  left_join(med_rush, by = "team_abbr") %>% 
#  group_by(med_yards, team_abbr) %>% 
#  mutate(player_name = fct_reorder(as.factor(player_name), med_yards)) %>% 
#  arrange(med_yards) %>% 
#  drop_na(player_name)
#
#rush_df %>% 
#  ggplot(aes(x = player_name, y = yards, color = player_name, fill = player_name)) +
#  #geom_point(alpha = 0.75) +
#  geom_jitter(width = 0.25, alpha = 0.75) +
#  labs(
#    title = "Rushing Yards by RB (Min. 80 Attempts)",
#    x = "Rusher",
#    y = "Rushing Yards"
#  ) +
#  theme(
#    plot.title = element_text(hjust = 0.5),
#    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
#    legend.position = "None"
#    ) +
#  scale_color_manual(values = rush_cols$team_color)



```

## RB

```{r}
rb_epa = 
  ros2023 %>% 
  filter(position == "RB") %>% 
  mutate(rusher_id = gsis_id) %>% 
  select(rusher_id, position) %>% 
  inner_join(szn2023, by = "rusher_id") %>% 
  filter(rush_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(team_abbr, rusher) %>% 
  summarize(
    epa = epa,
    mean_epa = mean(epa),
    med_epa = median(epa),
    n_rush = n()
  ) %>% 
  filter(rusher %nin% NA & n_rush >= 70) %>% 
  ungroup()%>% 
  mutate(
    rusher = 
      case_when(
        team_abbr == "ATL" & str_detect(rusher, "Robinson") ~ "Bi.Robinson",
        team_abbr == "WAS" & str_detect(rusher, "Robinson") ~ "Br.Robinson", 
        .default = rusher
      )
  ) %>% 
  mutate(rusher = fct_reorder(as.factor(rusher), med_epa))

rb_epa_cols = 
  rb_epa %>% 
  distinct(team_abbr, rusher, med_epa) %>% 
  left_join(teams_colors_logos, by = "team_abbr") %>% 
  arrange(med_epa)

# rb_attempts = 
#   ros2023 %>% 
#   filter(position == "RB") %>% 
#   mutate(rusher_id = gsis_id) %>% 
#   select(rusher_id, position) %>% 
#   inner_join(szn2023, by = "rusher_id") %>% 
#   filter(rush_attempt == 1) %>% 
#   rename(team_abbr = posteam) %>% 
#   group_by(team_abbr, rusher) %>% 
#   summarize(
#     n_rush = n(),
#     mean_epa = mean(epa)
#   ) %>% 
#   filter(rusher %nin% NA & n_rush >= 40) %>% 
#   ungroup() %>% 
#   mutate(rusher = ifelse(team_abbr == "WAS", "Br.Robinson", rusher))

rb_epa %>% 
  ggplot(aes(x = rusher, y = epa, fill = rusher)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(width = 0.25, alpha = 0.75) +
  labs(
    title = "2023 EPA/Rush by RB (Min. 40 Rushes)",
    x = "WR",
    y = "EPA/Rush"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = rb_epa_cols$team_color)

```

## WR

```{r}
wr_tar = 
  ros2023 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2023, by = "receiver_id") %>% 
  filter(pass_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    targets = n()#,
    #mean_epa = mean(epa)
  ) %>% 
  filter(receiver %nin% NA & targets >= 50) %>% 
  ungroup()

wr_epa = 
  ros2023 %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2023, by = "receiver_id") %>% 
  filter(complete_pass == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    epa = epa,
    mean_epa = mean(epa),
    med_epa = median(epa),
    n_rec = n()
  ) %>% 
  filter(receiver %nin% NA) %>% 
  ungroup() %>% 
  left_join(wr_tar) %>% 
  drop_na(targets) %>% 
  mutate(receiver = fct_reorder(receiver, epa, median))

wr_epa_cols = 
  wr_epa %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    med_epa = median(epa)
  ) %>% 
  left_join(teams_colors_logos, by = "team_abbr") %>% 
  group_by(med_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), med_epa)) %>% 
  arrange(med_epa) %>% 
  drop_na(receiver)

tar_cols = 
  wr_tar %>% 
  left_join(distinct(select(wr_epa, -epa))) %>% 
  drop_na(mean_epa) %>% 
  left_join(teams_colors_logos) %>% 
  group_by(mean_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), mean_epa))

wr_epa %>% 
  ggplot(aes(x = receiver, y = epa, fill = receiver)) +
  geom_violin(alpha = 0.75) +
  #geom_jitter(width = 0.25, alpha = 0.75) +
  labs(
    title = "2023 EPA/Catch by WR (Min. 25 Targets)",
    x = "WR",
    y = "EPA/Catch"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 0.5),
    legend.position = "None"
    ) +
  scale_fill_manual(values = wr_epa_cols$team_color)

# targets & EPA

wr_tar

wr_epa %>% 
  distinct(receiver, targets, mean_epa) %>% 
  ggplot(aes(x = targets, y = mean_epa)) +
  geom_point(color = tar_cols$team_color, size = 4.2, alpha = 0.75) +
  geom_text_repel(aes(label = receiver), alpha = 4) +
  geom_hline(yintercept = mean(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(distinct(wr_epa, receiver, targets, mean_epa)$targets), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa) - qnorm(0.975)*sd(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa)/sqrt(length(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa)), ymax = mean(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa) + qnorm(0.975)*sd(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa)/sqrt(length(distinct(wr_epa, receiver, targets, mean_epa)$mean_epa))), alpha = 0.005, fill = "yellow") +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(distinct(wr_epa, receiver, targets, mean_epa)$targets) - qnorm(0.975)*sd(distinct(wr_epa, receiver, targets, mean_epa)$targets)/sqrt(length(distinct(wr_epa, receiver, targets, mean_epa)$targets)), xmax = mean(distinct(wr_epa, receiver, targets, mean_epa)$targets) + qnorm(0.975)*sd(distinct(wr_epa, receiver, targets, mean_epa)$targets)/sqrt(length(distinct(wr_epa, receiver, targets, mean_epa)$targets))), alpha = 0.005, fill = "yellow") + 
  labs(
    title = "2023 WR EPA/Catch vs Targets (Min. 25 Targets)",
    x = "# of Targets",
    y = "Mean EPA/Catch"
  ) +
  theme(plot.title = element_text(hjust = 0.42))

```

## Defenses & Offenses EPA

```{r}
szn2023 %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
  select(defteam, pass, epa) %>% 
  group_by(defteam, pass) %>% 
  summarize(epa = mean(epa)) %>% 
  pivot_wider(names_from = pass, values_from = epa) %>% 
  rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>% 
  # arrange(-def_rush_epa) %>% 
  left_join(
    szn2023 %>% 
      filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
      select(posteam, pass, epa) %>% 
      group_by(posteam, pass) %>% 
      summarize(epa = mean(epa)) %>% 
      pivot_wider(names_from = pass, values_from = epa) %>% 
      rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam"),
    by = "team"
  ) %>% 
  ungroup() %>% 
  mutate(
    off_rush_rank = rank(-off_rush_epa),
    off_pass_rank = rank(-off_pass_epa),
    def_rush_rank = rank(def_rush_epa),
    def_pass_rank = rank(def_pass_epa),
    mean_def_rush = mean(def_rush_epa),
    mean_def_pass = mean(def_pass_epa),
    mean_off_rush = mean(off_rush_epa),
    mean_off_pass = mean(off_pass_epa),
    def_ovr_adj = (def_rush_epa / mean_def_rush + def_pass_epa / mean_def_pass) / 2,
    off_ovr_adj = (off_rush_epa / mean_off_rush + off_pass_epa / mean_off_pass) / 2,
    def_ovr_rank = rank(def_ovr_adj),
    off_ovr_rank = rank(-off_ovr_adj)
    # off_ovr_rank = rank(off_rush_rank + off_pass_rank)
  ) %>% 
  # select(team, ends_with("rank")) %>% 
  # filter(team %in% c("JAX", "CLE")) %>% 
  view


```

## Fantasy

```{r fantasy}
fantasy_df = 
  szn2023 %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5*receptions) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
    )

# WR
wr_rec = 
  szn2023 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
  )

wr_fpts = 
  fantasy_df %>% 
  group_by(posteam, player_name) %>% 
  mutate(targets = sum(targets)) %>% 
  filter(targets >= 45) %>% 
  left_join(wr_rec) %>% 
  inner_join(
    fast_scraper_roster(2023) %>% 
    filter(position == "WR") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts, targets)

med_wr = 
  wr_fpts %>% 
  group_by(player_name, posteam, targets) %>% 
  summarize(med_pts = median(fpts)) %>%  
  arrange(-med_pts, -targets) %>% 
  rowid_to_column("rank") %>% 
  mutate(
    player_name_og = player_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts, targets) %>% 
  rename(player_name = player_name_og)
  
wr_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_wr, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  # mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts, targets) %>% 
  drop_na(player_name)

fan_wr = 
  wr_fpts %>% 
  left_join(med_wr) %>% 
  ggplot(aes(x = fpts, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = wr_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2023 WR PPG (Min. 45 Targets)", 
       x = "Fantasy PPG", 
       y = "WR") + 
  theme(plot.title = element_text(hjust = 0.5))

wr_mean_fpts = 
  wr_fpts %>% 
  group_by(posteam, player_name) %>% 
  mutate(sum_pts = sum(fpts), n_weeks = n()) %>% 
  distinct(posteam, player_name, sum_pts, targets, n_weeks) %>% 
  ungroup() %>% 
  mutate(
    mean_pts = sum_pts / n_weeks, 
    mean_tar = targets / n_weeks
  )

# PPG by Targets

wr_fpts %>% 
  ungroup() %>% 
  group_by(posteam, player_name) %>% 
  mutate(n_weeks = n()) %>% 
  ungroup() %>% 
  distinct(posteam, player_name, med_pts, targets, n_weeks) %>% 
  mutate(tar_gm = targets / n_weeks) %>% 
  # left_join(wr_fpts_cols %>% select(player_name, team_color)) %>% 
  arrange(med_pts, player_name) %>% 
  ggplot(aes(x = tar_gm, y = med_pts)) +
  geom_point(color = wr_fpts_cols$team_color, alpha = 0.75, size = 3) +
  geom_text_repel(aes(label = player_name), alpha = 4) +
  geom_hline(yintercept = mean(wr_mean_fpts$mean_pts), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(wr_mean_fpts$mean_tar), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(wr_mean_fpts$mean_pts) - qnorm(0.975)*sd(wr_mean_fpts$mean_pts)/sqrt(length(wr_mean_fpts$mean_pts)), ymax = mean(wr_mean_fpts$mean_pts) + qnorm(0.975)*sd(wr_mean_fpts$mean_pts)/sqrt(length(wr_mean_fpts$mean_pts))), alpha = 0.005, fill = "yellow") + 
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(wr_mean_fpts$mean_tar) - qnorm(0.975)*sd(wr_mean_fpts$mean_tar)/sqrt(length(wr_mean_fpts$mean_tar)), xmax = mean(wr_mean_fpts$mean_tar) + qnorm(0.975)*sd(wr_mean_fpts$mean_tar)/sqrt(length(wr_mean_fpts$mean_tar))), alpha = 0.005, fill = "yellow") + 
  scale_y_continuous(breaks = seq(0, 25, by = 5)) +
  # geom_smooth() +
  labs(
    title = "2023 WR Median Fantasy PPG vs Targets/Game (Min. 50 Targets)",
    x = "Targets/Game",
    y = "Median Fantasy PPG"
  ) + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.42)
  )

# Fantasy PPG and EPA
wr_fpts %>% 
  left_join(
    wr_epa %>% 
      distinct(team_abbr, receiver, mean_epa) %>% 
      rename(
        posteam = team_abbr,
        player_name = receiver
      ),
    by = c("posteam", "player_name")
  ) %>% 
  distinct(posteam, player_name, mean_epa, med_pts, targets) %>% 
  arrange(med_pts) %>% 
  ggplot(aes(x = mean_epa, y = med_pts)) +
  geom_point(aes(size = targets / 10), color = wr_fpts_cols$team_color, alpha = 0.75) +
  geom_text_repel(aes(label = player_name), alpha = 4) + 
  geom_smooth() +
  labs(
    title = "2023 WR Median Fantasy PPG vs EPA/Catch (Min. 50 Targets)",
    x = "Mean EPA/Catch",
    y = "Median Fantasy PPG"
  ) + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.42)
  )

# RB
rb_att = 
  szn2023 %>% 
  filter(rush_attempt == 1) %>% 
  group_by(posteam, rusher) %>% 
  summarize(n_att = n()) %>% 
  drop_na(rusher) %>% 
  rename(player_name = rusher) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
  )

rb_fpts = 
  fantasy_df %>% 
  group_by(player_id) %>% 
  mutate(n_rec = sum(receptions)) %>% 
  ungroup() %>% 
  left_join(rb_att) %>% 
  mutate(
    touches = n_att + n_rec
  ) %>% 
  filter(touches >= 75) %>% 
  inner_join(
    fast_scraper_roster(2023) %>% 
    filter(position == "RB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts, touches)

med_rb = 
  rb_fpts %>% 
  group_by(player_name, posteam, touches) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts, -touches) %>% 
  rowid_to_column("rank") %>% 
  mutate(
    player_name_og = player_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts, touches) %>% 
  rename(player_name = player_name_og)

# rb_fpts = 
#   rb_fpts %>% 
#   left_join(med_rb) %>% 
#   group_by(med_pts, posteam) %>% 
#   mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

rb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_rb, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts, touches) %>% 
  drop_na(player_name)

fan_rb = 
  rb_fpts %>% 
  left_join(med_rb) %>% 
  ggplot(aes(x = fpts, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = rb_fpts_cols$team_color, alpha = 0.75) +
  labs(
    title = "2023 RB PPG (Min. 75 Touches)", 
    x = "Fantasy PPG", 
    y = "RB"
  ) + 
  theme(plot.title = element_text(hjust = 0.5))

# QB
qb_att = 
  szn2022 %>% 
  filter(pass_attempt == 1 & sack == 0) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer) %>% 
  rename(player_name = passer)

qb_fpts = 
  fantasy_df %>% 
  left_join(qb_att) %>% 
  filter(n_att >= 65) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_qb = 
  qb_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

qb_fpts = 
  qb_fpts %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

qb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_qb = 
  qb_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = qb_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 QB PPG (Min. 50 Passing Attempts)", 
       x = "Fantasy PPG", 
       y = "QB") + 
  theme(plot.title = element_text(hjust = 0.5))

# TE
te_rec = 
  szn2022 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver)

te_fpts = 
  fantasy_df %>% 
  left_join(te_rec) %>% 
  filter(n_rec >= 10) %>% 
  inner_join(
    fast_scraper_roster(2022) %>% 
    filter(position == "TE") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, fpts)

med_te = 
  te_fpts %>% 
  group_by(player_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_name) %>% 
  unite("rank_name", rank, player_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_name = player_name_og)

te_fpts = 
  te_fpts %>% 
  left_join(med_te) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

te_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_te, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_name)

fan_te = 
  te_fpts %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = te_fpts_cols$team_color, alpha = 0.75) +
  labs(title = "2022 TE PPG (Min. 8 Receptions)", 
       x = "Fantasy PPG (0.5PPR)", 
       y = "TE") + 
  theme(plot.title = element_text(hjust = 0.5))

fan_rb + fan_wr
fan_qb + fan_te
(fan_rb + fan_wr) / (fan_qb + fan_te)
```

# 2024

## Spreads and O/U vs Actual Results:

```{r spreads and ou boxplots}
# Load 2024 data
szn2024 = 
  load_pbp(2024) %>%  
  filter(season_type == "REG")# %>% 
  #filter(week >= 11)
 
szn2025 = 
  load_pbp(2025) %>%  
  filter(season_type == "REG")# %>% 
  #filter(week >= 11)

ros2024 = 
  fast_scraper_roster(2024) 

# Spreads boxplots
spreads_df = 
  szn2024 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result),
         dif = result - spread) %>% 
  select(week, team, spread, result, dif)

med_spread_df = 
  spreads_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

spreads_df = 
  spreads_df %>% 
  left_join(med_spread_df)

spread_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_spread_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_spreads = 
  spreads_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = spread_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(title = "Game Results vs Spread", 
       x = "Point Difference (Result - Spread)", 
       y = "Team") + 
  theme(plot.title = element_text(hjust = 0.5))

# Totals boxplots
totals_df = 
  szn2024 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(game_id, week, posteam, home_team, away_team, total_line, total, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(dif = total - total_line) %>% 
  select(team, week, dif, total_line, total)

med_tot_df = 
  totals_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

totals_df = 
  totals_df %>% 
  left_join(med_tot_df)

tot_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_tot_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_totals = 
  totals_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = tot_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(
    title = "Game Totals vs O/U Line",
    x = "Point Difference (Total - Line)", 
    y = "Team") +
  theme(plot.title = element_text(hjust = 0.5))

plot_spreads + plot_totals

view(spreads_df)

spreads_df %>% 
  # filter(between(week, 1, 7)) %>% 
  ggplot(aes(x = week, y = dif, color = team)) + 
  # geom_line(linewidth = 1.2) + 
  geom_point(size = 3) + 
  geom_smooth(aes(group = team), se = F, method = "loess") + 
  geom_abline(slope = 0, intercept = 0, linetype = "dotted") + 
  geom_abline(slope = 0, intercept = c(-7, 7), linetype = "dashed") + 
  scale_color_manual(values = teams_colors_logos$team_color) +
  coord_cartesian(ylim = c(-21, 21)) +
  facet_wrap(~ team, nrow = 4) + 
  scale_x_continuous(breaks = seq(2, 18, by = 2)) +
  theme(legend.position = "none")

totals_df %>% 
  # filter(between(week, 1, 7)) %>% 
  ggplot(aes(x = week, y = dif, color = team)) + 
  # geom_line(linewidth = 1.2) + 
  geom_point(size = 3) + 
  geom_smooth(aes(group = team), se = F, method = "loess") + 
  geom_abline(slope = 0, intercept = 0, linetype = "dotted") + 
  geom_abline(slope = 0, intercept = c(-7, 7), linetype = "dashed") + 
  scale_color_manual(values = teams_colors_logos$team_color) +
  coord_cartesian(ylim = c(-21, 21)) +
  facet_wrap(~ team, nrow = 4) + 
  scale_x_continuous(breaks = seq(2, 18, by = 2)) + 
  theme(legend.position = "none")

szn_2024_epa = 
  szn2024 %>% 
  # filter(week == 1) %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
  select(week, posteam, pass, epa) %>% 
  group_by(week, posteam, pass) %>% 
  summarize(epa = mean(epa)) %>% 
  pivot_wider(names_from = pass, values_from = epa) %>% 
  rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>% 
  ungroup() %>% 
  arrange(team, week) %>% 
  group_by(team) %>% 
  mutate(
    across(starts_with("off_") & ends_with("_epa"), ~ lag(.), .names = "prior_{.col}")
  ) %>%
  ungroup() %>% 
  left_join(
    szn2024 %>% 
      filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
      select(week, defteam, pass, epa) %>% 
      group_by(week, defteam, pass) %>% 
      summarize(epa = mean(epa)) %>% 
      pivot_wider(names_from = pass, values_from = epa) %>% 
      rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>% 
      ungroup() %>% 
      arrange(team, week) %>% 
      group_by(team) %>% 
      mutate(
        across(starts_with("def_") & ends_with("_epa"), ~ lag(.), .names = "prior_{.col}")
      ) %>% 
      ungroup(),
    by = c("week", "team")
  )

szn2024_sched = 
  read_csv("./schedule2024.csv") %>% 
  pivot_longer(
    2:19,
    values_to = "team",
    names_to = "week"
  ) %>% 
  mutate(
    TEAM = str_remove(TEAM, "@"), 
   team = str_remove(team, "@"),
   TEAM = str_replace(TEAM, "LAR", "LA"), 
   team = str_replace(team, "LAR", "LA"),
   TEAM = str_replace(TEAM, "WSH", "WAS"), 
   team = str_replace(team, "WSH", "WAS")
  ) %>% 
  rename(
    team_opp = team,
    team = TEAM
  ) %>% 
  mutate(week = as.integer(week))

view(szn2024_sched)

szn_2024_epa_shced_prior = 
  szn_2024_epa %>% 
  left_join(szn2024_sched, by = c("week", "team")) %>% 
  left_join(
    szn_2024_epa %>% 
      rename(team_opp = team) %>% 
      rename_with(~ str_c("opp_", .), ends_with("_epa")),
    by = c("week", "team_opp")
  )

spreads_2024_fin = 
  szn_2024_epa_shced_prior %>% 
  select(week, team, team_opp, contains("prior_")) %>% 
  left_join(spreads_df, by = c("week", "team")) %>% 
  mutate(
    team = as.factor(team),
    team_opp = as.factor(team_opp)
  ) %>% 
  mutate(
    team_matchup = 
      case_when(
        as.integer(team) > as.integer(team_opp) ~ str_c(team_opp, "-", team),
        as.integer(team) < as.integer(team_opp) ~ str_c(team, "-", team_opp)
      )
  ) %>% 
  group_by(team) %>% 
  arrange(week, team, team_matchup) %>% 
  filter(week > 1) %>% 
  group_by(team_matchup) %>% 
  slice(1) %>% 
  ungroup() %>% 
  arrange(week, team_matchup) %>% 
  select(-c(dif, med_diff))
```

## Spread Mods

```{r spread train}
ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

train_df = 
  spreads_2024_fin %>% 
  filter(week < 7) %>% 
  select(result, spread, contains("prior"))

# GLM
set.seed(37564)
mod_glm = train(result ~ .,
                na.action = na.exclude, 
                data = train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm

# ENET
set.seed(37564)
mod_enet = train(result ~ .,
                 na.action = na.exclude, 
                 data = train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = seq(0, 1, by = 0.2), 
                                        lambda = exp(seq(-3, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_enet$bestTune
min(mod_enet$results$RMSE)

# KNN
set.seed(37564)
mod_knn = train(result ~ .,
                na.action = na.exclude, 
                data = train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(2, 40, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn$bestTune
min(mod_knn$results$RMSE)

# MARS
set.seed(37564)
mod_mars = train(result ~ .,
                 na.action = na.exclude, 
                 data = train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars$bestTune
min(mod_mars$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost = train(result ~ .,
                  na.action = na.exclude, 
                  data = train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(5000, 7000, 9000),
                                         interaction.depth = 1,
                                         shrinkage = c(0.0003, 0.0005, 0.0007, 0.0009, 0.0011), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost$bestTune
min(mod_boost$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm = train(result ~ .,
                na.action = na.exclude, 
                data = train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-3, -1, len = 10)),
                                       sigma = exp(seq(-3, 0, len = 10))),
                trControl = ctrl)
ggplot(mod_svm, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm$bestTune
min(mod_svm$results$RMSE)

set.seed(37564)
vip(
  mod_boost, 
  method = "permute", 
  train = train_df,
  target = "result",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

set.seed(37564)
res = resamples(list(GLM = mod_glm, ENET = mod_enet, MARS = mod_mars, KNN = mod_knn, BOOST = mod_boost, SVM = mod_svm))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

test_df = 
  spreads_2024_fin %>% 
  filter(week == 7) %>% 
  select(team_matchup, result, spread, contains("prior"))
  
pred_spread = predict(mod_boost, test_df)

test_df %>% 
  cbind(pred_spread) %>% 
  mutate(pred_diff = pred_spread - spread) %>% 
  relocate(pred_spread, spread, pred_diff, .after = "team_matchup") %>% 
  view
```

# 2025

## Spreads and O/U vs Actual Results:

```{r spreads and ou boxplots}
# Load 2025 data
szn2025 = 
  load_pbp(2025) %>%  
  filter(season_type == "REG")# %>% 
  #filter(week >= 11)

szn_all = 
  szn_all %>% 
  filter(season != 2025) %>% 
  rbind(szn2025)

# ros2024 = 
#   fast_scraper_roster(2024) 

teams_df = 
  szn_all %>% 
  tibble() %>% 
  distinct(home_team) %>% 
  rename(team = home_team) %>% 
  arrange(team) %>% 
  rowid_to_column("team_id")

division_df = 
  teams_df %>% 
  mutate(
    division = 
      case_match(
        team,
        c("BUF", "MIA", "NE", "NYJ") ~ "AFC East",
        c("PIT", "CIN", "BAL", "CLE") ~ "AFC North",
        c("IND", "JAX", "TEN", "HOU") ~ "AFC South",
        c("LAC", "KC", "DEN", "LV") ~ "AFC West",
        c("NYG", "DAL", "WAS", "PHI") ~ "NFC East",
        c("GB", "MIN", "CHI", "DET") ~ "NFC North",
        c("NO", "ATL", "CAR", "TB") ~ "NFC South",
        c("SF", "ARI", "SEA", "LA") ~ "NFC West"
      ),
    conf = str_extract(division, "^[A-Z]FC")
  )

# Spreads boxplots
spreads_df = 
  szn2025 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(week, game_id, posteam, home_team, away_team, spread_line, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(spread = ifelse(home_away == "home", spread_line, -spread_line),
         result = ifelse(home_away == "home", result, -result),
         dif = result - spread) %>% 
  select(week, team, spread, result, dif)

med_spread_df = 
  spreads_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

spreads_df = 
  spreads_df %>% 
  left_join(med_spread_df)

spread_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_spread_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_spreads = 
  spreads_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = spread_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(title = "Game Results vs Spread (Thru Week 9)", 
       x = "Point Difference (Result - Spread)", 
       y = "Team") + 
  theme(plot.title = element_text(hjust = 0.5))

# Totals boxplots
totals_df = 
  szn2025 %>% 
  distinct(game_id, .keep_all = T) %>% 
  select(game_id, week, posteam, home_team, away_team, total_line, total, result) %>% 
  pivot_longer(
    c(home_team, away_team),
    values_to = "team",
    names_to = "home_away",
    names_pattern = "(.*)_team"
  ) %>% 
  mutate(dif = total - total_line) %>% 
  select(team, week, dif, total_line, total)

med_tot_df = 
  totals_df %>% 
  group_by(team) %>% 
  summarize(med_diff = median(dif)) %>% 
  arrange(med_diff)

totals_df = 
  totals_df %>% 
  left_join(med_tot_df)

tot_cols = 
  teams_colors_logos %>% 
  mutate(team = team_abbr) %>% 
  left_join(med_tot_df) %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  arrange(med_diff)

plot_totals = 
  totals_df %>% 
  mutate(team = fct_reorder(as.factor(team), med_diff)) %>% 
  ggplot(aes(x = dif, y = team)) +
  geom_boxplot(fill = tot_cols$team_color, alpha = 0.75) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
  labs(
    title = "Game Totals vs O/U Line (Thru Week 9)",
    x = "Point Difference (Total - Line)", 
    y = "Team") +
  theme(plot.title = element_text(hjust = 0.5))

plot_spreads + plot_totals

view(spreads_df)

spreads_df %>% 
  # filter(between(week, 1, 7)) %>% 
  ggplot(aes(x = week, y = dif, color = team)) + 
  # geom_line(linewidth = 1.2) + 
  geom_point(size = 3) + 
  geom_smooth(aes(group = team), se = F, method = "loess") + 
  geom_abline(slope = 0, intercept = 0, linetype = "dotted") + 
  geom_abline(slope = 0, intercept = c(-7, 7), linetype = "dashed") + 
  scale_color_manual(values = teams_colors_logos$team_color) + 
  scale_x_continuous(breaks = seq(1, 18, by = 1)) +
  coord_cartesian(ylim = c(-21, 21)) +
  facet_wrap(~ team, nrow = 4) +
  labs(
    title = "Results vs Spreads",
    x = "Week",
    y = "Point Difference (Result - Spread)"
  ) +
  theme(legend.position = "none")

totals_df %>% 
  # filter(between(week, 1, 7)) %>% 
  ggplot(aes(x = week, y = dif, color = team)) + 
  # geom_line(linewidth = 1.2) + 
  geom_point(size = 3) + 
  geom_smooth(aes(group = team), se = F, method = "loess") + 
  geom_abline(slope = 0, intercept = 0, linetype = "dotted") + 
  geom_abline(slope = 0, intercept = c(-7, 7), linetype = "dashed") + 
  scale_color_manual(values = teams_colors_logos$team_color) + 
  scale_x_continuous(breaks = seq(1, 18, by = 1)) +
  coord_cartesian(ylim = c(-21, 21)) +
  facet_wrap(~ team, nrow = 4) +
  labs(
    title = "Totals vs Lines",
    x = "Week",
    y = "Point Difference (Total - O/U Line)"
  ) + 
  theme(legend.position = "none")

szn_2025_epa = 
  szn2025 %>% 
  # filter(week == 1) %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
  select(week, posteam, pass, epa) %>% 
  group_by(week, posteam, pass) %>% 
  summarize(epa = mean(epa)) %>% 
  pivot_wider(names_from = pass, values_from = epa) %>% 
  rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>% 
  ungroup() %>% 
  arrange(team, week) %>% 
  group_by(team) %>% 
  mutate(
    across(starts_with("off_") & ends_with("_epa"), ~ lag(.), .names = "prior_{.col}")
  ) %>%
  ungroup() %>% 
  left_join(
    szn2025 %>% 
      filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
      select(week, defteam, pass, epa) %>% 
      group_by(week, defteam, pass) %>% 
      summarize(epa = mean(epa)) %>% 
      pivot_wider(names_from = pass, values_from = epa) %>% 
      rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>% 
      ungroup() %>% 
      arrange(team, week) %>% 
      group_by(team) %>% 
      mutate(
        across(starts_with("def_") & ends_with("_epa"), ~ lag(.), .names = "prior_{.col}")
      ) %>% 
      ungroup(),
    by = c("week", "team")
  )

szn2025_sched = 
  read_csv("./schedule2025.csv") %>% 
  pivot_longer(
    2:19,
    values_to = "team",
    names_to = "week"
  ) %>% 
  mutate(
    TEAM = str_remove(TEAM, "@"), 
   team = str_remove(team, "@"),
   TEAM = str_replace(TEAM, "LAR", "LA"), 
   team = str_replace(team, "LAR", "LA"),
   TEAM = str_replace(TEAM, "WSH", "WAS"), 
   team = str_replace(team, "WSH", "WAS")
  ) %>% 
  rename(
    team_opp = team,
    team = TEAM
  ) %>% 
  mutate(week = as.integer(week))

view(szn2025_sched)

szn_2025_epa_shced_prior = 
  szn_2025_epa %>% 
  left_join(szn2025_sched, by = c("week", "team")) %>% 
  left_join(
    szn_2025_epa %>% 
      rename(team_opp = team) %>% 
      rename_with(~ str_c("opp_", .), ends_with("_epa")),
    by = c("week", "team_opp")
  )

view(szn_2025_epa_shced_prior)

spreads_2025_fin = 
  szn_2025_epa_shced_prior %>% 
  select(week, team, team_opp, contains("prior_")) %>% 
  left_join(spreads_df, by = c("week", "team")) %>% 
  mutate(
    team = as.factor(team),
    team_opp = as.factor(team_opp)
  ) %>% 
  mutate(
    team_matchup = 
      case_when(
        as.integer(team) > as.integer(team_opp) ~ str_c(team_opp, "-", team),
        as.integer(team) < as.integer(team_opp) ~ str_c(team, "-", team_opp)
      )
  ) %>% 
  group_by(team) %>% 
  arrange(week, team, team_matchup) %>% 
  # filter(week > 1) %>% 
  group_by(team_matchup) %>% 
  slice(1) %>% 
  ungroup() %>% 
  arrange(week, team_matchup) %>% 
  select(-c(dif, med_diff))

view(spreads_2025_fin)

szn_all %>% 
  filter(season > 2008) %>% 
  distinct(season, week, game_id, total_line) %>% 
  ggplot(aes(x = total_line)) + 
  geom_density()
  geom_histogram()
  group_by(season) %>% 
  summarise(
    avg_line_szn = mean(total_line)
  ) %>% 
  ggplot(aes(x = season, y = avg_line_szn)) + 
  geom_point() + 
  geom_line()
  
# rolling_epa_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
#   select(season, week, posteam, pass, epa) %>%
#   group_by(season, week, posteam, pass) %>%
#   summarize(epa = mean(epa)) %>%
#   pivot_wider(names_from = pass, values_from = epa) %>%
#   rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
#   ungroup() %>%
#   left_join(
#     szn_all %>%
#       filter(season > 2008) %>%
#       filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
#       select(season, week, defteam, pass, epa) %>%
#       group_by(season, week, defteam, pass) %>%
#       summarize(epa = mean(epa)) %>%
#       pivot_wider(names_from = pass, values_from = epa) %>%
#       rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
#       ungroup(),
#     by = c("season", "week", "team")
#   ) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(n_game = row_number()) %>%
#   mutate(
#     # tst = cumsum(off_pass_epa),
#     # avg_cum_sum = tst / n_game,
#     across(ends_with("_epa"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}"),
#   ) %>%
#   ungroup()

# rolling_pace_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   group_by(season, week, game_id, posteam) %>%
#   summarise(n_plays = n()) %>%
#   drop_na() %>%
#   rename(team = posteam) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(n_game = row_number()) %>%
#   mutate(
#     rolling_pace = cumsum(n_plays) / n_game,
#     across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}"),
#   ) %>%
#   ungroup()

# rolling_rz_eff_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   group_by(season, week, game_id, posteam) %>%
#   mutate(
#     redzone =
#       case_when(
#         yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
#         yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
#         yardline_100 <= 20 ~ 1,
#         yardline_100 > 20 ~ 0,
#         .default = NA
#       )
#   ) %>%
#   select(game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
#   ungroup() %>%
#   group_by(season, week, game_id, posteam, drive) %>%
#   mutate(
#     n_drive = row_number(),
#     n_drive_rz = ifelse(redzone == 1, n_drive, NA),
#     redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
#   ) %>%
#   ungroup() %>%
#   group_by(season, week, game_id, posteam) %>%
#   summarise(
#     redzone_trips = sum(redzone_start == 1, na.rm = T),
#     redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
#   ) %>%
#   drop_na() %>%
#   ungroup() %>%
#   rename(team = posteam) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(
#     n_game = row_number()
#   ) %>%
#   mutate(
#     rolling_rz_n = cumsum(redzone_trips) / n_game,
#     rolling_rz_td = cumsum(redzone_tds) / n_game,
#     rolling_rz_eff =
#       case_when(
#         rolling_rz_n == 0 ~ 0,
#         .default = rolling_rz_td / rolling_rz_n
#       ),
#     across(starts_with("rolling_") & ends_with("_eff"), ~ lag(.), .names = "prior_{col}")
#   ) %>%
#   ungroup()

# view(rolling_rz_eff_df)

# rolling_success_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
#   group_by(season, week, game_id, posteam) %>%
#   mutate(
#     success =
#       case_when(
#         down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
#         down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
#         down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
#         .default = 0
#       )
#   ) %>%
#   summarise(
#     sum_success_off = sum(success, na.rm = T),
#     n_success_off = n(),
#     .groups = "drop"
#   ) %>%
#   drop_na() %>%
#   ungroup() %>%
#   rename(team = posteam) %>%
#   left_join(
#     szn_all %>%
#       filter(season > 2008) %>%
#       filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
#       group_by(season, week, game_id, defteam) %>%
#       mutate(
#         success =
#           case_when(
#             down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
#             down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
#             down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
#             .default = 0
#           )
#       ) %>%
#       summarise(
#         sum_success_def = sum(success, na.rm = T),
#         n_success_def = n(),
#         .groups = "drop"
#       ) %>%
#       drop_na() %>%
#       ungroup() %>%
#       rename(team = defteam),
#     by = c("season", "week", "game_id", "team")
#   ) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(
#     n_game = row_number()
#   ) %>%
#   mutate(
#     across(starts_with("sum_success_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     across(starts_with("n_success_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     # rolling_success = cumsum(sum_success) / n_game,
#     # rolling_success_n = cumsum(n_success) / n_game,
#     rolling_success_off_rate = rolling_sum_success_off / rolling_n_success_off,
#     rolling_success_def_rate = rolling_sum_success_def / rolling_n_success_def,
#     # rolling_success_def_rate = rolling_success / rolling_success_n,
#     across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
#   ) %>%
#   ungroup()

# view(rolling_success_df)

# rolling_exp_plays_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   filter(!is.na(posteam)) %>%
#   group_by(season, week, game_id, posteam) %>%
#   mutate(
#     explosive = ifelse(yards_gained >= 20, 1, 0)
#   ) %>%
#   summarise(
#     n_exp_off = sum(explosive, na.rm = T),
#     n_tot_off = n(),
#     .groups = "drop"
#   ) %>%
#   drop_na() %>%
#   ungroup() %>%
#   rename(team = posteam) %>%
#   left_join(
#     szn_all %>%
#       filter(season > 2008) %>%
#       filter(!is.na(defteam)) %>%
#       group_by(season, week, game_id, defteam) %>%
#       mutate(
#         explosive = ifelse(yards_gained >= 20, 1, 0)
#       ) %>%
#       summarise(
#         n_exp_def = sum(explosive, na.rm = T),
#         n_tot_def = n(),
#         .groups = "drop"
#       ) %>%
#       drop_na() %>%
#       ungroup() %>%
#       rename(team = defteam),
#     by = c("season", "week", "game_id", "team")
#   ) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(
#     n_game = row_number()
#   ) %>%
#   mutate(
#     across(starts_with("n_exp"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     across(starts_with("n_tot"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     # rolling_success = cumsum(sum_success) / n_game,
#     # rolling_success_n = cumsum(n_success) / n_game,
#     rolling_exp_off_rate = rolling_n_exp_off / rolling_n_tot_off,
#     rolling_exp_def_rate = rolling_n_exp_def / rolling_n_tot_def,
#     # rolling_success_def_rate = rolling_success / rolling_success_n,
#     across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
#   ) %>%
#   ungroup()

# view(rolling_exp_plays_df)

# rolling_to_rate_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   filter(!is.na(posteam)) %>%
#   group_by(season, week, game_id, posteam) %>%
#   mutate(
#     turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
#   ) %>%
#   summarise(
#     n_to_off = sum(turnover, na.rm = T),
#     n_tot_off = n(),
#     .groups = "drop"
#   ) %>%
#   drop_na() %>%
#   ungroup() %>%
#   rename(team = posteam) %>%
#   left_join(
#     szn_all %>%
#       filter(season > 2008) %>%
#       filter(!is.na(defteam)) %>%
#       group_by(season, week, game_id, defteam) %>%
#       mutate(
#         turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
#       ) %>%
#       summarise(
#         n_to_def = sum(turnover, na.rm = T),
#         n_tot_def = n(),
#         .groups = "drop"
#       ) %>%
#       drop_na() %>%
#       ungroup() %>%
#       rename(team = defteam),
#     by = c("season", "week", "game_id", "team")
#   ) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(
#     n_game = row_number()
#   ) %>%
#   mutate(
#     across(starts_with("n_to_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     across(starts_with("n_tot_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     # rolling_success = cumsum(sum_success) / n_game,
#     # rolling_success_n = cumsum(n_success) / n_game,
#     rolling_to_off_rate = rolling_n_to_off / rolling_n_tot_off,
#     rolling_to_def_rate = rolling_n_to_def / rolling_n_tot_def,
#     # rolling_success_def_rate = rolling_success / rolling_success_n,
#     across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
#   ) %>%
#   ungroup()
  
# view(rolling_to_rate_df)

# rolling_pen_yards_df =
#   szn_all %>%
#   filter(season > 2008) %>%
#   filter(!is.na(posteam)) %>%
#   group_by(season, week, game_id, posteam) %>%
#   summarise(
#     n_pen_off = sum(penalty_yards, na.rm = T),
#     n_tot_off = n(),
#     .groups = "drop"
#   ) %>%
#   drop_na() %>%
#   ungroup() %>%
#   rename(team = posteam) %>%
#   left_join(
#     szn_all %>%
#       filter(season > 2008) %>%
#       filter(!is.na(defteam)) %>%
#       group_by(season, week, game_id, defteam) %>%
#       summarise(
#         n_pen_def = sum(penalty_yards, na.rm = T),
#         n_tot_def = n(),
#         .groups = "drop"
#       ) %>%
#       drop_na() %>%
#       ungroup() %>%
#       rename(team = defteam),
#     by = c("season", "week", "game_id", "team")
#   ) %>%
#   group_by(season, team) %>%
#   arrange(season, team, week) %>%
#   mutate(
#     n_game = row_number()
#   ) %>%
#   mutate(
#     across(starts_with("n_pen_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     across(starts_with("n_tot_"), ~ cumsum(.) / n_game, .names = "rolling_{col}"),
#     rolling_pen_yards_off = rolling_n_pen_off / rolling_n_tot_off,
#     rolling_pen_yards_def = rolling_n_pen_def / rolling_n_tot_def,
#     across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
#   ) %>%
#   ungroup()
  
rolling_epa_df =
  szn_all %>%
  filter(season > 2008) %>%
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
  select(season, week, posteam, pass, epa) %>%
  group_by(season, week, posteam, pass) %>%
  summarize(epa = mean(epa)) %>%
  pivot_wider(names_from = pass, values_from = epa) %>%
  rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
  ungroup() %>%
  left_join(
    szn_all %>%
      filter(season > 2008) %>%
      filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
      select(season, week, defteam, pass, epa) %>%
      group_by(season, week, defteam, pass) %>%
      summarize(epa = mean(epa)) %>%
      pivot_wider(names_from = pass, values_from = epa) %>%
      rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
      ungroup(),
    by = c("season", "week", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(n_game = row_number()) %>%
  mutate(
    across(ends_with("_epa"), ~ cumsum(.), .names = "sum_{col}"),
    across(ends_with("_epa"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    across(starts_with("sum_recent_"), ~ . / 5, .names = "rolling_{col}_recent"),
    sum_prev_off_rush_epa = sum_off_rush_epa - sum_recent_off_rush_epa,
    sum_prev_off_pass_epa = sum_off_pass_epa - sum_recent_off_pass_epa,
    sum_prev_def_rush_epa = sum_def_rush_epa - sum_recent_def_pass_epa,
    sum_prev_def_pass_epa = sum_def_pass_epa - sum_recent_def_pass_epa,
    across(starts_with("sum_prev_"), ~ . / (n_game - 5), .names = "rolling_{col}_prev"),
    rolling_off_rush_epa =
      case_when(
        n_game <= 5 ~ sum_off_rush_epa / n_game,
        .default = 0.65 * rolling_sum_recent_off_rush_epa_recent + 0.35 * rolling_sum_prev_off_rush_epa_prev
      ),
    rolling_off_pass_epa =
      case_when(
        n_game <= 5 ~ sum_off_pass_epa / n_game,
        .default = 0.65 * rolling_sum_recent_off_pass_epa_recent + 0.35 * rolling_sum_prev_off_pass_epa_prev
      ),
    rolling_def_rush_epa =
      case_when(
        n_game <= 5 ~ sum_def_rush_epa / n_game,
        .default = 0.65 * rolling_sum_recent_def_rush_epa_recent + 0.35 * rolling_sum_prev_def_rush_epa_prev
      ),
    rolling_def_pass_epa =
      case_when(
        n_game <= 5 ~ sum_def_pass_epa / n_game,
        .default = 0.65 * rolling_sum_recent_def_pass_epa_recent + 0.35 * rolling_sum_prev_def_pass_epa_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

rolling_pace_df =
  szn_all %>%
  filter(season > 2008) %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(n_plays = n()) %>%
  drop_na() %>%
  rename(team = posteam) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number(),
    sum_plays = cumsum(n_plays),
    sum_recent = n_plays + lag(n_plays) + lag(lag(n_plays)) + lag(lag(lag(n_plays))) + lag(lag(lag(lag(n_plays)))),
    rolling_recent = sum_recent / 5,
    sum_prev = sum_plays - sum_recent,
    rolling_prev = sum_prev / (n_game - 5),
    rolling_pace =
      case_when(
        n_game <= 5 ~ sum_plays / n_game,
        .default = 0.65 * rolling_recent + 0.35 * rolling_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")#,
    # rolling_pace = cumsum(n_plays) / n_game
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

rolling_rz_eff_df =
  szn_all %>%
  filter(season > 2008) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    redzone =
      case_when(
        yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
        yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
        yardline_100 <= 20 ~ 1,
        yardline_100 > 20 ~ 0,
        .default = NA
      )
  ) %>%
  select(season, week, game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
  ungroup() %>%
  group_by(season, week, game_id, posteam, drive) %>%
  mutate(
    n_drive = row_number(),
    n_drive_rz = ifelse(redzone == 1, n_drive, NA),
    redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
  ) %>%
  ungroup() %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(
    redzone_trips = sum(redzone_start == 1, na.rm = T),
    redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number(),
    across(starts_with("redzone_"), ~ cumsum(.), .names = "sum_{col}"),
    across(starts_with("redzone_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent = (sum_recent_redzone_tds / sum_recent_redzone_trips),
    sum_prev_redzone_trips = sum_redzone_trips - sum_recent_redzone_trips,
    sum_prev_redzone_tds = sum_redzone_tds - sum_recent_redzone_tds,
    rolling_prev = (sum_prev_redzone_tds / sum_prev_redzone_trips),
    rolling_rz_eff =
      case_when(
        n_game <= 5 ~ (sum_redzone_tds / sum_redzone_trips),
        .default = 0.65 * rolling_recent + 0.35 * rolling_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

rolling_success_df =
  szn_all %>%
  filter(season > 2008) %>%
  filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    success =
      case_when(
        down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
        down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
        down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
        .default = 0
      )
  ) %>%
  summarise(
    sum_success_off = sum(success, na.rm = T),
    n_success_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all %>%
      filter(season > 2008) %>%
      filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        success =
          case_when(
            down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
            down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
            down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
            .default = 0
          )
      ) %>%
      summarise(
        sum_success_def = sum(success, na.rm = T),
        n_success_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(contains("_success_"), ~ cumsum(.), .names = "sum_{col}"),
    across(starts_with("_success_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_sum_success_off / sum_n_success_off),
    rolling_recent_def = (sum_sum_success_def / sum_n_success_def),
    sum_prev_sum_success_off = sum_success_off - sum_sum_success_off,
    sum_prev_n_success_off = n_success_off - sum_n_success_off,
    sum_prev_sum_success_def = sum_success_def - sum_sum_success_def,
    sum_prev_n_success_def = n_success_def - sum_n_success_def,
    rolling_prev_off = (sum_prev_sum_success_off / sum_prev_n_success_off),
    rolling_prev_def = (sum_prev_sum_success_def / sum_prev_n_success_def),
    rolling_success_off_rate =
      case_when(
        n_game <= 5 ~ (sum_sum_success_off / sum_n_success_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_success_def_rate =
      case_when(
        n_game <= 5 ~ (sum_sum_success_def / sum_n_success_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

rolling_exp_plays_df =
  szn_all %>%
  filter(season > 2008) %>%
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    explosive = ifelse(yards_gained >= 20, 1, 0)
  ) %>%
  summarise(
    n_exp_off = sum(explosive, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all %>%
      filter(season > 2008) %>%
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        explosive = ifelse(yards_gained >= 20, 1, 0)
      ) %>%
      summarise(
        n_exp_def = sum(explosive, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(c(contains("_exp_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_exp_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_exp_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_exp_def / sum_recent_n_tot_def),
    sum_prev_n_exp_off = sum_n_exp_off - sum_recent_n_exp_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_exp_def = sum_n_exp_def - sum_recent_n_exp_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_exp_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_exp_def / sum_prev_n_tot_def),
    rolling_exp_off_rate =
      case_when(
        n_game <= 5 ~ (sum_n_exp_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_exp_def_rate =
      case_when(
        n_game <= 5 ~ (sum_n_exp_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  # left_join(df_rolling_exp_plays %>% select(team, game_id, rolling_exp_off_rate, rolling_exp_def_rate), by = c("team", "game_id")) %>%
  ungroup()

rolling_to_rate_df =
  szn_all %>%
  filter(season > 2008) %>%
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
  ) %>%
  summarise(
    n_to_off = sum(turnover, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all %>%
      filter(season > 2008) %>%
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
      ) %>%
      summarise(
        n_to_def = sum(turnover, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(c(contains("_to_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_to_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_to_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_to_def / sum_recent_n_tot_def),
    sum_prev_n_to_off = sum_n_to_off - sum_recent_n_to_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_to_def = sum_n_to_def - sum_recent_n_to_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_to_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_to_def / sum_prev_n_tot_def),
    rolling_to_off_rate =
      case_when(
        n_game <= 5 ~ (sum_n_to_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_to_def_rate =
      case_when(
        n_game <= 5 ~ (sum_n_to_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  # left_join(df_rolling_to_rate %>% select(team, game_id, rolling_to_off_rate, rolling_to_def_rate), by = c("team", "game_id")) %>%
  ungroup()
  
rolling_pen_yards_df = 
  szn_all %>% 
  filter(season > 2008) %>%
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(
    n_pen_off = sum(penalty_yards, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>% 
  drop_na() %>% 
  ungroup() %>% 
  rename(team = posteam) %>% 
  left_join(
    szn_all %>% 
      filter(season > 2008) %>% 
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      summarise(
        n_pen_def = sum(penalty_yards, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>% 
      drop_na() %>% 
      ungroup() %>% 
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>% 
  group_by(season, team) %>% 
  arrange(season, team, week) %>% 
  mutate(
    n_game = row_number()
  ) %>% 
  mutate(
    across(c(contains("_pen_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_pen_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_pen_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_pen_def / sum_recent_n_tot_def),
    sum_prev_n_pen_off = sum_n_pen_off - sum_recent_n_pen_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_pen_def = sum_n_pen_def - sum_recent_n_pen_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_pen_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_pen_def / sum_prev_n_tot_def),
    rolling_pen_yards_off =
      case_when(
        n_game <= 5 ~ (sum_n_pen_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_pen_yards_def =
      case_when(
        n_game <= 5 ~ (sum_n_pen_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
  ) %>% 
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>% 
  # left_join(df_rolling_pen_yards %>% select(team, game_id, rolling_pen_yards_off, rolling_pen_yards_def), by = c("team", "game_id")) %>% 
  ungroup()

# view(rolling_pen_yards_df)

qb_starters = 
  szn_all %>% 
  filter(qtr == 1) %>%
  filter(!is.na(passer_id)) %>% 
  group_by(season, week, game_id, posteam, passer_id) %>%
  summarise(dropbacks = n(), .groups = "drop_last") %>%
  slice_max(order_by = dropbacks, n = 1, with_ties = F) %>%
  ungroup() %>%
  rename(team = posteam, qb_id = passer_id)

# view(qb_starters)

qb_cont_df = 
  szn_all %>% 
  filter(season > 2008) %>% 
  distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(
    qb_starters %>% 
      select(game_id, team, qb_id), 
    by = c("game_id", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(week, .by_group = TRUE) %>%
  mutate(
    prev_qb = lag(qb_id),
    qb_cont = ifelse(!is.na(prev_qb) & qb_id == prev_qb, 1, 0)
  ) %>%
  ungroup() %>% 
  select(season, week, team, game_id, qb_cont)

# view(qb_cont_df)

rest_days_df = 
  szn_all %>% 
  filter(season > 2008) %>% 
  mutate(date_game = as.Date(game_date)) %>% 
  distinct(season, week, game_id, home_team, away_team, date_game) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  group_by(season, team) %>%
  arrange(date_game, .by_group = TRUE) %>% 
  mutate(
    prev_date_game = lag(date_game),
    rest_days = as.integer(date_game - prev_date_game)
  ) %>%
  ungroup() %>% 
  select(season, week, team, game_id, rest_days)

# view(rest_days_df)

# total_spread_epa_pace_rz_df = 
#   szn_all %>% 
#   filter(season > 2008 & week > 1) %>% 
#   distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
#   left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
#   left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
#   mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
#   pivot_longer(
#     ends_with("_team"),
#     names_to = "home_away",
#     values_to = "team"
#   ) %>% 
#   mutate(home_away = str_remove(home_away, "_team$")) %>% 
#   left_join(rolling_epa_df, by = c("season", "week", "team")) %>% 
#   left_join(rolling_pace_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
#   left_join(rolling_rz_eff_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
#   select(season, week, game_id, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_")) %>%
#   pivot_wider(
#     id_cols = c(season, week, game_id, division_game, total_line, total, spread_line, result),
#     names_from = home_away,
#     values_from = starts_with("prior_")
#   )

stadium_coords_df = 
  tibble::tribble(
    ~team,    ~stadium,                        ~lat,      ~lon,
    # --- Current Teams ---
    "ARI",    "State Farm Stadium",            33.5273,  -112.2639,
    "ATL",    "Mercedes-Benz Stadium",         33.7558,   -84.4018,
    "BAL",    "M&T Bank Stadium",              39.2781,   -76.6228,
    "BUF",    "Highmark Stadium",              42.7735,   -78.7869,
    "CAR",    "Bank of America Stadium",       35.2258,   -80.8528,
    "CHI",    "Soldier Field",                 41.8625,   -87.6167,
    "CIN",    "Paycor Stadium",                39.0954,   -84.5160,
    "CLE",    "Cleveland Browns Stadium",      41.5061,   -81.6994,
    "DAL",    "AT&T Stadium",                  32.7473,   -97.0945,
    "DEN",    "Empower Field",                 39.7439,  -105.0200,
    "DET",    "Ford Field",                    42.3400,   -83.0456,
    "GB",     "Lambeau Field",                 44.5013,   -88.0622,
    "HOU",    "NRG Stadium",                   29.6849,   -95.4108,
    "IND",    "Lucas Oil Stadium",             39.7601,   -86.1638,
    "JAX",    "EverBank Stadium",              30.3239,   -81.6373,
    "KC",     "Arrowhead Stadium",             39.0489,   -94.4839,
    "LA",     "SoFi Stadium",                  33.9536,  -118.3396,
    "LAC",    "SoFi Stadium",                  33.9536,  -118.3396,
    "LV",     "Allegiant Stadium",             36.0908,  -115.1839,
    "MIA",    "Hard Rock Stadium",             25.9580,   -80.2389,
    "MIN",    "U.S. Bank Stadium",             44.9738,   -93.2581,
    "NE",     "Gillette Stadium",              42.0909,   -71.2643,
    "NO",     "Caesars Superdome",             29.9508,   -90.0811,
    "NYG",    "MetLife Stadium",               40.8135,   -74.0745,
    "NYJ",    "MetLife Stadium",               40.8135,   -74.0745,
    "PHI",    "Lincoln Financial Field",       39.9008,   -75.1675,
    "PIT",    "Acrisure Stadium",              40.4468,   -80.0158,
    "SEA",    "Lumen Field",                   47.5951,  -122.3323,
    "SF",     "Levi's Stadium",                37.4030,  -121.9700,
    "TB",     "Raymond James Stadium",         27.9758,   -82.5033,
    "TEN",    "Nissan Stadium",                36.1665,   -86.7713,
    "WAS",    "FedExField",                    38.9078,   -76.8644,
    
    # --- Old Stadiums / Relocated Teams ---
    "SD",     "Qualcomm Stadium",              32.7831,  -117.1195,  # San Diego Chargers (19672016)
    "STL",    "Edward Jones Dome",             38.6329,   -90.1885,  # St. Louis Rams (19952015)
    "OAK",    "Oakland Coliseum",              37.7516,  -122.2005,  # Oakland Raiders (19662019)
  
    # --- International / Neutral ---
    "INTL_LON",   "Wembley Stadium",      51.5560,   -0.2796,
    "INTL_LON",   "Tottenham Stadium",     51.6043,   -0.0664,
    "INTL_MEX",   "Azteca Stadium",  19.3029,  -99.1505,
    "INTL_GER",   "Allianz Arena",        48.2188,   11.6247,
    "INTL_GER",   "Deutsche Bank Park",50.0686,    8.6456
) %>%
  add_row(
    team = "INTL_BRA", 
    stadium = "Arena Corinthians", 
    lat = -23.5450, 
    lon = -46.4734
  ) %>%
  add_row(
    team    = "INTL_TWICKENHAM",
    stadium = "Twickenham Stadium",
    lat     = 51.4560,
    lon     = -0.3415
  ) %>%
  add_row(
    team    = "INTL_TOR",
    stadium = "Rogers Centre",
    lat     = 43.6414,
    lon     = -79.3894
  )

# view(stadium_coords_df)

schedules_szn_all = 
  fast_scraper_schedules() %>% 
  filter(season > 2008)

# view(schedules_szn_all)

games_coords_df = 
  schedules_szn_all %>% 
  rename(stadium_old = stadium) %>% 
  filter(location != "Neutral") %>% 
  left_join(
    stadium_coords_df %>% 
      rename(home_team = team),
    by = "home_team"
  ) %>% 
  rbind(
    schedules_szn_all %>% 
      filter(location == "Neutral") %>% 
      left_join(
        stadium_coords_df %>% 
          select(-team),
        by = "stadium"
      ) %>% 
      mutate(
        lat = 
          case_when(
            is.na(lat) & game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lat), 
            game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lat), 
            .default = lat
          ),
        lon = 
          case_when(
            is.na(lon) & game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lon), 
            game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lon), 
            .default = lon
          ),
        stadium_old = NA
      )
  ) %>% 
  drop_na(lat, lon) %>% 
  rename(
    game_lat = lat,
    game_lon = lon
  ) %>% 
  select(game_id, home_team, location, stadium, game_lat, game_lon) %>% 
  distinct()

team_coords_df = 
  games_coords_df %>%
  distinct(home_team, .keep_all = TRUE) %>%
  select(-game_id) %>% 
  rename(
    team = home_team,
    home_lat = game_lat, 
    home_lon = game_lon
  )

# Function to compute haversine distance (km)
haversine <- function(lat1, lon1, lat2, lon2) {
  R <- 6371  # km
  dlat <- (lat2 - lat1) * pi/180
  dlon <- (lon2 - lon1) * pi/180
  a <- sin(dlat/2)^2 + cos(lat1*pi/180) * cos(lat2*pi/180) * sin(dlon/2)^2
  c <- 2 * atan2(sqrt(a), sqrt(1-a))
  R * c
}

team_travel_df =
  szn_all %>% 
  distinct(season, week, game_id, home_team, away_team) %>% 
  mutate(
    home_team = 
      case_when(
        season < 2017 & home_team == "LA" ~ "STL",
        season < 2017 & home_team == "LAC" ~ "SD",
        season < 2020 & home_team == "LV" ~ "OAK",
        .default = home_team
      ),
    away_team = 
      case_when(
        season < 2017 & away_team == "LA" ~ "STL",
        season < 2017 & away_team == "LAC" ~ "SD",
        season < 2020 & away_team == "LV" ~ "OAK",
        .default = away_team
      )
  ) %>% 
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(games_coords_df %>% select(game_id, location, stadium, game_lat, game_lon), by = "game_id") %>% 
  left_join(team_coords_df %>% select(-location), by = "team") %>% 
  mutate(
    travel_km = ifelse(home_away == "home" & location != "Neutral", 0, haversine(home_lat, home_lon, game_lat, game_lon)),
    team = 
      case_when(
        season < 2017 & team == "LA" ~ "STL",
        season < 2017 & team == "SD" ~ "LAC",
        season < 2020 & team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  select(season, week, team, game_id, travel_km)

# view(team_travel_df)

team_total_spread_rolling_df =
  szn_all %>% 
  filter(season > 2008) %>% 
  distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
  left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
  left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
  mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  mutate(home_away = str_remove(home_away, "_team$")) %>% 
  left_join(rolling_epa_df, by = c("season", "week", "team")) %>% 
  left_join(rolling_pace_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rolling_rz_eff_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rolling_success_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rolling_exp_plays_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rolling_to_rate_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rolling_pen_yards_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(qb_cont_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(rest_days_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(team_travel_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  select(season, week, game_id, team, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_"), qb_cont, rest_days, travel_km) %>%
  mutate(
    travel_km = 
      case_when(
        travel_km == 0 ~ 0,
        .default = log(travel_km)
      ),
    total_team = 
      case_when(
        home_away == "home" ~ home_score,
        home_away == "away" ~ away_score,
        .default = NA
      )
  ) %>% 
  ungroup()

# view(team_total_spread_rolling_df)

field_game_df = 
  szn_all %>% 
  distinct(game_id, home_team, away_team, roof, surface, wind, temp, start_time, total) %>% 
  # pull(roof) %>% table(useNA = "ifany")
  mutate(
    time_start = 
      as.integer(str_remove(str_remove(str_extract(start_time, "\\d+:\\d+:\\d+$"), ":\\d+$"), ":")),
    international = ifelse(surface == "", 1, 0),
    enclosed_field = 
      case_when(
        roof %in% c("closed", "dome") ~ 1,
        roof %in% c("open", "outdoors") ~ 0,
        .default = NA
      ),
    turf_field = 
      case_when(
        str_detect(surface, "turf") | surface == "" | str_detect(surface, "astro") ~ 1,
        str_detect(surface, "grass") ~ 0, 
        .default = NA
      ),
    wind = 
      case_when(
        is.na(wind) & enclosed_field == 1 ~ 0,
        .default = wind
      ),
    temp = 
      case_when(
        is.na(temp) & enclosed_field == 1 ~ 72,
        .default = temp
      )
  ) %>% 
  # tbl_summary(by = turf_field, include = total) %>% add_p()
  # ggplot(aes(x = as.factor(turf_field), y = total)) + 
  # geom_boxplot()
  select(game_id, home_team, away_team, ends_with("_field"), international, time_start, wind, temp) %>%
  left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
  left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
  mutate(division_game = ifelse(division_home == division_away, 1, 0))

# view(field_game_df)

make_weighted_data_3prior <- function(w) {

  # EPA -----------------------------------------------------------------------
  rolling_epa_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
    select(season, week, posteam, pass, epa) %>%
    group_by(season, week, posteam, pass) %>%
    summarize(epa = mean(epa), .groups = "drop_last") %>%
    pivot_wider(names_from = pass, values_from = epa) %>%
    rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
    ungroup() %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
        select(season, week, defteam, pass, epa) %>%
        group_by(season, week, defteam, pass) %>%
        summarize(epa = mean(epa), .groups = "drop_last") %>%
        pivot_wider(names_from = pass, values_from = epa) %>%
        rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
        ungroup(),
      by = c("season", "week", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(ends_with("_epa"), ~ cumsum(.), .names = "sum_{col}"),
      across(ends_with("_epa"), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      across(starts_with("sum_recent_"), ~ . / 3, .names = "rolling_{col}_recent"),
      sum_prev_off_rush_epa = sum_off_rush_epa - sum_recent_off_rush_epa,
      sum_prev_off_pass_epa = sum_off_pass_epa - sum_recent_off_pass_epa,
      sum_prev_def_rush_epa = sum_def_rush_epa - sum_recent_def_rush_epa,
      sum_prev_def_pass_epa = sum_def_pass_epa - sum_recent_def_pass_epa,
      across(starts_with("sum_prev_"), ~ . / (n_game - 3), .names = "rolling_{col}_prev"),

      # WEIGHTED EPA ---------------------------------------------------------
      rolling_off_rush_epa =
        case_when(
          n_game <= 3 ~ sum_off_rush_epa / n_game,
          .default = w * rolling_sum_recent_off_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_off_rush_epa_prev
        ),
      rolling_off_pass_epa =
        case_when(
          n_game <= 3 ~ sum_off_pass_epa / n_game,
          .default = w * rolling_sum_recent_off_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_off_pass_epa_prev
        ),
      rolling_def_rush_epa =
        case_when(
          n_game <= 3 ~ sum_def_rush_epa / n_game,
          .default = w * rolling_sum_recent_def_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_def_rush_epa_prev
        ),
      rolling_def_pass_epa =
        case_when(
          n_game <= 3 ~ sum_def_pass_epa / n_game,
          .default = w * rolling_sum_recent_def_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_def_pass_epa_prev
        ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # PACE ----------------------------------------------------------------------
  rolling_pace_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(n_plays = n(), .groups = "drop_last") %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      sum_plays = cumsum(n_plays),
      sum_recent = n_plays + lag(n_plays) + lag(lag(n_plays)),
      rolling_recent = sum_recent / 3,
      sum_prev = sum_plays - sum_recent,
      rolling_prev = sum_prev / (n_game - 3),

      # WEIGHTED PACE ---------------------------------------------------------
      rolling_pace =
        case_when(
          n_game <= 3 ~ sum_plays / n_game,
          .default = w * rolling_recent + (1 - w) * rolling_prev
        ),

      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
    # RZ EFF ----------------------------------------------------------------  
  rolling_rz_eff_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      redzone =
        case_when(
          yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
          yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
          yardline_100 <= 20 ~ 1,
          yardline_100 > 20 ~ 0,
          .default = NA
        )
    ) %>%
    select(season, week, game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam, drive) %>%
    mutate(
      n_drive = row_number(),
      n_drive_rz = ifelse(redzone == 1, n_drive, NA),
      redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
    ) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      redzone_trips = sum(redzone_start == 1, na.rm = T),
      redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(starts_with("redzone_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("redzone_"), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      rolling_recent = (sum_recent_redzone_tds / sum_recent_redzone_trips),
      sum_prev_redzone_trips = sum_redzone_trips - sum_recent_redzone_trips,
      sum_prev_redzone_tds = sum_redzone_tds - sum_recent_redzone_tds,
      rolling_prev = (sum_prev_redzone_tds / sum_prev_redzone_trips),
      
      # WEIGHTED RZ ---------------------------------------------------------
      rolling_rz_eff =
          case_when(
              n_game <= 3 ~ (sum_redzone_tds / sum_redzone_trips),
              .default = w * rolling_recent +
                     (1 - w) * rolling_prev
          ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
  # SUCCESS ----------------------------------------------------------------  
  rolling_success_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      success =
        case_when(
          down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
          down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
          down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
          .default = 0
        )
    ) %>%
    summarise(
      sum_success_off = sum(success, na.rm = T),
      n_success_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          success =
            case_when(
              down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
              down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
              down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
              .default = 0
            )
        ) %>%
        summarise(
          sum_success_def = sum(success, na.rm = T),
          n_success_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(contains("_success_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("_success_"), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_sum_success_off / sum_n_success_off),
      rolling_recent_def = (sum_sum_success_def / sum_n_success_def),
      sum_prev_sum_success_off = sum_success_off - sum_sum_success_off,
      sum_prev_n_success_off = n_success_off - sum_n_success_off,
      sum_prev_sum_success_def = sum_success_def - sum_sum_success_def,
      sum_prev_n_success_def = n_success_def - sum_n_success_def,
      rolling_prev_off = (sum_prev_sum_success_off / sum_prev_n_success_off),
      rolling_prev_def = (sum_prev_sum_success_def / sum_prev_n_success_def),
      
      # WEIGHTED SUCCESS ---------------------------------------------------------
      rolling_success_off_rate =
        case_when(
          n_game <= 3 ~ (sum_sum_success_off / sum_n_success_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_success_def_rate =
        case_when(
          n_game <= 3 ~ (sum_sum_success_def / sum_n_success_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # EXP PLAYS ----------------------------------------------------------------  
  rolling_exp_plays_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      explosive = ifelse(yards_gained >= 20, 1, 0)
    ) %>%
    summarise(
      n_exp_off = sum(explosive, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          explosive = ifelse(yards_gained >= 20, 1, 0)
        ) %>%
        summarise(
          n_exp_def = sum(explosive, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_exp_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_exp_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_exp_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_exp_def / sum_recent_n_tot_def),
      sum_prev_n_exp_off = sum_n_exp_off - sum_recent_n_exp_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_exp_def = sum_n_exp_def - sum_recent_n_exp_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_exp_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_exp_def / sum_prev_n_tot_def),
      
      # WEIGHTED EXP PLAYS ---------------------------------------------------------
      rolling_exp_off_rate =
        case_when(
          n_game <= 3 ~ (sum_n_exp_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_exp_def_rate =
        case_when(
          n_game <= 3 ~ (sum_n_exp_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_exp_plays %>% select(team, game_id, rolling_exp_off_rate, rolling_exp_def_rate), by = c("team", "game_id")) %>%
    ungroup()

  # TO RATE ----------------------------------------------------------------  
  rolling_to_rate_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
    ) %>%
    summarise(
      n_to_off = sum(turnover, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
        ) %>%
        summarise(
          n_to_def = sum(turnover, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_to_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_to_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_to_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_to_def / sum_recent_n_tot_def),
      sum_prev_n_to_off = sum_n_to_off - sum_recent_n_to_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_to_def = sum_n_to_def - sum_recent_n_to_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_to_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_to_def / sum_prev_n_tot_def),
      
      
      # WEIGHTED TO RATE ---------------------------------------------------------
      rolling_to_off_rate =
        case_when(
          n_game <= 3 ~ (sum_n_to_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_to_def_rate =
        case_when(
          n_game <= 3 ~ (sum_n_to_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_to_rate %>% select(team, game_id, rolling_to_off_rate, rolling_to_def_rate), by = c("team", "game_id")) %>%
    ungroup()
    
  # PEN YARDS ----------------------------------------------------------------  
  rolling_pen_yards_df = 
    szn_all %>% 
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      n_pen_off = sum(penalty_yards, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>% 
    drop_na() %>% 
    ungroup() %>% 
    rename(team = posteam) %>% 
    left_join(
      szn_all %>% 
        filter(season > 2008) %>% 
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        summarise(
          n_pen_def = sum(penalty_yards, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>% 
        drop_na() %>% 
        ungroup() %>% 
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>% 
    group_by(season, team) %>% 
    arrange(season, team, week) %>% 
    mutate(
      n_game = row_number()
    ) %>% 
    mutate(
      across(c(contains("_pen_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_pen_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_pen_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_pen_def / sum_recent_n_tot_def),
      sum_prev_n_pen_off = sum_n_pen_off - sum_recent_n_pen_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_pen_def = sum_n_pen_def - sum_recent_n_pen_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_pen_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_pen_def / sum_prev_n_tot_def),
      
      # WEIGHTED PEN YARDS ---------------------------------------------------------
      rolling_pen_yards_off =
        case_when(
          n_game <= 3 ~ (sum_n_pen_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_pen_yards_def =
        case_when(
          n_game <= 3 ~ (sum_n_pen_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
    ) %>% 
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>% 
    # left_join(df_rolling_pen_yards %>% select(team, game_id, rolling_pen_yards_off, rolling_pen_yards_def), by = c("team", "game_id")) %>% 
    ungroup()
  
   # Return merged data
  rolling_merged_df = 
    rolling_epa_df %>% 
    left_join(rolling_pace_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_rz_eff_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_success_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_exp_plays_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_to_rate_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_pen_yards_df, by = c("season", "team", "week", "n_game"))
  
  team_total_spread_rolling_df =
    szn_all %>% 
    filter(season > 2008) %>% 
    distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
    left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
    left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
    mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
    pivot_longer(
      ends_with("_team"),
      names_to = "home_away",
      values_to = "team"
    ) %>% 
    mutate(home_away = str_remove(home_away, "_team$")) %>% 
    left_join(rolling_merged_df, by = c("season", "week", "team")) %>% 
    left_join(qb_cont_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(rest_days_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(team_travel_df %>% select(-game_id), by = c("season", "week", "team")) %>%  
    select(season, week, game_id, team, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_"), qb_cont, rest_days, travel_km) %>%
    mutate(
      travel_km = 
        case_when(
          travel_km == 0 ~ 0,
          .default = log(travel_km)
        ),
      total_team = 
        case_when(
          home_away == "home" ~ home_score,
          home_away == "away" ~ away_score,
          .default = NA
        )
    ) %>% 
    ungroup()  

}

weights <- seq(0.1, 0.9, by = 0.05)

rolling_weights_3prior_df <- map(weights, make_weighted_data_3prior)

names(rolling_weights_3prior_df) <- paste0("w_", gsub("\\.", "_", weights))


make_weighted_data_4prior <- function(w) {

  # EPA -----------------------------------------------------------------------
  rolling_epa_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
    select(season, week, posteam, pass, epa) %>%
    group_by(season, week, posteam, pass) %>%
    summarize(epa = mean(epa), .groups = "drop_last") %>%
    pivot_wider(names_from = pass, values_from = epa) %>%
    rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
    ungroup() %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
        select(season, week, defteam, pass, epa) %>%
        group_by(season, week, defteam, pass) %>%
        summarize(epa = mean(epa), .groups = "drop_last") %>%
        pivot_wider(names_from = pass, values_from = epa) %>%
        rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
        ungroup(),
      by = c("season", "week", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(ends_with("_epa"), ~ cumsum(.), .names = "sum_{col}"),
      across(ends_with("_epa"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      across(starts_with("sum_recent_"), ~ . / 4, .names = "rolling_{col}_recent"),
      sum_prev_off_rush_epa = sum_off_rush_epa - sum_recent_off_rush_epa,
      sum_prev_off_pass_epa = sum_off_pass_epa - sum_recent_off_pass_epa,
      sum_prev_def_rush_epa = sum_def_rush_epa - sum_recent_def_rush_epa,
      sum_prev_def_pass_epa = sum_def_pass_epa - sum_recent_def_pass_epa,
      across(starts_with("sum_prev_"), ~ . / (n_game - 4), .names = "rolling_{col}_prev"),

      # WEIGHTED EPA ---------------------------------------------------------
      rolling_off_rush_epa =
        case_when(
          n_game <= 4 ~ sum_off_rush_epa / n_game,
          .default = w * rolling_sum_recent_off_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_off_rush_epa_prev
        ),
      rolling_off_pass_epa =
        case_when(
          n_game <= 4 ~ sum_off_pass_epa / n_game,
          .default = w * rolling_sum_recent_off_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_off_pass_epa_prev
        ),
      rolling_def_rush_epa =
        case_when(
          n_game <= 4 ~ sum_def_rush_epa / n_game,
          .default = w * rolling_sum_recent_def_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_def_rush_epa_prev
        ),
      rolling_def_pass_epa =
        case_when(
          n_game <= 4 ~ sum_def_pass_epa / n_game,
          .default = w * rolling_sum_recent_def_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_def_pass_epa_prev
        ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # PACE ----------------------------------------------------------------------
  rolling_pace_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(n_plays = n(), .groups = "drop_last") %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      sum_plays = cumsum(n_plays),
      sum_recent = n_plays + lag(n_plays) + lag(lag(n_plays)) + lag(lag(lag(n_plays))),
      rolling_recent = sum_recent / 4,
      sum_prev = sum_plays - sum_recent,
      rolling_prev = sum_prev / (n_game - 4),

      # WEIGHTED PACE ---------------------------------------------------------
      rolling_pace =
        case_when(
          n_game <= 4 ~ sum_plays / n_game,
          .default = w * rolling_recent + (1 - w) * rolling_prev
        ),

      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
    # RZ EFF ----------------------------------------------------------------  
  rolling_rz_eff_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      redzone =
        case_when(
          yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
          yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
          yardline_100 <= 20 ~ 1,
          yardline_100 > 20 ~ 0,
          .default = NA
        )
    ) %>%
    select(season, week, game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam, drive) %>%
    mutate(
      n_drive = row_number(),
      n_drive_rz = ifelse(redzone == 1, n_drive, NA),
      redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
    ) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      redzone_trips = sum(redzone_start == 1, na.rm = T),
      redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(starts_with("redzone_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("redzone_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      rolling_recent = (sum_recent_redzone_tds / sum_recent_redzone_trips),
      sum_prev_redzone_trips = sum_redzone_trips - sum_recent_redzone_trips,
      sum_prev_redzone_tds = sum_redzone_tds - sum_recent_redzone_tds,
      rolling_prev = (sum_prev_redzone_tds / sum_prev_redzone_trips),
      
      # WEIGHTED RZ ---------------------------------------------------------
      rolling_rz_eff =
          case_when(
              n_game <= 4 ~ (sum_redzone_tds / sum_redzone_trips),
              .default = w * rolling_recent +
                     (1 - w) * rolling_prev
          ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
  # SUCCESS ----------------------------------------------------------------  
  rolling_success_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      success =
        case_when(
          down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
          down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
          down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
          .default = 0
        )
    ) %>%
    summarise(
      sum_success_off = sum(success, na.rm = T),
      n_success_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          success =
            case_when(
              down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
              down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
              down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
              .default = 0
            )
        ) %>%
        summarise(
          sum_success_def = sum(success, na.rm = T),
          n_success_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(contains("_success_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("_success_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_sum_success_off / sum_n_success_off),
      rolling_recent_def = (sum_sum_success_def / sum_n_success_def),
      sum_prev_sum_success_off = sum_success_off - sum_sum_success_off,
      sum_prev_n_success_off = n_success_off - sum_n_success_off,
      sum_prev_sum_success_def = sum_success_def - sum_sum_success_def,
      sum_prev_n_success_def = n_success_def - sum_n_success_def,
      rolling_prev_off = (sum_prev_sum_success_off / sum_prev_n_success_off),
      rolling_prev_def = (sum_prev_sum_success_def / sum_prev_n_success_def),
      
      # WEIGHTED SUCCESS ---------------------------------------------------------
      rolling_success_off_rate =
        case_when(
          n_game <= 4 ~ (sum_sum_success_off / sum_n_success_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_success_def_rate =
        case_when(
          n_game <= 4 ~ (sum_sum_success_def / sum_n_success_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # EXP PLAYS ----------------------------------------------------------------  
  rolling_exp_plays_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      explosive = ifelse(yards_gained >= 20, 1, 0)
    ) %>%
    summarise(
      n_exp_off = sum(explosive, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          explosive = ifelse(yards_gained >= 20, 1, 0)
        ) %>%
        summarise(
          n_exp_def = sum(explosive, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_exp_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_exp_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_exp_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_exp_def / sum_recent_n_tot_def),
      sum_prev_n_exp_off = sum_n_exp_off - sum_recent_n_exp_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_exp_def = sum_n_exp_def - sum_recent_n_exp_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_exp_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_exp_def / sum_prev_n_tot_def),
      
      # WEIGHTED EXP PLAYS ---------------------------------------------------------
      rolling_exp_off_rate =
        case_when(
          n_game <= 4 ~ (sum_n_exp_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_exp_def_rate =
        case_when(
          n_game <= 4 ~ (sum_n_exp_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_exp_plays %>% select(team, game_id, rolling_exp_off_rate, rolling_exp_def_rate), by = c("team", "game_id")) %>%
    ungroup()

  # TO RATE ----------------------------------------------------------------  
  rolling_to_rate_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
    ) %>%
    summarise(
      n_to_off = sum(turnover, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
        ) %>%
        summarise(
          n_to_def = sum(turnover, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_to_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_to_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_to_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_to_def / sum_recent_n_tot_def),
      sum_prev_n_to_off = sum_n_to_off - sum_recent_n_to_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_to_def = sum_n_to_def - sum_recent_n_to_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_to_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_to_def / sum_prev_n_tot_def),
      
      
      # WEIGHTED TO RATE ---------------------------------------------------------
      rolling_to_off_rate =
        case_when(
          n_game <= 4 ~ (sum_n_to_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_to_def_rate =
        case_when(
          n_game <= 4 ~ (sum_n_to_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_to_rate %>% select(team, game_id, rolling_to_off_rate, rolling_to_def_rate), by = c("team", "game_id")) %>%
    ungroup()
    
  # PEN YARDS ----------------------------------------------------------------  
  rolling_pen_yards_df = 
    szn_all %>% 
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      n_pen_off = sum(penalty_yards, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>% 
    drop_na() %>% 
    ungroup() %>% 
    rename(team = posteam) %>% 
    left_join(
      szn_all %>% 
        filter(season > 2008) %>% 
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        summarise(
          n_pen_def = sum(penalty_yards, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>% 
        drop_na() %>% 
        ungroup() %>% 
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>% 
    group_by(season, team) %>% 
    arrange(season, team, week) %>% 
    mutate(
      n_game = row_number()
    ) %>% 
    mutate(
      across(c(contains("_pen_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_pen_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_pen_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_pen_def / sum_recent_n_tot_def),
      sum_prev_n_pen_off = sum_n_pen_off - sum_recent_n_pen_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_pen_def = sum_n_pen_def - sum_recent_n_pen_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_pen_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_pen_def / sum_prev_n_tot_def),
      
      # WEIGHTED PEN YARDS ---------------------------------------------------------
      rolling_pen_yards_off =
        case_when(
          n_game <= 4 ~ (sum_n_pen_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_pen_yards_def =
        case_when(
          n_game <= 4 ~ (sum_n_pen_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
    ) %>% 
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>% 
    # left_join(df_rolling_pen_yards %>% select(team, game_id, rolling_pen_yards_off, rolling_pen_yards_def), by = c("team", "game_id")) %>% 
    ungroup()
  
   # Return merged data
  rolling_merged_df = 
    rolling_epa_df %>% 
    left_join(rolling_pace_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_rz_eff_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_success_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_exp_plays_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_to_rate_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_pen_yards_df, by = c("season", "team", "week", "n_game"))
  
  team_total_spread_rolling_df =
    szn_all %>% 
    filter(season > 2008) %>% 
    distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
    left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
    left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
    mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
    pivot_longer(
      ends_with("_team"),
      names_to = "home_away",
      values_to = "team"
    ) %>% 
    mutate(home_away = str_remove(home_away, "_team$")) %>% 
    left_join(rolling_merged_df, by = c("season", "week", "team")) %>% 
    left_join(qb_cont_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(rest_days_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(team_travel_df %>% select(-game_id), by = c("season", "week", "team")) %>%  
    select(season, week, game_id, team, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_"), qb_cont, rest_days, travel_km) %>%
    mutate(
      travel_km = 
        case_when(
          travel_km == 0 ~ 0,
          .default = log(travel_km)
        ),
      total_team = 
        case_when(
          home_away == "home" ~ home_score,
          home_away == "away" ~ away_score,
          .default = NA
        )
    ) %>% 
    ungroup()  

}

weights <- seq(0.1, 0.9, by = 0.05)

rolling_weights_4prior_df <- map(weights, make_weighted_data_4prior)

names(rolling_weights_4prior_df) <- paste0("w_", gsub("\\.", "_", weights))

make_weighted_data_5prior <- function(w) {

  # EPA -----------------------------------------------------------------------
  rolling_epa_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
    select(season, week, posteam, pass, epa) %>%
    group_by(season, week, posteam, pass) %>%
    summarize(epa = mean(epa), .groups = "drop_last") %>%
    pivot_wider(names_from = pass, values_from = epa) %>%
    rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
    ungroup() %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
        select(season, week, defteam, pass, epa) %>%
        group_by(season, week, defteam, pass) %>%
        summarize(epa = mean(epa), .groups = "drop_last") %>%
        pivot_wider(names_from = pass, values_from = epa) %>%
        rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
        ungroup(),
      by = c("season", "week", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(ends_with("_epa"), ~ cumsum(.), .names = "sum_{col}"),
      across(ends_with("_epa"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      across(starts_with("sum_recent_"), ~ . / 5, .names = "rolling_{col}_recent"),
      sum_prev_off_rush_epa = sum_off_rush_epa - sum_recent_off_rush_epa,
      sum_prev_off_pass_epa = sum_off_pass_epa - sum_recent_off_pass_epa,
      sum_prev_def_rush_epa = sum_def_rush_epa - sum_recent_def_rush_epa,
      sum_prev_def_pass_epa = sum_def_pass_epa - sum_recent_def_pass_epa,
      across(starts_with("sum_prev_"), ~ . / (n_game - 5), .names = "rolling_{col}_prev"),

      # WEIGHTED EPA ---------------------------------------------------------
      rolling_off_rush_epa =
        case_when(
          n_game <= 5 ~ sum_off_rush_epa / n_game,
          .default = w * rolling_sum_recent_off_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_off_rush_epa_prev
        ),
      rolling_off_pass_epa =
        case_when(
          n_game <= 5 ~ sum_off_pass_epa / n_game,
          .default = w * rolling_sum_recent_off_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_off_pass_epa_prev
        ),
      rolling_def_rush_epa =
        case_when(
          n_game <= 5 ~ sum_def_rush_epa / n_game,
          .default = w * rolling_sum_recent_def_rush_epa_recent +
                     (1 - w) * rolling_sum_prev_def_rush_epa_prev
        ),
      rolling_def_pass_epa =
        case_when(
          n_game <= 5 ~ sum_def_pass_epa / n_game,
          .default = w * rolling_sum_recent_def_pass_epa_recent +
                     (1 - w) * rolling_sum_prev_def_pass_epa_prev
        ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # PACE ----------------------------------------------------------------------
  rolling_pace_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(n_plays = n(), .groups = "drop_last") %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      sum_plays = cumsum(n_plays),
      sum_recent = n_plays + lag(n_plays) + lag(lag(n_plays)) + lag(lag(lag(n_plays))) + lag(lag(lag(lag(n_plays)))),
      rolling_recent = sum_recent / 5,
      sum_prev = sum_plays - sum_recent,
      rolling_prev = sum_prev / (n_game - 5),

      # WEIGHTED PACE ---------------------------------------------------------
      rolling_pace =
        case_when(
          n_game <= 5 ~ sum_plays / n_game,
          .default = w * rolling_recent + (1 - w) * rolling_prev
        ),

      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
    # RZ EFF ----------------------------------------------------------------  
  rolling_rz_eff_df =
    szn_all %>%
    filter(season > 2008) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      redzone =
        case_when(
          yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
          yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
          yardline_100 <= 20 ~ 1,
          yardline_100 > 20 ~ 0,
          .default = NA
        )
    ) %>%
    select(season, week, game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam, drive) %>%
    mutate(
      n_drive = row_number(),
      n_drive_rz = ifelse(redzone == 1, n_drive, NA),
      redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
    ) %>%
    ungroup() %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      redzone_trips = sum(redzone_start == 1, na.rm = T),
      redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number(),
      across(starts_with("redzone_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("redzone_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      rolling_recent = (sum_recent_redzone_tds / sum_recent_redzone_trips),
      sum_prev_redzone_trips = sum_redzone_trips - sum_recent_redzone_trips,
      sum_prev_redzone_tds = sum_redzone_tds - sum_recent_redzone_tds,
      rolling_prev = (sum_prev_redzone_tds / sum_prev_redzone_trips),
      
      # WEIGHTED RZ ---------------------------------------------------------
      rolling_rz_eff =
          case_when(
              n_game <= 5 ~ (sum_redzone_tds / sum_redzone_trips),
              .default = w * rolling_recent +
                     (1 - w) * rolling_prev
          ),
      across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()
  
  # SUCCESS ----------------------------------------------------------------  
  rolling_success_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      success =
        case_when(
          down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
          down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
          down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
          .default = 0
        )
    ) %>%
    summarise(
      sum_success_off = sum(success, na.rm = T),
      n_success_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          success =
            case_when(
              down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
              down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
              down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
              .default = 0
            )
        ) %>%
        summarise(
          sum_success_def = sum(success, na.rm = T),
          n_success_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(contains("_success_"), ~ cumsum(.), .names = "sum_{col}"),
      across(starts_with("_success_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_sum_success_off / sum_n_success_off),
      rolling_recent_def = (sum_sum_success_def / sum_n_success_def),
      sum_prev_sum_success_off = sum_success_off - sum_sum_success_off,
      sum_prev_n_success_off = n_success_off - sum_n_success_off,
      sum_prev_sum_success_def = sum_success_def - sum_sum_success_def,
      sum_prev_n_success_def = n_success_def - sum_n_success_def,
      rolling_prev_off = (sum_prev_sum_success_off / sum_prev_n_success_off),
      rolling_prev_def = (sum_prev_sum_success_def / sum_prev_n_success_def),
      
      # WEIGHTED SUCCESS ---------------------------------------------------------
      rolling_success_off_rate =
        case_when(
          n_game <= 5 ~ (sum_sum_success_off / sum_n_success_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_success_def_rate =
        case_when(
          n_game <= 5 ~ (sum_sum_success_def / sum_n_success_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
    ungroup()

  # EXP PLAYS ----------------------------------------------------------------  
  rolling_exp_plays_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      explosive = ifelse(yards_gained >= 20, 1, 0)
    ) %>%
    summarise(
      n_exp_off = sum(explosive, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          explosive = ifelse(yards_gained >= 20, 1, 0)
        ) %>%
        summarise(
          n_exp_def = sum(explosive, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_exp_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_exp_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_exp_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_exp_def / sum_recent_n_tot_def),
      sum_prev_n_exp_off = sum_n_exp_off - sum_recent_n_exp_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_exp_def = sum_n_exp_def - sum_recent_n_exp_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_exp_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_exp_def / sum_prev_n_tot_def),
      
      # WEIGHTED EXP PLAYS ---------------------------------------------------------
      rolling_exp_off_rate =
        case_when(
          n_game <= 5 ~ (sum_n_exp_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_exp_def_rate =
        case_when(
          n_game <= 5 ~ (sum_n_exp_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_exp_plays %>% select(team, game_id, rolling_exp_off_rate, rolling_exp_def_rate), by = c("team", "game_id")) %>%
    ungroup()

  # TO RATE ----------------------------------------------------------------  
  rolling_to_rate_df =
    szn_all %>%
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    mutate(
      turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
    ) %>%
    summarise(
      n_to_off = sum(turnover, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>%
    drop_na() %>%
    ungroup() %>%
    rename(team = posteam) %>%
    left_join(
      szn_all %>%
        filter(season > 2008) %>%
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        mutate(
          turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
        ) %>%
        summarise(
          n_to_def = sum(turnover, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>%
        drop_na() %>%
        ungroup() %>%
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>%
    group_by(season, team) %>%
    arrange(season, team, week) %>%
    mutate(
      n_game = row_number()
    ) %>%
    mutate(
      across(c(contains("_to_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_to_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_to_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_to_def / sum_recent_n_tot_def),
      sum_prev_n_to_off = sum_n_to_off - sum_recent_n_to_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_to_def = sum_n_to_def - sum_recent_n_to_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_to_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_to_def / sum_prev_n_tot_def),
      
      
      # WEIGHTED TO RATE ---------------------------------------------------------
      rolling_to_off_rate =
        case_when(
          n_game <= 5 ~ (sum_n_to_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_to_def_rate =
        case_when(
          n_game <= 5 ~ (sum_n_to_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
    ) %>%
    # left_join(df_rolling_to_rate %>% select(team, game_id, rolling_to_off_rate, rolling_to_def_rate), by = c("team", "game_id")) %>%
    ungroup()
    
  # PEN YARDS ----------------------------------------------------------------  
  rolling_pen_yards_df = 
    szn_all %>% 
    filter(season > 2008) %>%
    filter(!is.na(posteam)) %>%
    group_by(season, week, game_id, posteam) %>%
    summarise(
      n_pen_off = sum(penalty_yards, na.rm = T),
      n_tot_off = n(),
      .groups = "drop"
    ) %>% 
    drop_na() %>% 
    ungroup() %>% 
    rename(team = posteam) %>% 
    left_join(
      szn_all %>% 
        filter(season > 2008) %>% 
        filter(!is.na(defteam)) %>%
        group_by(season, week, game_id, defteam) %>%
        summarise(
          n_pen_def = sum(penalty_yards, na.rm = T),
          n_tot_def = n(),
          .groups = "drop"
        ) %>% 
        drop_na() %>% 
        ungroup() %>% 
        rename(team = defteam),
      by = c("season", "week", "game_id", "team")
    ) %>% 
    group_by(season, team) %>% 
    arrange(season, team, week) %>% 
    mutate(
      n_game = row_number()
    ) %>% 
    mutate(
      across(c(contains("_pen_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
      across(c(contains("_pen_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
      rolling_recent_off = (sum_recent_n_pen_off / sum_recent_n_tot_off),
      rolling_recent_def = (sum_recent_n_pen_def / sum_recent_n_tot_def),
      sum_prev_n_pen_off = sum_n_pen_off - sum_recent_n_pen_off,
      sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
      sum_prev_n_pen_def = sum_n_pen_def - sum_recent_n_pen_def,
      sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
      rolling_prev_off = (sum_prev_n_pen_off / sum_prev_n_tot_off),
      rolling_prev_def = (sum_prev_n_pen_def / sum_prev_n_tot_def),
      
      # WEIGHTED PEN YARDS ---------------------------------------------------------
      rolling_pen_yards_off =
        case_when(
          n_game <= 5 ~ (sum_n_pen_off / sum_n_tot_off),
          .default = w * rolling_recent_off +
                     (1 - w) * rolling_prev_off
        ),
      rolling_pen_yards_def =
        case_when(
          n_game <= 5 ~ (sum_n_pen_def / sum_n_tot_def),
          .default = w * rolling_recent_def +
                     (1 - w) * rolling_prev_def
        ),
      across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
    ) %>% 
    select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>% 
    # left_join(df_rolling_pen_yards %>% select(team, game_id, rolling_pen_yards_off, rolling_pen_yards_def), by = c("team", "game_id")) %>% 
    ungroup()
  
   # Return merged data
  rolling_merged_df = 
    rolling_epa_df %>% 
    left_join(rolling_pace_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_rz_eff_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_success_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_exp_plays_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_to_rate_df, by = c("season", "team", "week", "n_game")) %>% 
    left_join(rolling_pen_yards_df, by = c("season", "team", "week", "n_game"))
  
  team_total_spread_rolling_df =
    szn_all %>% 
    filter(season > 2008) %>% 
    distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
    left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
    left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
    mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
    pivot_longer(
      ends_with("_team"),
      names_to = "home_away",
      values_to = "team"
    ) %>% 
    mutate(home_away = str_remove(home_away, "_team$")) %>% 
    left_join(rolling_merged_df, by = c("season", "week", "team")) %>% 
    left_join(qb_cont_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(rest_days_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
    left_join(team_travel_df %>% select(-game_id), by = c("season", "week", "team")) %>%  
    select(season, week, game_id, team, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_"), qb_cont, rest_days, travel_km) %>%
    mutate(
      travel_km = 
        case_when(
          travel_km == 0 ~ 0,
          .default = log(travel_km)
        ),
      total_team = 
        case_when(
          home_away == "home" ~ home_score,
          home_away == "away" ~ away_score,
          .default = NA
        )
    ) %>% 
    ungroup()  

}

weights <- seq(0.1, 0.9, by = 0.05)

rolling_weights_5prior_df <- map(weights, make_weighted_data_5prior)

names(rolling_weights_5prior_df) <- paste0("w_", gsub("\\.", "_", weights))
```

## Total Mods

```{r total train}
ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

total_train_df = 
  total_spread_epa_pace_rz_df %>% 
  left_join(field_game_df, by = "game_id") %>% 
  select(total, starts_with("prior_"), ends_with("_field"), division_game) %>% 
  drop_na()

view(total_train_df)

# GLM
set.seed(37564)
mod_total_glm = train(total ~ .,
                na.action = na.exclude, 
                data = total_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_total_glm

# ENET
set.seed(37564)
mod_total_enet = train(total ~ .,
                 na.action = na.exclude, 
                 data = total_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(#alpha = seq(0, 1, by = 0.2),
                                        alpha = 0,
                                        lambda = exp(seq(-3, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_total_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_enet$bestTune
min(mod_total_enet$results$RMSE)

# KNN
set.seed(37564)
mod_total_knn = train(total ~ .,
                na.action = na.exclude, 
                data = total_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(120, 150, by = 2)), 
                trControl = ctrl)
ggplot(mod_total_knn, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_knn$bestTune
min(mod_total_knn$results$RMSE)

# MARS
set.seed(37564)
mod_total_mars = train(total ~ .,
                 na.action = na.exclude, 
                 data = total_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_total_mars, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_mars$bestTune
min(mod_total_mars$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_total_boost = train(total ~ .,
                  na.action = na.exclude, 
                  data = total_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(3000, 7000, 11000),
                                         interaction.depth = 1:3,
                                         shrinkage = c(0.0003, 0.0007, 0.0011), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_total_boost, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_boost$bestTune
min(mod_total_boost$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_total_svm = train(total ~ .,
                na.action = na.exclude, 
                data = total_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-4, -1, len = 5)),
                                       sigma = exp(seq(-5, -2, len = 5))),
                trControl = ctrl)
ggplot(mod_total_svm, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_svm$bestTune
min(mod_total_svm$results$RMSE)

set.seed(37564)
vip(
  mod_total_boost, 
  method = "permute", 
  train = drop_na(total_train_df),
  target = "total",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

set.seed(37564)
res = resamples(list(GLM = mod_total_glm, ENET = mod_total_enet, MARS = mod_total_mars, KNN = mod_total_knn, BOOST = mod_total_boost, SVM = mod_total_svm))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

field_2025_df = 
  szn_all %>% 
  filter(season == 2024) %>%
  distinct(game_id, roof, surface, home_team) %>% 
  group_by(home_team, roof, surface) %>%
  summarise(
    n_field = n()
  ) %>%
  ungroup() %>%
  group_by(home_team) %>% 
  arrange(home_team, -n_field) %>%
  slice(1) %>%
  rename(team = home_team) %>% 
  mutate(
    enclosed_field = 
      case_when(
        roof %in% c("closed", "dome") ~ 1,
        roof %in% c("open", "outdoors") ~ 0,
        .default = NA
      ),
    turf_field = 
      case_when(
        str_detect(surface, "turf") | surface == "" | str_detect(surface, "astro") ~ 1,
        str_detect(surface, "grass") ~ 0, 
        .default = NA
      )
  ) %>% 
  select(team, enclosed_field, turf_field)

total_test_df = 
  read_csv("./schedule2025.csv") %>% 
  pivot_longer(
    2:19,
    values_to = "team",
    names_to = "week"
  ) %>% 
  mutate(
    # TEAM = str_remove(TEAM, "@"), 
    # team = str_remove(team, "@"),
    TEAM = str_replace(TEAM, "LAR", "LA"), 
    team = str_replace(team, "LAR", "LA"),
    TEAM = str_replace(TEAM, "WSH", "WAS"), 
    team = str_replace(team, "WSH", "WAS")
  ) %>% 
  rename(
    team_opp = team,
    team = TEAM
  ) %>% 
  mutate(week = as.integer(week)) %>% 
  filter(week == 4) %>% 
  mutate(
    home_away = ifelse(str_detect(team_opp, "^\\@"), "away", "home"),
    team_opp = str_remove(team_opp, "^\\@")
  ) %>% 
  left_join(division_df %>% select(team, division), by = "team") %>% 
  left_join(division_df %>% select(team, division) %>% rename(team_opp = team, division_opp = division), by = "team_opp") %>% 
  mutate(division_game = ifelse(division == division_opp, 1, 0)) %>% 
  left_join(
    rolling_epa_df %>% 
      filter(season == 2025) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_pace_df %>% 
      filter(season == 2025) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_rz_eff_df %>% 
      filter(season == 2025) %>% 
      select(team, rolling_rz_eff),
    by = c("team")
  ) %>% 
  rename_with(~ str_c("prior_", .), starts_with("rolling_")) %>% 
  left_join(field_2025_df, by = "team") %>% 
  mutate(
    across(ends_with("_field"), ~ case_when(home_away == "home" ~ ., .default = NA))
  ) %>% 
  pivot_wider(
    id_cols = c(week, team, team_opp, enclosed_field, turf_field, division_game),
    names_from = home_away,
    values_from = starts_with("prior_")
  ) %>% 
  mutate(game = str_c(team, "vs", team_opp)) %>% 
  pivot_longer(
    c(team, team_opp),
    names_to = "team_game",
    values_to = "team"
  ) %>% 
  arrange(team, team_game) %>%
  relocate(game, team, team_game) %>% 
  group_by(team) %>% 
  fill(starts_with("prior_"), .direction = "downup") %>% 
  fill(ends_with("_field"), .direction = "downup") %>% 
  ungroup() %>% 
  select(-c(team, team_game)) %>% 
  distinct() %>% 
  rowid_to_column("game_id") %>% 
  filter(str_detect(as.character(game_id / 2), "\\.5"))

view(total_test_df)

pred_total_df = 
  total_test_df %>% 
  mutate(
    # pred_total_boost = predict(mod_total_boost, newdata = total_test_df),
    pred_total_svm = predict(mod_total_svm, newdata = total_test_df),
  ) %>% 
  relocate(pred_total_svm, .after = game)
  
set.seed(37564)
boot_splits = bootstraps(drop_na(total_train_df), times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    total ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_total_svm$bestTune[[1]],
      C = mod_total_svm$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = total_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
total_boot_pred_bands = 
  total_test_df %>%
  select(week, game_id, game) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(total_boot_pred_bands)

pred_total_fin_df = 
  pred_total_df %>% 
  left_join(total_boot_pred_bands %>% select(-pred_mean), by = c("game", "game_id")) %>% 
  mutate(
    total_label = round(pred_total_svm, 1)
  )

view(pred_total_fin_df)

pred_total_fin_df %>% 
  # left_join(teams_colors_logos %>% rename(team = team_abbr), by = "team") %>% 
  ggplot(aes(x = pred_total_svm, y = reorder(game, pred_total_svm))) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper), height = 1) +
  geom_point(size = 2.4) +
  geom_text(aes(label = game, x = pred_upper + 0.1), hjust = 0, size = 3.15)+
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(40, 52, by = 1)) +
  labs(
    x = "Predicted Total",
    y = NULL,
    title = "Week 2 Totals"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(40, 52)
  )

```

## Spread Mods

```{r spread train}
ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

spread_train_df = 
  total_spread_epa_pace_rz_df %>% 
  left_join(field_game_df, by = "game_id") %>%
  select(result, starts_with("prior_"), ends_with("_field"), division_game) %>% 
  drop_na()

view(spread_train_df)

# GLM
set.seed(37564)
mod_spread_glm = train(result ~ .,
                na.action = na.exclude, 
                data = spread_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_spread_glm

# ENET
set.seed(37564)
mod_spread_enet = train(result ~ .,
                 na.action = na.exclude, 
                 data = spread_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(#alpha = seq(0, 1, by = 0.2),
                                        alpha = 0,
                                        lambda = exp(seq(-3, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_spread_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_enet$bestTune
min(mod_spread_enet$results$RMSE)

# KNN
set.seed(37564)
mod_spread_knn = train(result ~ .,
                na.action = na.exclude, 
                data = spread_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(120, 150, by = 2)), 
                trControl = ctrl)
ggplot(mod_spread_knn, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_knn$bestTune
min(mod_spread_knn$results$RMSE)

# MARS
set.seed(37564)
mod_spread_mars = train(result ~ .,
                 na.action = na.exclude, 
                 data = spread_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 3:15), 
                 trControl = ctrl)
ggplot(mod_spread_mars, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_mars$bestTune
min(mod_spread_mars$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_spread_boost = train(result ~ .,
                  na.action = na.exclude, 
                  data = spread_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(3000, 7000, 11000),
                                         interaction.depth = 1:3,
                                         shrinkage = c(0.0003, 0.0007, 0.0011), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_spread_boost, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_boost$bestTune
min(mod_spread_boost$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_spread_svm = train(result ~ .,
                na.action = na.exclude, 
                data = spread_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-4, -1, len = 5)),
                                       sigma = exp(seq(-5, -2, len = 5))),
                trControl = ctrl)
ggplot(mod_spread_svm, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_svm$bestTune
min(mod_spread_svm$results$RMSE)

set.seed(37564)
vip(
  mod_spread_boost, 
  method = "permute", 
  train = drop_na(spread_train_df),
  target = "result",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

set.seed(37564)
res = resamples(list(GLM = mod_spread_glm, ENET = mod_spread_enet, MARS = mod_spread_mars, KNN = mod_spread_knn, BOOST = mod_spread_boost, SVM = mod_spread_svm))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

spread_test_df =
  read_csv("./schedule2025.csv") %>% 
  pivot_longer(
    2:19,
    values_to = "team",
    names_to = "week"
  ) %>% 
  mutate(
    # TEAM = str_remove(TEAM, "@"), 
    # team = str_remove(team, "@"),
    TEAM = str_replace(TEAM, "LAR", "LA"), 
    team = str_replace(team, "LAR", "LA"),
    TEAM = str_replace(TEAM, "WSH", "WAS"), 
    team = str_replace(team, "WSH", "WAS")
  ) %>% 
  rename(
    team_opp = team,
    team = TEAM
  ) %>% 
  mutate(week = as.integer(week)) %>% 
  filter(week == 3) %>% 
  mutate(
    home_away = ifelse(str_detect(team_opp, "^\\@"), "away", "home"),
    team_opp = str_remove(team_opp, "^\\@"),
    team_home = 
      case_when(
        home_away == "home" ~ team,
        .default = NA
      )
  ) %>% 
  left_join(division_df %>% select(team, division), by = "team") %>% 
  left_join(division_df %>% select(team, division) %>% rename(team_opp = team, division_opp = division), by = "team_opp") %>% 
  mutate(division_game = ifelse(division == division_opp, 1, 0)) %>% 
  left_join(
    rolling_epa_df %>% 
      filter(season == 2025) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_pace_df %>% 
      filter(season == 2025) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_rz_eff_df %>% 
      filter(season == 2025) %>% 
      select(team, rolling_rz_eff),
    by = c("team")
  ) %>% 
  rename_with(~ str_c("prior_", .), starts_with("rolling_")) %>% 
  left_join(field_2025_df, by = "team") %>% 
  mutate(
    across(ends_with("_field"), ~ case_when(home_away == "home" ~ ., .default = NA))
  ) %>% 
  pivot_wider(
    id_cols = c(week, team, team_opp, team_home, enclosed_field, turf_field, division_game),
    names_from = home_away,
    values_from = starts_with("prior_")
  ) %>% 
  mutate(game = str_c(team, "vs", team_opp)) %>% 
  pivot_longer(
    c(team, team_opp),
    names_to = "team_game",
    values_to = "team"
  ) %>% 
  arrange(team, team_game) %>%
  relocate(game, team, team_game, team_home) %>% 
  group_by(team) %>% 
  fill(starts_with("prior_"), .direction = "downup") %>% 
  fill(ends_with("_field"), .direction = "downup") %>% 
  ungroup() %>% 
  select(-c(team, team_game)) %>% 
  distinct() %>% 
  rowid_to_column("game_id") %>% 
  filter(str_detect(as.character(game_id / 2), "\\.5")) %>% 
  mutate(
    team_home = 
      case_when(
        is.na(team_home) ~ str_extract(game, "[A-Z]+$"),
        .default = team_home
      )
  )

view(spread_test_df)

pred_spread_df = 
  spread_test_df %>% 
  mutate(
    # pred_total_boost = predict(mod_total_boost, newdata = total_test_df),
    pred_spread_svm = round(predict(mod_spread_svm, newdata = spread_test_df), 1)
  ) %>% 
  relocate(pred_spread_svm, .after = game)
  
set.seed(37564)
boot_splits = bootstraps(drop_na(spread_train_df), times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    result ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_spread_svm$bestTune[[1]],
      C = mod_spread_svm$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = spread_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
spread_boot_pred_bands = 
  spread_test_df %>%
  select(week, game_id, game) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(spread_boot_pred_bands)

pred_spread_fin_df =
  pred_spread_df %>% 
  left_join(spread_boot_pred_bands %>% select(-pred_mean), by = c("game", "game_id")) %>% 
  mutate(
    spread_label = 
      case_when(
        pred_spread_svm < 0 ~ str_c(team_home, " +", -pred_spread_svm),
        pred_spread_svm >= 0 ~ str_c(team_home, " ", -pred_spread_svm)
      )
  )

view(pred_spread_fin_df)

pred_total_fin_df %>% 
  left_join(pred_spread_fin_df %>% select(game, spread_label), by = "game") %>% 
  # left_join(teams_colors_logos %>% rename(team = team_abbr), by = "team") %>% 
  ggplot(aes(x = pred_total_svm, y = reorder(game, pred_total_svm))) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper), height = 1) +
  geom_point(size = 2.4) +
  geom_text(aes(label = total_label, x = pred_total_svm), vjust = -1, size = 3.15) +
  geom_text(aes(label = spread_label, x = pred_upper + 0.1), hjust = 0, size = 3.15) +
  geom_text(aes(label = game, x = pred_lower - 0.8), hjust = 0, size = 3.15) +
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(36, 51, by = 1)) +
  labs(
    x = "Predicted Total",
    y = NULL,
    title = "Week 3 Totals w/ Spreads"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(38, 52)
  )

```

## Total Team Mods

```{r total team}
ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
ctrl2 = trainControl(method = "cv", number = 5)

nested_rolling_weights_3priors = 
  tibble(
    weight = weights,
    label = names(rolling_weights_3prior_df),
    data = rolling_weights_3prior_df
  ) %>% 
  rowid_to_column("data_id")

nested_train_3priors_df = 
  nested_rolling_weights_3priors %>% 
  mutate(
    train_df = 
      map(
        .x = data_id,
        ~ nested_rolling_weights_3priors$data[[.x]] %>% 
          left_join(
            nested_rolling_weights_3priors$data[[.x]] %>% 
              group_by(game_id) %>% 
              mutate(
                team_opp = 
                  case_when(
                    row_number() == 1 ~ lead(team),
                    row_number() == 2 ~ lag(team),
                    .default = NA
                  )
              ) %>% 
              relocate(team_opp, .after = team) %>% 
              ungroup() %>% 
              select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
              rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
              rename(team = team_opp),
            by = c("game_id", "team")
          ) %>% 
          filter(season != 2025) %>% 
          # left_join(field_game_df, by = "game_id") %>%
          select(total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
          drop_na()
      )
  )

nested_rolling_weights_4priors = 
  tibble(
    weight = weights,
    label = names(rolling_weights_4prior_df),
    data = rolling_weights_4prior_df
  ) %>% 
  rowid_to_column("data_id")

nested_train_4priors_df = 
  nested_rolling_weights_4priors %>% 
  mutate(
    train_df = 
      map(
        .x = data_id,
        ~ nested_rolling_weights_4priors$data[[.x]] %>% 
          left_join(
            nested_rolling_weights_4priors$data[[.x]] %>% 
              group_by(game_id) %>% 
              mutate(
                team_opp = 
                  case_when(
                    row_number() == 1 ~ lead(team),
                    row_number() == 2 ~ lag(team),
                    .default = NA
                  )
              ) %>% 
              relocate(team_opp, .after = team) %>% 
              ungroup() %>% 
              select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
              rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
              rename(team = team_opp),
            by = c("game_id", "team")
          ) %>% 
          filter(season != 2025) %>% 
          # left_join(field_game_df, by = "game_id") %>%
          select(total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
          drop_na()
      )
  )

nested_rolling_weights_5priors = 
  tibble(
    weight = weights,
    label = names(rolling_weights_5prior_df),
    data = rolling_weights_5prior_df
  ) %>% 
  rowid_to_column("data_id")

nested_train_5priors_df = 
  nested_rolling_weights_5priors %>% 
  mutate(
    train_df = 
      map(
        .x = data_id,
        ~ nested_rolling_weights_5priors$data[[.x]] %>% 
          left_join(
            nested_rolling_weights_5priors$data[[.x]] %>% 
              group_by(game_id) %>% 
              mutate(
                team_opp = 
                  case_when(
                    row_number() == 1 ~ lead(team),
                    row_number() == 2 ~ lag(team),
                    .default = NA
                  )
              ) %>% 
              relocate(team_opp, .after = team) %>% 
              ungroup() %>% 
              select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
              rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
              rename(team = team_opp),
            by = c("game_id", "team")
          ) %>% 
          filter(season != 2025) %>% 
          # left_join(field_game_df, by = "game_id") %>%
          select(total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
          drop_na()
      )
  )

rmse_weight_priors_df = 
  nested_train_3priors_df %>% 
  select(-data) %>% 
  mutate(
    rmse_glm = 
      map_dbl(
        .x = data_id,
        ~ sqrt(mean(
          glm(
            total_team ~ ., 
            data = nested_train_3priors_df$train_df[[.x]]
          )$residuals^2
        ))
      ),
    name_prior = "3"
  ) %>% 
  rbind(
    nested_train_4priors_df %>% 
      select(-data) %>% 
      mutate(
        rmse_glm = 
          map_dbl(
            .x = data_id,
            ~ sqrt(mean(
              glm(
                total_team ~ ., 
                data = nested_train_4priors_df$train_df[[.x]]
              )$residuals^2
            ))
          ),
        name_prior = "4"
      )
  ) %>% 
  rbind(
    nested_train_5priors_df %>% 
      select(-data) %>% 
      mutate(
        rmse_glm = 
          map_dbl(
            .x = data_id,
            ~ sqrt(mean(
              glm(
                total_team ~ ., 
                data = nested_train_5priors_df$train_df[[.x]]
              )$residuals^2
            ))
          ),
        name_prior = "5"
      )
  ) %>% 
  mutate(
    min_rmse_value = min(rmse_glm),
    min_rmse_weight = 
      case_when(
        min_rmse_value == rmse_glm ~ weight,
        .default = NA
      )
  ) %>% 
  fill(min_rmse_weight, .direction = "updown")

rmse_weight_priors_df %>% 
  ggplot(aes(x = weight, y = rmse_glm, color = name_prior)) + 
  geom_point() + 
  geom_line() + 
  geom_hline(yintercept = sqrt(mean(glm(total_team ~ ., data = total_team_train_df)$residuals^2)), linetype = "dashed") + 
  geom_vline(xintercept = unique(rmse_weight_priors_df$min_rmse_weight), linetype = "dotted")

sqrt(mean(glm(total_team ~ ., data = total_team_train_df)$residuals^2))

total_team_train_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  # left_join(field_game_df, by = "game_id") %>%
  select(total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na()

# saveRDS(total_team_train_df, "total_team_train_df.rds")

# total_team_train_df = 
#   team_total_spread_rolling_df %>% 
#   filter(season != 2025) %>% 
#   # left_join(field_game_df, by = "game_id") %>%
#   select(total_team, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
#   drop_na()

view(total_team_train_df)

# GLM
set.seed(37564)
mod_total_team_glm = train(total_team ~ .,
                na.action = na.exclude, 
                data = total_team_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_total_team_glm

# ENET
set.seed(37564)
mod_total_team_enet = train(total_team ~ .,
                 na.action = na.exclude, 
                 data = total_team_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(#alpha = seq(0, 1, by = 0.2),
                                        alpha = 0,
                                        lambda = exp(seq(-4, 1, length = 50))),
                 trControl = ctrl)
ggplot(mod_total_team_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_team_enet$bestTune
min(mod_total_team_enet$results$RMSE)

# KNN
set.seed(37564)
mod_total_team_knn = train(total_team ~ .,
                na.action = na.exclude, 
                data = total_team_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(140, 170, by = 2)), 
                trControl = ctrl)
ggplot(mod_total_team_knn, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_team_knn$bestTune
min(mod_total_team_knn$results$RMSE)

# MARS
set.seed(37564)
mod_total_team_mars = train(total_team ~ .,
                 na.action = na.exclude, 
                 data = total_team_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_total_team_mars, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_team_mars$bestTune
min(mod_total_team_mars$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_total_team_boost = train(total_team ~ .,
                  na.action = na.exclude, 
                  data = total_team_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(1000, 4000, 7000),
                                         interaction.depth = 1:3,
                                         shrinkage = c(0.01, 0.03, 0.05), 
                                         n.minobsinnode = 10), 
                  trControl = ctrl2,
                  verbose = F)
ggplot(mod_total_team_boost, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_team_boost$bestTune
min(mod_total_team_boost$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_total_team_svm = train(total_team ~ .,
                na.action = na.exclude, 
                data = total_team_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = #c(0.03877421, 0.08208500),
                                         exp(seq(-4, -1, len = 5)),
                                       sigma = #c(0.014264234, 0.030197383)),
                                         exp(seq(-5, -2, len = 5))),
                trControl = ctrl)
ggplot(mod_total_team_svm, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_team_svm$bestTune
min(mod_total_team_svm$results$RMSE)

set.seed(37564)
vip(
  mod_total_team_boost, 
  method = "permute", 
  train = total_team_train_df,
  target = "total_team",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75),
  num_features = 40L
)

coef(mod_total_team_enet$finalModel, mod_total_team_enet$bestTune$lambda)

set.seed(37564)
res = resamples(list(GLM = mod_total_team_glm, ENET = mod_total_team_enet, MARS = mod_total_team_mars, KNN = mod_total_team_knn, BOOST = mod_total_team_boost, SVM = mod_total_team_svm))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

# save final SVM model:

# saveRDS(mod_total_team_svm, glue::glue("mod_total_team_svm_{format(Sys.Date(), '%Y_%m_%d')}.rds"))
mod_total_team_svm = readRDS("mod_total_team_svm.rds")

field_2025_df = 
  szn_all %>% 
  filter(season == 2024) %>%
  distinct(game_id, roof, surface, home_team) %>% 
  group_by(home_team, roof, surface) %>%
  summarise(
    n_field = n()
  ) %>%
  ungroup() %>%
  group_by(home_team) %>% 
  arrange(home_team, -n_field) %>%
  slice(1) %>%
  rename(team = home_team) %>% 
  mutate(
    enclosed_field = 
      case_when(
        roof %in% c("closed", "dome") ~ 1,
        roof %in% c("open", "outdoors") ~ 0,
        .default = NA
      ),
    turf_field = 
      case_when(
        str_detect(surface, "turf") | surface == "" | str_detect(surface, "astro") ~ 1,
        str_detect(surface, "grass") ~ 0, 
        .default = NA
      )
  ) %>% 
  select(team, enclosed_field, turf_field)

qb_cont_2025 =
  tibble(
    team = teams_df$team,
    qb_cont = 1
  ) %>% 
  rows_update(
    tibble(
      team = c("WAS"),
      qb_cont = 0
    ),
    by = "team"
  )

rest_days_2025 =
  schedules_szn_all %>% 
  filter(season == 2025 & week == 10) %>% 
  select(home_team, away_team, home_rest, away_rest) %>% 
  pivot_longer(
    c(home_team, away_team),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  pivot_longer(
    c(home_rest, away_rest),
    names_to = "home_away_rest",
    values_to = "rest_days"
  ) %>% 
  filter(str_extract(home_away, "^[a-z]+") == str_extract(home_away_rest, "^[a-z]+")) %>% 
  select(team, rest_days)

travel_df_2025 = 
  games_coords_df %>% 
  filter(str_detect(game_id, "^2025_10_")) %>% 
  mutate(away_team = str_extract(str_remove(game_id, "^2025_10_"), "[A-Z]+")) %>% 
  pivot_longer(
    c(home_team, away_team),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(team_coords_df %>% select(team, home_lat, home_lon), by = "team") %>% 
  mutate(
    travel_km = ifelse(home_away == "home" & location != "Neutral", 0, haversine(home_lat, home_lon, game_lat, game_lon))
  ) %>% 
  select(team, travel_km)

total_team_test_solo_df = 
  read_csv("./schedule2025.csv") %>% 
  pivot_longer(
    2:19,
    values_to = "team",
    names_to = "week"
  ) %>% 
  mutate(
    # TEAM = str_remove(TEAM, "@"), 
    # team = str_remove(team, "@"),
    TEAM = str_replace(TEAM, "LAR", "LA"), 
    team = str_replace(team, "LAR", "LA"),
    TEAM = str_replace(TEAM, "WSH", "WAS"), 
    team = str_replace(team, "WSH", "WAS")
  ) %>% 
  rename(
    team_opp = team,
    team = TEAM
  ) %>% 
  mutate(week = as.integer(week)) %>% 
  filter(week == 10) %>% 
  mutate(
    home_away = ifelse(str_detect(team_opp, "^\\@"), "away", "home"),
    team_opp = str_remove(team_opp, "^\\@"),
    team_home = 
      case_when(
        home_away == "home" ~ team,
        .default = NA
      )
  ) %>% 
  left_join(division_df %>% select(team, division), by = "team") %>% 
  left_join(division_df %>% select(team, division) %>% rename(team_opp = team, division_opp = division), by = "team_opp") %>% 
  mutate(division_game = ifelse(division == division_opp, 1, 0)) %>% 
  left_join(
    rolling_epa_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_pace_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, starts_with("rolling_")),
    by = c("team")
  ) %>% 
  left_join(
    rolling_rz_eff_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, rolling_rz_eff),
    by = c("team")
  ) %>% 
  left_join(
    rolling_success_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, rolling_success_off_rate, rolling_success_def_rate),
    by = c("team")
  ) %>% 
  left_join(
    rolling_exp_plays_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, rolling_exp_off_rate, rolling_exp_def_rate),
    by = c("team")
  ) %>% 
  left_join(
    rolling_to_rate_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, rolling_to_off_rate, rolling_to_def_rate),
    by = c("team")
  ) %>% 
  left_join(
    rolling_pen_yards_df %>% 
      group_by(season, team) %>% 
      filter(season == 2025 & week == max(week, na.rm = T)) %>% 
      ungroup() %>% 
      # filter(season == 2025 & week == 5) %>% 
      select(team, rolling_pen_yards_off, rolling_pen_yards_def),
    by = c("team")
  ) %>% 
  left_join(
    qb_cont_2025 %>%
      select(team, qb_cont),
    by = c("team")
  ) %>%
  left_join(
    rest_days_2025 %>%
      select(team, rest_days),
    by = c("team")
  ) %>%
  left_join(
    travel_df_2025 %>%
      select(team, travel_km),
    by = c("team")
  ) %>%
  rename_with(~ str_c("prior_", .), starts_with("rolling_")) %>% 
  # left_join(field_2025_df, by = "team") %>% 
  mutate(
    across(ends_with("_field"), ~ case_when(home_away == "home" ~ ., .default = NA)),
    travel_km = 
      case_when(
        travel_km == 0 ~ 0,
        .default = log(travel_km)
      )
  )
  
total_team_test_df = 
  total_team_test_solo_df %>% 
  distinct() %>% 
  left_join(
    total_team_test_solo_df %>% 
      distinct() %>% 
      select(team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(team_opp)) %>% 
      rename(team = team_opp),
    by = "team"
  )
  # pivot_wider(
  #   id_cols = c(week, team, team_opp, enclosed_field, turf_field, division_game),
  #   names_from = home_away,
  #   values_from = starts_with("prior_")
  # ) %>%
  # mutate(game = str_c(team, "vs", team_opp)) %>%
  # pivot_longer(
  #   c(team, team_opp),
  #   names_to = "team_game",
  #   values_to = "team"
  # ) %>%
  # arrange(team, team_game) %>%
  # relocate(game, team, team_game) %>%
  # group_by(team) %>%
  # fill(starts_with("prior_"), .direction = "downup") %>%
  # fill(ends_with("_field"), .direction = "downup") %>%
  # ungroup() %>%
  # select(-c(team, team_game)) %>%
  # distinct() %>%
  # rowid_to_column("game_id") %>%
  # filter(str_detect(as.character(game_id / 2), "\\.5"))

view(total_team_test_df)

pred_total_team_df =
  total_team_test_df %>% 
  drop_na(rest_days, prior_rolling_off_rush_epa, prior_rolling_off_rush_epa_opp) %>% 
  mutate(
    # pred_total_boost = predict(mod_total_team_boost, newdata = total_team_test_df),
    pred_total_team_svm = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  relocate(pred_total_team_svm, .after = team) %>% 
  left_join(
    total_team_test_df %>% 
      drop_na(rest_days, prior_rolling_off_rush_epa, prior_rolling_off_rush_epa_opp) %>% 
      mutate(
        pred_total_team_svm = predict(mod_total_team_svm, newdata = .)
      ) %>% 
      select(team, pred_total_team_svm) %>% 
      rename(
        pred_total_team_opp_svm = pred_total_team_svm,
        team_opp = team
      ),
    by = "team_opp"
  ) %>% 
  mutate(
    total_game = pred_total_team_svm + pred_total_team_opp_svm,
    spread_game = 
      case_when(
        home_away == "home" ~ pred_total_team_svm - pred_total_team_opp_svm,
        home_away == "away" ~ pred_total_team_opp_svm - pred_total_team_svm,
        .default = NA
      )
  ) %>% 
  pivot_wider(
    id_cols = c(week, team, team_opp, team_home, total_game, spread_game),
    names_from = home_away,
    values_from = starts_with("prior_")
  ) %>% 
  mutate(game = str_c(team, "vs", team_opp)) %>% 
  pivot_longer(
    c(team, team_opp),
    names_to = "team_game",
    values_to = "team"
  ) %>%
  arrange(team, team_game) %>%
  relocate(game, team, team_game, team_home) %>%
  group_by(team) %>%
  fill(starts_with("prior_"), .direction = "downup") %>%
  # fill(ends_with("_field"), .direction = "downup") %>%
  ungroup() %>% 
  select(-c(team, team_game)) %>% 
  distinct() %>%
  rowid_to_column("game_id") %>% 
  filter(str_detect(as.character(game_id / 2), "\\.5")) %>% 
  mutate(
    team_home = 
      case_when(
        is.na(team_home) ~ str_extract(game, "[A-Z]+$"),
        .default = team_home
      ),
    spread_label = 
      case_when(
        spread_game < 0 ~ str_c(team_home, " +", -round(spread_game, 1)),
        spread_game >= 0 ~ str_c(team_home, " ", -round(spread_game, 1))
      )
  ) %>% 
  relocate(spread_label, .after = spread_game)

view(pred_total_team_df)

## Total Correction Mods:
  
total_correct_train_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  # left_join(field_game_df, by = "game_id") %>%
  select(game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  summarise(
    pred_total = sum(pred_total_team),
    actual_total = sum(total_team)
  ) %>% 
  mutate(
    resid_total = actual_total - pred_total
  ) %>% 
  left_join(field_game_df, by = "game_id") %>% 
  ungroup() %>% 
  select(resid_total, ends_with("_field"), division_game, international, wind, temp, time_start) %>% 
  select(-c(time_start, international)) %>% 
  drop_na()

view(total_correct_train_df)

# GLM
set.seed(37564)
mod_total_correct_glm = train(resid_total ~ .,
                na.action = na.exclude, 
                data = total_correct_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_total_correct_glm

# ENET
set.seed(37564)
mod_total_correct_enet = train(resid_total ~ .,
                 na.action = na.exclude, 
                 data = total_correct_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = seq(0, 1, by = 0.2),
                                        lambda = exp(seq(-4, 1, length = 50))),
                 trControl = ctrl)
ggplot(mod_total_correct_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_total_correct_enet$bestTune
min(mod_total_correct_enet$results$RMSE)

# saveRDS(mod_total_correct_enet, "mod_total_correct_enet.rds")
mod_total_correct_enet = readRDS("mod_total_correct_enet.rds")

# KNN
# set.seed(37564)
# mod_total_correct_knn = train(resid_total ~ .,
#                 na.action = na.exclude, 
#                 data = total_correct_train_df, 
#                 method = "knn", 
#                 preProcess = c("center","scale"),
#                 tuneGrid = data.frame(k = seq(140, 170, by = 2)), 
#                 trControl = ctrl)
# ggplot(mod_total_correct_knn, highlight = T) + 
#   ggtitle("KNN") +
#   theme(plot.title = element_text(hjust = 0.5))
# mod_total_correct_knn$bestTune
# min(mod_total_correct_knn$results$RMSE)
# 
# # MARS
# set.seed(37564)
# mod_total_correct_mars = train(resid_total ~ .,
#                  na.action = na.exclude, 
#                  data = total_correct_train_df, 
#                  method = "earth", 
#                  tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
#                  trControl = ctrl)
# ggplot(mod_total_correct_mars, highlight = T) + 
#   ggtitle("MARS") +
#   theme(plot.title = element_text(hjust = 0.5))
# mod_total_correct_mars$bestTune
# min(mod_total_correct_mars$results$RMSE)
#mod_mars$finalModel %>% summary

weather_2025_df = 
  readxl::read_xlsx("weather_2025_raw.xlsx", sheet = "Week 10") %>% 
  mutate(across(c(temp, wind), ~ as.integer(.)))

schedule_2025_new = 
  fast_scraper_schedules() %>% 
  filter(season == 2025) %>% 
  mutate(
    time_start = as.integer(str_remove(gametime, ":")),
    international = ifelse(location == "Neutral", 1, 0),
    enclosed_field = 
      case_when(
        roof %in% c("closed", "dome") ~ 1,
        roof %in% c("open", "outdoors") ~ 0,
        .default = NA
      ),
    turf_field = 
      case_when(
        str_detect(surface, "turf") | surface == "" | str_detect(surface, "astro") ~ 1,
        str_detect(surface, "grass") ~ 0, 
        .default = NA
      )
  )

view(schedule_2025_new)

## Spread Correction Mods:
  
spread_correct_train_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  # left_join(field_game_df, by = "game_id") %>%
  select(game_id, result, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  mutate(
    pred_spread = pred_total_team - lead(pred_total_team)
  ) %>% 
  drop_na() %>% 
  mutate(
    resid_spread = result - pred_spread
  ) %>% 
  left_join(field_game_df, by = "game_id") %>% 
  ungroup() %>% 
  select(resid_spread, ends_with("_field"), division_game, international, wind, temp, time_start) %>% 
  select(-c(time_start, international)) %>% 
  drop_na()

view(spread_correct_train_df)

# GLM
set.seed(37564)
mod_spread_correct_glm = train(resid_spread ~ .,
                na.action = na.exclude, 
                data = spread_correct_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_spread_correct_glm

# ENET
set.seed(37564)
mod_spread_correct_enet = train(resid_spread ~ .,
                 na.action = na.exclude, 
                 data = spread_correct_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = seq(0, 1, by = 0.2),
                                        lambda = exp(seq(-1, 3, length = 50))),
                 trControl = ctrl)
ggplot(mod_spread_correct_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_spread_correct_enet$bestTune
min(mod_spread_correct_enet$results$RMSE)

# saveRDS(mod_spread_correct_enet, "mod_spread_correct_enet.rds")
mod_spread_correct_enet = readRDS("mod_spread_correct_enet.rds")

pred_total_spread_adj_df = 
  pred_total_team_df %>% 
  left_join(
    schedule_2025_new %>% 
      filter(week == 10) %>% 
      select(home_team, away_team, ends_with("_field")) %>% 
      rename(
        team_home = home_team,
        team_away = away_team
      ), 
    by = "team_home"
  ) %>% 
  left_join(weather_2025_df, by = "game") %>%  
  mutate(
    wind = 
      case_when(
        enclosed_field == 1 ~ 0,
        .default = wind
      ),
    temp = 
      case_when(
        enclosed_field == 1 ~ 72,
        .default = temp
      )
  ) %>% 
  left_join(division_df %>% select(team, division) %>% rename(team_home = team), by = "team_home") %>% 
  left_join(division_df %>% select(team, division) %>% rename(team_away = team, division_opp = division), by = "team_away") %>% 
  mutate(division_game = ifelse(division == division_opp, 1, 0)) %>%
  mutate(
    total_adjust = predict(mod_total_correct_enet, newdata = .),
    total_game_adj = total_game + total_adjust,
    spread_adjust = predict(mod_spread_correct_enet, newdata = .),
    spread_game_adj = spread_game + spread_adjust,
    spread_adj_label = 
      case_when(
        spread_game_adj < 0 ~ str_c(team_home, " +", -round(spread_game_adj, 1)),
        spread_game_adj >= 0 ~ str_c(team_home, " ", -round(spread_game_adj, 1))
      )
  ) %>%
  relocate(total_adjust, total_game_adj, .after = total_game) %>%
  relocate(spread_game, spread_adjust, spread_game_adj, spread_adj_label, .after = total_game_adj)

view(pred_total_spread_adj_df)

# Emperical Bootstrap for Confidence Bands:
# 
# total_empirical_resid = 
#   team_total_spread_rolling_df %>% 
#   select(game_id, total_team, starts_with("prior_")) %>% 
#   drop_na() %>% 
#   mutate(
#     pred_total_team = predict(mod_total_team_svm, newdata = .)
#   ) %>% 
#   group_by(game_id) %>% 
#   summarise(
#     pred_total = sum(pred_total_team),
#     actual_total = sum(total_team)
#   ) %>% 
#   mutate(
#     resid_total = actual_total - pred_total
#   ) %>% 
#   pull(resid_total)
# 
# ## Residual bootstrap: draw 2000 samples of residuals (game-level)
# 
# pred_mat <- matrix(NA, nrow = 10000, ncol = nrow(pred_total_spread_adj_df))
# 
# set.seed(37564)
# for(a in 1:10000) {
#   sampled_resids <- sample(total_empirical_resid, size = nrow(pred_total_spread_adj_df), replace = T)
#   pred_mat[a, ] <- pred_total_spread_adj_df$total_game_adj + sampled_resids
# }
# 
# # Summaries per game
# 
# bootstrap_total_empirical_df = 
#   tibble(
#     game = pred_total_spread_adj_df$game,
#     pred_mean = apply(pred_mat, 2, mean),
#     pred_median = apply(pred_mat, 2, median),
#     pred_lower = apply(pred_mat, 2, quantile, probs = 0.25),
#     pred_upper = apply(pred_mat, 2, quantile, probs = 0.75)
#   )
# 
# view(bootstrap_total_empirical_df)
# 
# pred_total_spread_fin_df =
#   pred_total_spread_adj_df %>% 
#   left_join(
#     bootstrap_total_empirical_df, by = c("game")
#   ) %>% 
#   mutate(
#     total_label = round(total_game_adj, 1)
#   )
# 
# view(pred_total_spread_fin_df)
# 
# pred_total_spread_fin_df %>% 
#   # left_join(teams_colors_logos %>% rename(team = team_abbr), by = "team") %>% 
#   ggplot(aes(x = total_game_adj, y = reorder(game, total_game_adj))) +
#   geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper), height = 1) +
#   geom_point(size = 2.4) +
#   geom_text(aes(label = total_label, x = total_game_adj), vjust = -1, size = 3.15) +
#   geom_text(aes(label = spread_adj_label, x = pred_upper + 0.1), hjust = 0, size = 3.15) +
#   geom_text(aes(label = game, x = pred_lower - 1.7), hjust = 0, size = 3.15) +
#   scale_color_identity() + 
#   scale_x_continuous(breaks = seq(0, 100, by = 2)) +
#   labs(
#     x = "Predicted Total",
#     y = NULL,
#     title = "Week 3 Totals w/ Spreads (IQR Confidence Bands)"
#   ) +
#   theme_minimal() +
#   theme(
#     axis.text.y = element_blank(), 
#     axis.ticks.y = element_blank()
#   ) +
#   coord_cartesian(
#     clip = "off",
#     xlim = c(32, 62)
#   )
# 
# Over/Under probability (empirical)
# make sure new_game$vegas_line aligns with new_game_raw rows
# prob_over <- colMeans(pred_mat > new_game_raw$vegas_line)

set.seed(37564)
boot_splits_total = bootstraps(total_team_train_df, times = 100)

# 2. Predict for each bootstrap model
boot_preds_total = map(boot_splits_total$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    total_team ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_total_team_svm$bestTune[[1]],
      C = mod_total_team_svm$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = total_team_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix_total = do.call(cbind, boot_preds_total)

# 4. Compute mean prediction and 95% prediction interval
total_team_boot_pred_bands = 
  total_team_test_df %>%
  drop_na(division_game) %>% 
  select(week, team, team_opp) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix_total), 2), 
    pred_lower = round(apply(pred_matrix_total, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix_total, 1, quantile, probs = 0.9), 2),
  )

view(total_team_boot_pred_bands)

total_spread_boot_bands = 
  total_team_boot_pred_bands %>% 
  left_join(
    total_team_boot_pred_bands %>% 
      select(team, pred_lower, pred_upper) %>% 
      rename_with(~ str_c(., "_opp"), everything()),
    by = "team_opp"
  ) %>% 
  mutate(
    total_game_lower = pred_lower + pred_lower_opp,
    total_game_upper = pred_upper + pred_upper_opp,
    spread_lower = pred_lower - pred_upper_opp,
    spread_upper = pred_upper - pred_lower_opp
  )

view(total_spread_boot_bands)

pred_total_spread_fin_df = 
  pred_total_spread_adj_df %>% 
  left_join(total_spread_boot_bands %>% select(team, total_game_lower, total_game_upper, spread_lower, spread_upper) %>% rename(team_home = team), by = "team_home") %>% 
  mutate(
    total_game_lower_adj = total_game_lower + total_adjust,
    total_game_upper_adj = total_game_upper + total_adjust,
    spread_lower_adj = spread_lower + spread_adjust,
    spread_upper_adj = spread_upper + spread_adjust,
    total_adj_label = round(total_game_adj, 1),
    lower_spread_adj_label = 
      case_when(
        spread_lower_adj < 0 ~ str_c(team_home, " +", -round(spread_lower_adj, 1)),
        spread_lower_adj >= 0 ~ str_c(team_home, " ", -round(spread_lower_adj, 1))
      ),
    upper_spread_adj_label = 
      case_when(
        spread_upper_adj < 0 ~ str_c(team_home, " +", -round(spread_upper_adj, 1)),
        spread_upper_adj >= 0 ~ str_c(team_home, " ", -round(spread_upper_adj, 1))
      ),
    spread_band_adj_label = 
      str_c(spread_adj_label, " (", str_remove(lower_spread_adj_label, "[A-Z]+ "), " to ", str_remove(upper_spread_adj_label, "[A-Z]+ "), ")")
  ) %>% 
  relocate(total_adj_label, spread_band_adj_label, lower_spread_adj_label, upper_spread_adj_label, total_game_lower_adj, total_game_upper_adj, spread_lower_adj, spread_upper_adj, .after = spread_label)

view(pred_total_spread_fin_df)

pred_total_spread_fin_df %>% 
  left_join(
    schedule_2025_new %>% 
      filter(week == 10) %>% 
      select(game_id, spread_line, total_line) %>% 
      mutate(
        team_home = str_extract(game_id, "[A-Z]+$"),
        spread_line_label = 
          case_when(
            spread_line < 0 ~ str_c("(", team_home, " +", as.character(-spread_line), ")"),
            spread_line >= 0 ~ str_c("(", team_home, " ", as.character(-spread_line), ")"),
            .default = NA
          ),
        total_line_label = total_line
      ),
    by = "team_home"
  ) %>% 
  mutate(
    ind_total_hit = 
      case_when(
        total_line > total_game_upper_adj ~ 1,
        total_line < total_game_lower_adj ~ 1,
        .default = 0
      ),
    ind_spread_hit = 
      case_when(
        spread_line > spread_upper_adj ~ 1,
        spread_line < spread_lower_adj ~ 1,
        .default = 0
      )
  ) %>% 
  # left_join(teams_colors_logos %>% rename(team = team_abbr), by = "team") %>% 
  ggplot(aes(x = total_game_adj, y = reorder(game, total_game_adj))) +
  geom_errorbarh(aes(xmin = total_game_lower_adj, xmax = total_game_upper_adj), height = 1) +
  geom_point(size = 2.4) +
  geom_point(aes(color = as.factor(ind_total_hit), x = total_line, y = reorder(game, total_game_adj)), size = 2.4) +
  geom_text(aes(label = total_adj_label, x = total_game_adj), vjust = -1, size = 3.15) +
  geom_text(aes(label = spread_band_adj_label, x = total_game_upper_adj + 0.1), hjust = 0, size = 3.15) +
  geom_text(aes(label = game, x = total_game_lower_adj - 1), hjust = 0, size = 3.15) +
  geom_text(aes(color = as.factor(ind_total_hit), label = total_line_label, x = total_line), vjust = -1, size = 3.15) +
  geom_text(aes(color = as.factor(ind_spread_hit), label = spread_line_label, x = total_line), vjust = 2, size = 2.4) +
  # scale_color_identity() + 
  scale_x_continuous(breaks = seq(0, 100, by = 1)) +
  scale_color_manual(values = c("coral3", "skyblue2")) + 
  labs(
    x = "Predicted Total",
    y = NULL,
    title = "Week 10 Spreads & Totals (80% Confidence Bands)"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank(),
    legend.position = "none"
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(38, 54)
  )

rmse_total_line_week_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  # filter(season == 2021) %>% 
  select(season, week, game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id, season, week) %>% 
  summarise(
    pred_total = sum(pred_total_team),
    actual_total = sum(total_team)
  ) %>% 
  left_join(field_game_df, by = c("game_id")) %>% 
  ungroup() %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_total, pred_total) %>% 
  drop_na() %>% 
  mutate(
    pred_total_adj = predict(mod_total_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(season, week, game_id, total_line), by = c("game_id")) %>% 
  mutate(
    resid_mod = actual_total - (pred_total + pred_total_adj),
    resid_line = actual_total - total_line
  ) %>% 
  drop_na() %>% 
  group_by(season, week) %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  ) %>% 
  ungroup() %>% 
  mutate(
    rmse_diff = rmse_line - rmse_mod
  )

rmse_total_line_df =
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  # filter(season == 2021) %>% 
  select(season, week, game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id, season, week) %>% 
  summarise(
    pred_total = sum(pred_total_team),
    actual_total = sum(total_team)
  ) %>% 
  left_join(field_game_df, by = c("game_id")) %>% 
  ungroup() %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_total, pred_total) %>% 
  drop_na() %>% 
  mutate(
    pred_total_adj = predict(mod_total_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(season, week, game_id, total_line), by = c("game_id")) %>% 
  mutate(
    resid_mod = actual_total - (pred_total + pred_total_adj),
    resid_line = actual_total - total_line
  ) %>% 
  drop_na() %>% 
  group_by(season) %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  ) %>% 
  ungroup() %>% 
  mutate(
    rmse_diff = rmse_line - rmse_mod
  )

rmse_spread_line_week_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  # filter(season == 2021) %>% 
  select(season, week, game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id, season, week) %>% 
  # mutate(
  #   game_id_n = row_number()
  # ) %>% 
  summarise(
    pred_spread = pred_total_team - lead(pred_total_team),
    actual_spread = total_team - lead(total_team)
  ) %>% 
  drop_na() %>% 
  left_join(field_game_df, by = c("game_id")) %>% 
  ungroup() %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_spread, pred_spread) %>% 
  drop_na() %>% 
  mutate(
    pred_spread_adj = predict(mod_spread_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(season, week, game_id, spread_line), by = c("game_id")) %>% 
  mutate(
    resid_mod = actual_spread - (pred_spread + pred_spread_adj),
    resid_line = actual_spread - spread_line
  ) %>% 
  drop_na() %>% 
  group_by(season, week) %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  ) %>% 
  ungroup() %>% 
  mutate(
    rmse_diff = rmse_line - rmse_mod
  )

rmse_spread_line_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  # filter(season == 2021) %>% 
  select(season, week, game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  # mutate(
  #   game_id_n = row_number()
  # ) %>% 
  summarise(
    pred_spread = pred_total_team - lead(pred_total_team),
    actual_spread = total_team - lead(total_team)
  ) %>% 
  drop_na() %>% 
  left_join(field_game_df, by = c("game_id")) %>% 
  ungroup() %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_spread, pred_spread) %>% 
  drop_na() %>% 
  mutate(
    pred_spread_adj = predict(mod_spread_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(season, week, game_id, spread_line), by = c("game_id")) %>% 
  mutate(
    resid_mod = actual_spread - (pred_spread + pred_spread_adj),
    resid_line = actual_spread - spread_line
  ) %>% 
  drop_na() %>% 
  group_by(season) %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  ) %>% 
  ungroup() %>% 
  mutate(
    rmse_diff = rmse_line - rmse_mod
  )

# rmse_total_line_week_df %>% 
#   ggplot(aes(x = week, y = rmse_diff)) + 
#   geom_point() + 
#   geom_line() + 
#   geom_smooth(aes(group = season)) + 
#   geom_hline(yintercept = 0, color = "red", linetype = "dashed") + 
#   facet_wrap(~ season, ncol = 6) + 
#   scale_x_continuous(breaks = seq(2, 18, by = 2)) +
#   labs(
#     title = "Total Model",
#     x = "Week",
#     y = "\U0394 RMSE"
#   )
# 
# rmse_spread_line_week_df %>% 
#   ggplot(aes(x = week, y = rmse_diff)) + 
#   geom_point() + 
#   geom_line() + 
#   geom_smooth(aes(group = season)) + 
#   geom_hline(yintercept = 0, color = "red", linetype = "dashed") + 
#   facet_wrap(~ season, ncol = 6) + 
#   scale_x_continuous(breaks = seq(2, 18, by = 2)) +
#   labs(
#     title = "Spread Model",
#     x = "Week",
#     y = "\U0394 RMSE"
#   )

rmse_total_line_week_df %>% 
  mutate(model = "Total Model") %>% 
  rbind(
    rmse_spread_line_week_df %>% 
      mutate(model = "Spread Model")
  ) %>% 
  ggplot(aes(x = week, y = rmse_diff, group = model, color = model)) + 
  geom_point(size = 1.4, alpha = 0.64) + 
  geom_line(size = 0.8, alpha = 0.64) + 
  geom_smooth(size = 1.8, se = F) + 
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") + 
  facet_wrap(~ season, ncol = 6) + 
  scale_x_continuous(breaks = seq(2, 18, by = 2)) +
  scale_color_manual(name = "", values = c("forestgreen", "purple3")) +
  labs(
    # title = "Total Model",
    x = "Week",
    y = "\U0394 RMSE"
  ) + 
  theme_classic() + 
  theme(
    legend.position = "inside",
    legend.position.inside = c(0.9, 0.1)
  )

rmse_total_line_df %>% 
  mutate(model = "Total Model") %>% 
  rbind(
    rmse_spread_line_df %>% 
      mutate(model = "Spread Model")
  ) %>% 
  ggplot(aes(x = season, y = rmse_diff, group = model, color = model)) + 
  geom_point() +
  geom_line() +
  geom_smooth(se = F) + 
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") + 
  scale_x_continuous(breaks = seq(2009, 2025, by = 1)) +
  scale_color_manual(name = "", values = c("forestgreen", "purple3")) + 
  # facet_wrap(~ model) + 
  labs(
    x = "Season",
    y = "\U0394 RMSE"
  ) + 
  theme_classic() + 
  theme(
    legend.position = "inside",
    legend.position.inside = c(0.1, 0.1)
  )

# rmse_spread_line_df %>% 
#   ggplot(aes(x = season, y = rmse_diff)) + 
#   geom_point() + 
#   geom_line() + 
#   geom_smooth() + 
#   geom_hline(yintercept = 0, color = "red", linetype = "dashed") + 
#   scale_x_continuous(breaks = seq(2009, 2025, by = 1)) +
#   labs(
#     title = "Spread Model",
#     x = "Season",
#     y = "\U0394 RMSE"
#   )

resid_total_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  select(game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  summarise(
    pred_total = sum(pred_total_team),
    actual_total = sum(total_team)
  ) %>% 
  left_join(field_game_df, by = "game_id") %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_total, pred_total) %>% 
  drop_na() %>% 
  mutate(
    pred_total_adj = predict(mod_total_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(game_id, total_line), by = "game_id") %>% 
  mutate(
    resid_mod = actual_total - (pred_total + pred_total_adj),
    resid_line = actual_total - total_line
  ) %>% 
  drop_na()

rmse_total_df = 
  resid_total_df %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  )

resid_spread_df = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  select(game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  summarise(
    pred_spread = pred_total_team - lead(pred_total_team),
    actual_spread = total_team - lead(total_team),
    rest_diff = rest_days - lead(rest_days),
    travel_diff = travel_km - lead(travel_km),
    qb_diff = qb_cont - lead(qb_cont)
  ) %>% 
  drop_na() %>% 
  left_join(field_game_df, by = c("game_id")) %>% 
  ungroup() %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, actual_spread, pred_spread, rest_diff, travel_diff, qb_diff) %>% 
  drop_na() %>% 
  mutate(
    pred_spread_adj = predict(mod_spread_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(game_id, spread_line), by = "game_id") %>% 
  mutate(
    resid_mod = actual_spread - (pred_spread + pred_spread_adj),
    resid_line = actual_spread - spread_line
  ) %>% 
  drop_na()

rmse_spread_df = 
  resid_spread_df %>% 
  summarise(
    rmse_mod = sqrt(sum(resid_mod ^ 2) / n()),
    rmse_line = sqrt(sum(resid_line ^ 2) / n())
  )

cor(resid_total_df$resid_mod, resid_total_df$resid_line) 

cor(resid_spread_df$resid_mod, resid_spread_df$resid_line) 

lm(resid_line ~ resid_mod, data = resid_spread_df) %>% 
  summary()

lm(resid_mod ~ rest_diff + travel_diff + qb_diff, data = resid_spread_df) %>% 
  summary()

mean(resid_spread_df$resid_mod)
var(resid_spread_df$resid_mod)

resid_spread_df %>% 
  mutate(season = str_extract(game_id, "^[0-9]+")) %>% 
  group_by(season) %>% 
  summarise(
    rmse_mod_szn = sqrt(mean(resid_mod ^ 2)),
    rmse_line_szn = sqrt(mean(resid_line^ 2)),
    bias_mod = mean(resid_mod),
    cor_resid = cor(resid_mod, resid_line)
  ) %>% 
  view

correction_features_resid = 
  team_total_spread_rolling_df %>% 
  left_join(
    team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  # left_join(field_game_df, by = "game_id") %>%
  select(game_id, total_team, starts_with("prior_"), qb_cont, qb_cont_opp, rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na() %>% 
  mutate(
    pred_total_team = predict(mod_total_team_svm, newdata = .)
  ) %>% 
  group_by(game_id) %>% 
  summarise(
    pred_total = sum(pred_total_team),
    actual_total = sum(total_team)
  ) %>% 
  left_join(field_game_df, by = "game_id") %>% 
  select(game_id, ends_with("_field"), division_game, international, wind, temp, time_start, actual_total, pred_total) %>% 
  drop_na() %>% 
  mutate(
    pred_total_adj = predict(mod_total_correct_enet, newdata = .)
  ) %>% 
  left_join(szn_all %>% distinct(game_id, total_line), by = "game_id") %>% 
  mutate(
    resid_mod = actual_total - pred_total,# + pred_total_adj,
    resid_line = actual_total - total_line
  ) %>% 
  drop_na()

correction_features_resid %>% 
  glm(resid_mod ~ enclosed_field, data = .) %>% 
  summary()

correction_features_resid %>% 
  ggplot(aes(x = wind, y = resid_mod)) + 
  geom_point() + 
  geom_smooth() + 
  coord_cartesian(x = c(0, 20), y = c(-25, 25))
```

## Playoffs

```{r playoffs}
# create indicator dataset for teams resting starters last week of season: 
  
qb_starters = 
  szn_all_playoffs %>% 
  filter(qtr == 1) %>%
  filter(!is.na(passer_id)) %>% 
  group_by(season, week, game_id, posteam, passer_id) %>%
  summarise(dropbacks = n(), .groups = "drop_last") %>%
  slice_max(order_by = dropbacks, n = 1, with_ties = F) %>%
  ungroup() %>%
  rename(team = posteam, qb_id = passer_id)

starters_last_week_df = 
  szn_all_playoffs %>% 
  distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>% 
  filter(
    (season < 2021 & week %in% c(16, 17)) | 
      (season >= 2021 & week %in% c(17, 18))
  ) %>% 
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(
    qb_starters %>% 
      select(game_id, team, qb_id), 
    by = c("game_id", "team")
  ) %>% 
  group_by(season, team) %>%
  arrange(week, .by_group = TRUE) %>%
  mutate(
    prev_qb = lag(qb_id),
    qb_cont = ifelse(!is.na(prev_qb) & qb_id == prev_qb, 1, 0)
  ) %>%
  ungroup() %>% 
  select(season, week, team, game_id, qb_cont) %>% 
  rename(starters_played = qb_cont) %>% 
  group_by(season, team) %>% 
  slice(2) %>% 
  ungroup()

playoffs_rolling_epa_df =
  szn_all_playoffs %>% 
  filter(rush == 1 | pass == 1, !is.na(epa), !is.na(posteam), posteam != "") %>%
  select(season, week, posteam, pass, epa) %>%
  group_by(season, week, posteam, pass) %>%
  summarize(epa = mean(epa)) %>%
  pivot_wider(names_from = pass, values_from = epa) %>%
  rename(off_pass_epa = "1", off_rush_epa = "0", team = "posteam") %>%
  ungroup() %>%
  left_join(
    szn_all_playoffs %>%
      filter(rush == 1 | pass == 1, !is.na(epa), !is.na(defteam), defteam != "") %>%
      select(season, week, defteam, pass, epa) %>%
      group_by(season, week, defteam, pass) %>%
      summarize(epa = mean(epa)) %>%
      pivot_wider(names_from = pass, values_from = epa) %>%
      rename(def_pass_epa = "1", def_rush_epa = "0", team = "defteam") %>%
      ungroup(),
    by = c("season", "week", "team")
  ) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(n_game = row_number()) %>%
  mutate(
    across(ends_with("_epa"), ~ cumsum(.), .names = "sum_{col}"),
    across(ends_with("_epa"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    across(starts_with("sum_recent_"), ~ . / 5, .names = "rolling_{col}_recent"),
    sum_prev_off_rush_epa = sum_off_rush_epa - sum_recent_off_rush_epa,
    sum_prev_off_pass_epa = sum_off_pass_epa - sum_recent_off_pass_epa,
    sum_prev_def_rush_epa = sum_def_rush_epa - sum_recent_def_pass_epa,
    sum_prev_def_pass_epa = sum_def_pass_epa - sum_recent_def_pass_epa,
    across(starts_with("sum_prev_"), ~ . / (n_game - 5), .names = "rolling_{col}_prev"),
    rolling_off_rush_epa =
      case_when(
        n_game <= 5 ~ sum_off_rush_epa / n_game,
        .default = 0.65 * rolling_sum_recent_off_rush_epa_recent + 0.35 * rolling_sum_prev_off_rush_epa_prev
      ),
    rolling_off_pass_epa =
      case_when(
        n_game <= 5 ~ sum_off_pass_epa / n_game,
        .default = 0.65 * rolling_sum_recent_off_pass_epa_recent + 0.35 * rolling_sum_prev_off_pass_epa_prev
      ),
    rolling_def_rush_epa =
      case_when(
        n_game <= 5 ~ sum_def_rush_epa / n_game,
        .default = 0.65 * rolling_sum_recent_def_rush_epa_recent + 0.35 * rolling_sum_prev_def_rush_epa_prev
      ),
    rolling_def_pass_epa =
      case_when(
        n_game <= 5 ~ sum_def_pass_epa / n_game,
        .default = 0.65 * rolling_sum_recent_def_pass_epa_recent + 0.35 * rolling_sum_prev_def_pass_epa_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

playoffs_rolling_pace_df =
  szn_all_playoffs %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(n_plays = n()) %>%
  drop_na() %>%
  rename(team = posteam) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number(),
    sum_plays = cumsum(n_plays),
    sum_recent = n_plays + lag(n_plays) + lag(lag(n_plays)) + lag(lag(lag(n_plays))) + lag(lag(lag(lag(n_plays)))),
    rolling_recent = sum_recent / 5,
    sum_prev = sum_plays - sum_recent,
    rolling_prev = sum_prev / (n_game - 5),
    rolling_pace =
      case_when(
        n_game <= 5 ~ sum_plays / n_game,
        .default = 0.65 * rolling_recent + 0.35 * rolling_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")#,
    # rolling_pace = cumsum(n_plays) / n_game
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

playoffs_rolling_rz_eff_df =
  szn_all_playoffs %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    redzone =
      case_when(
        yardline_100 <= 20 & two_point_attempt == 1 ~ NA,
        yardline_100 <= 20 & extra_point_attempt == 1 ~ NA,
        yardline_100 <= 20 ~ 1,
        yardline_100 > 20 ~ 0,
        .default = NA
      )
  ) %>%
  select(season, week, game_id, drive, posteam, yardline_100, redzone, touchdown, extra_point_attempt, two_point_attempt) %>%
  ungroup() %>%
  group_by(season, week, game_id, posteam, drive) %>%
  mutate(
    n_drive = row_number(),
    n_drive_rz = ifelse(redzone == 1, n_drive, NA),
    redzone_start = ifelse(n_drive_rz == min(n_drive_rz, na.rm = T), 1, 0)
  ) %>%
  ungroup() %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(
    redzone_trips = sum(redzone_start == 1, na.rm = T),
    redzone_tds = sum(redzone == 1 & touchdown == 1, na.rm = T)
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number(),
    across(starts_with("redzone_"), ~ cumsum(.), .names = "sum_{col}"),
    across(starts_with("redzone_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent = (sum_recent_redzone_tds / sum_recent_redzone_trips),
    sum_prev_redzone_trips = sum_redzone_trips - sum_recent_redzone_trips,
    sum_prev_redzone_tds = sum_redzone_tds - sum_recent_redzone_tds,
    rolling_prev = (sum_prev_redzone_tds / sum_prev_redzone_trips),
    rolling_rz_eff =
      case_when(
        n_game <= 5 ~ (sum_redzone_tds / sum_redzone_trips),
        .default = 0.65 * rolling_recent + 0.35 * rolling_prev
      ),
    across(starts_with("rolling_"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

playoffs_rolling_success_df =
  szn_all_playoffs %>%
  filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    success =
      case_when(
        down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
        down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
        down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
        .default = 0
      )
  ) %>%
  summarise(
    sum_success_off = sum(success, na.rm = T),
    n_success_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all_playoffs %>%
      filter(down %in% c(1:4) & !is.na(yards_gained)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        success =
          case_when(
            down == 1 & yards_gained >= 0.4 * ydstogo ~ 1,
            down == 2 & yards_gained >= 0.6 * ydstogo ~ 1,
            down %in% c(3:4) & yards_gained >= ydstogo ~ 1,
            .default = 0
          )
      ) %>%
      summarise(
        sum_success_def = sum(success, na.rm = T),
        n_success_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(contains("_success_"), ~ cumsum(.), .names = "sum_{col}"),
    across(starts_with("_success_"), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_sum_success_off / sum_n_success_off),
    rolling_recent_def = (sum_sum_success_def / sum_n_success_def),
    sum_prev_sum_success_off = sum_success_off - sum_sum_success_off,
    sum_prev_n_success_off = n_success_off - sum_n_success_off,
    sum_prev_sum_success_def = sum_success_def - sum_sum_success_def,
    sum_prev_n_success_def = n_success_def - sum_n_success_def,
    rolling_prev_off = (sum_prev_sum_success_off / sum_prev_n_success_off),
    rolling_prev_def = (sum_prev_sum_success_def / sum_prev_n_success_def),
    rolling_success_off_rate =
      case_when(
        n_game <= 5 ~ (sum_sum_success_off / sum_n_success_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_success_def_rate =
      case_when(
        n_game <= 5 ~ (sum_sum_success_def / sum_n_success_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>%
  ungroup()

playoffs_rolling_exp_plays_df =
  szn_all_playoffs %>%
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    explosive = ifelse(yards_gained >= 20, 1, 0)
  ) %>%
  summarise(
    n_exp_off = sum(explosive, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all_playoffs %>%
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        explosive = ifelse(yards_gained >= 20, 1, 0)
      ) %>%
      summarise(
        n_exp_def = sum(explosive, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(c(contains("_exp_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_exp_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_exp_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_exp_def / sum_recent_n_tot_def),
    sum_prev_n_exp_off = sum_n_exp_off - sum_recent_n_exp_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_exp_def = sum_n_exp_def - sum_recent_n_exp_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_exp_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_exp_def / sum_prev_n_tot_def),
    rolling_exp_off_rate =
      case_when(
        n_game <= 5 ~ (sum_n_exp_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_exp_def_rate =
      case_when(
        n_game <= 5 ~ (sum_n_exp_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  # left_join(df_rolling_exp_plays %>% select(team, game_id, rolling_exp_off_rate, rolling_exp_def_rate), by = c("team", "game_id")) %>%
  ungroup()

playoffs_rolling_to_rate_df =
  szn_all_playoffs %>%
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  mutate(
    turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
  ) %>%
  summarise(
    n_to_off = sum(turnover, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>%
  drop_na() %>%
  ungroup() %>%
  rename(team = posteam) %>%
  left_join(
    szn_all_playoffs %>%
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      mutate(
        turnover = ifelse(interception == 1 | fumble == 1, 1, 0)
      ) %>%
      summarise(
        n_to_def = sum(turnover, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>%
      drop_na() %>%
      ungroup() %>%
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>%
  group_by(season, team) %>%
  arrange(season, team, week) %>%
  mutate(
    n_game = row_number()
  ) %>%
  mutate(
    across(c(contains("_to_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_to_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_to_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_to_def / sum_recent_n_tot_def),
    sum_prev_n_to_off = sum_n_to_off - sum_recent_n_to_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_to_def = sum_n_to_def - sum_recent_n_to_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_to_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_to_def / sum_prev_n_tot_def),
    rolling_to_off_rate =
      case_when(
        n_game <= 5 ~ (sum_n_to_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_to_def_rate =
      case_when(
        n_game <= 5 ~ (sum_n_to_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & ends_with("_rate"), ~ lag(.), .names = "prior_{col}")
  ) %>%
  # left_join(df_rolling_to_rate %>% select(team, game_id, rolling_to_off_rate, rolling_to_def_rate), by = c("team", "game_id")) %>%
  ungroup()
  
playoffs_rolling_pen_yards_df = 
  szn_all_playoffs %>% 
  filter(!is.na(posteam)) %>%
  group_by(season, week, game_id, posteam) %>%
  summarise(
    n_pen_off = sum(penalty_yards, na.rm = T),
    n_tot_off = n(),
    .groups = "drop"
  ) %>% 
  drop_na() %>% 
  ungroup() %>% 
  rename(team = posteam) %>% 
  left_join(
    szn_all_playoffs %>% 
      filter(!is.na(defteam)) %>%
      group_by(season, week, game_id, defteam) %>%
      summarise(
        n_pen_def = sum(penalty_yards, na.rm = T),
        n_tot_def = n(),
        .groups = "drop"
      ) %>% 
      drop_na() %>% 
      ungroup() %>% 
      rename(team = defteam),
    by = c("season", "week", "game_id", "team")
  ) %>% 
  left_join(starters_last_week_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  filter(starters_played == 1 | is.na(starters_played)) %>% 
  group_by(season, team) %>% 
  arrange(season, team, week) %>% 
  mutate(
    n_game = row_number()
  ) %>% 
  mutate(
    across(c(contains("_pen_"), contains("_tot_")), ~ cumsum(.), .names = "sum_{col}"),
    across(c(contains("_pen_"), contains("_tot_"), -starts_with("sum_")), ~ . + lag(.) + lag(lag(.)) + lag(lag(lag(.))) + lag(lag(lag(lag(.)))), .names = "sum_recent_{col}"),
    rolling_recent_off = (sum_recent_n_pen_off / sum_recent_n_tot_off),
    rolling_recent_def = (sum_recent_n_pen_def / sum_recent_n_tot_def),
    sum_prev_n_pen_off = sum_n_pen_off - sum_recent_n_pen_off,
    sum_prev_n_tot_off = sum_n_tot_off - sum_recent_n_tot_off,
    sum_prev_n_pen_def = sum_n_pen_def - sum_recent_n_pen_def,
    sum_prev_n_tot_def = sum_n_tot_def - sum_recent_n_tot_def,
    rolling_prev_off = (sum_prev_n_pen_off / sum_prev_n_tot_off),
    rolling_prev_def = (sum_prev_n_pen_def / sum_prev_n_tot_def),
    rolling_pen_yards_off =
      case_when(
        n_game <= 5 ~ (sum_n_pen_off / sum_n_tot_off),
        .default = 0.65 * rolling_recent_off + 0.35 * rolling_prev_off
      ),
    rolling_pen_yards_def =
      case_when(
        n_game <= 5 ~ (sum_n_pen_def / sum_n_tot_def),
        .default = 0.65 * rolling_recent_def + 0.35 * rolling_prev_def
      ),
    across(starts_with("rolling_") & contains("_yards_"), ~ lag(.), .names = "prior_{col}")
  ) %>% 
  select(-starts_with("sum_"), -ends_with("_prev"), -ends_with("_recent")) %>% 
  # left_join(df_rolling_pen_yards %>% select(team, game_id, rolling_pen_yards_off, rolling_pen_yards_def), by = c("team", "game_id")) %>% 
  ungroup()

playoffs_qb_cont_df = 
  szn_all_playoffs %>% 
  distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(
    qb_starters %>% 
      select(game_id, team, qb_id), 
    by = c("game_id", "team")
  ) %>%
  group_by(season, team) %>%
  arrange(week, .by_group = TRUE) %>%
  mutate(
    prev_qb = lag(qb_id),
    qb_cont = ifelse(!is.na(prev_qb) & qb_id == prev_qb, 1, 0)
  ) %>%
  ungroup() %>% 
  select(season, week, team, game_id, qb_cont)

# view(qb_cont_df)

playoffs_rest_days_df = 
  szn_all_playoffs %>% 
  mutate(date_game = as.Date(game_date)) %>% 
  distinct(season, week, game_id, home_team, away_team, date_game) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  group_by(season, team) %>%
  arrange(date_game, .by_group = TRUE) %>% 
  mutate(
    prev_date_game = lag(date_game),
    rest_days = as.integer(date_game - prev_date_game)
  ) %>%
  ungroup() %>% 
  select(season, week, team, game_id, rest_days)

stadium_coords_df = 
  tibble::tribble(
    ~team,    ~stadium,                        ~lat,      ~lon,
    # --- Current Teams ---
    "ARI",    "State Farm Stadium",            33.5273,  -112.2639,
    "ATL",    "Mercedes-Benz Stadium",         33.7558,   -84.4018,
    "BAL",    "M&T Bank Stadium",              39.2781,   -76.6228,
    "BUF",    "Highmark Stadium",              42.7735,   -78.7869,
    "CAR",    "Bank of America Stadium",       35.2258,   -80.8528,
    "CHI",    "Soldier Field",                 41.8625,   -87.6167,
    "CIN",    "Paycor Stadium",                39.0954,   -84.5160,
    "CLE",    "Cleveland Browns Stadium",      41.5061,   -81.6994,
    "DAL",    "AT&T Stadium",                  32.7473,   -97.0945,
    "DEN",    "Empower Field",                 39.7439,  -105.0200,
    "DET",    "Ford Field",                    42.3400,   -83.0456,
    "GB",     "Lambeau Field",                 44.5013,   -88.0622,
    "HOU",    "NRG Stadium",                   29.6849,   -95.4108,
    "IND",    "Lucas Oil Stadium",             39.7601,   -86.1638,
    "JAX",    "EverBank Stadium",              30.3239,   -81.6373,
    "KC",     "Arrowhead Stadium",             39.0489,   -94.4839,
    "LA",     "SoFi Stadium",                  33.9536,  -118.3396,
    "LAC",    "SoFi Stadium",                  33.9536,  -118.3396,
    "LV",     "Allegiant Stadium",             36.0908,  -115.1839,
    "MIA",    "Hard Rock Stadium",             25.9580,   -80.2389,
    "MIN",    "U.S. Bank Stadium",             44.9738,   -93.2581,
    "NE",     "Gillette Stadium",              42.0909,   -71.2643,
    "NO",     "Caesars Superdome",             29.9508,   -90.0811,
    "NYG",    "MetLife Stadium",               40.8135,   -74.0745,
    "NYJ",    "MetLife Stadium",               40.8135,   -74.0745,
    "PHI",    "Lincoln Financial Field",       39.9008,   -75.1675,
    "PIT",    "Acrisure Stadium",              40.4468,   -80.0158,
    "SEA",    "Lumen Field",                   47.5951,  -122.3323,
    "SF",     "Levi's Stadium",                37.4030,  -121.9700,
    "TB",     "Raymond James Stadium",         27.9758,   -82.5033,
    "TEN",    "Nissan Stadium",                36.1665,   -86.7713,
    "WAS",    "FedExField",                    38.9078,   -76.8644,
    
    # --- Old Stadiums / Relocated Teams ---
    "SD",     "Qualcomm Stadium",              32.7831,  -117.1195,  # San Diego Chargers (19672016)
    "STL",    "Edward Jones Dome",             38.6329,   -90.1885,  # St. Louis Rams (19952015)
    "OAK",    "Oakland Coliseum",              37.7516,  -122.2005,  # Oakland Raiders (19662019)
  
    # --- International / Neutral ---
    "INTL_LON",   "Wembley Stadium",      51.5560,   -0.2796,
    "INTL_LON",   "Tottenham Stadium",     51.6043,   -0.0664,
    "INTL_MEX",   "Azteca Stadium",  19.3029,  -99.1505,
    "INTL_GER",   "Allianz Arena",        48.2188,   11.6247,
    "INTL_GER",   "Deutsche Bank Park",50.0686,    8.6456
) %>%
  add_row(
    team = "INTL_BRA", 
    stadium = "Arena Corinthians", 
    lat = -23.5450, 
    lon = -46.4734
  ) %>%
  add_row(
    team    = "INTL_TWICKENHAM",
    stadium = "Twickenham Stadium",
    lat     = 51.4560,
    lon     = -0.3415
  ) %>%
  add_row(
    team    = "INTL_TOR",
    stadium = "Rogers Centre",
    lat     = 43.6414,
    lon     = -79.3894
  )

# view(stadium_coords_df)

schedules_szn_all = 
  fast_scraper_schedules() %>% 
  filter(season > 2008)

# view(schedules_szn_all)

games_coords_df = 
  schedules_szn_all %>% 
  rename(stadium_old = stadium) %>% 
  filter(location != "Neutral") %>% 
  left_join(
    stadium_coords_df %>% 
      rename(home_team = team),
    by = "home_team"
  ) %>% 
  rbind(
    schedules_szn_all %>% 
      filter(location == "Neutral") %>% 
      left_join(
        stadium_coords_df %>% 
          select(-team),
        by = "stadium"
      ) %>% 
      mutate(
        lat = 
          case_when(
            is.na(lat) & game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lat), 
            game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lat), 
            .default = lat
          ),
        lon = 
          case_when(
            is.na(lon) & game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lon), 
            game_type == "REG" ~ stadium_coords_df %>% filter(stadium == "Wembley Stadium") %>% pull(lon), 
            .default = lon
          ),
        stadium_old = NA
      )
  ) %>% 
  drop_na(lat, lon) %>% 
  rename(
    game_lat = lat,
    game_lon = lon
  ) %>% 
  select(game_id, home_team, location, stadium, game_lat, game_lon) %>% 
  distinct()

team_coords_df = 
  games_coords_df %>%
  distinct(home_team, .keep_all = TRUE) %>%
  select(-game_id) %>% 
  rename(
    team = home_team,
    home_lat = game_lat, 
    home_lon = game_lon
  )

# Function to compute haversine distance (km)
haversine <- function(lat1, lon1, lat2, lon2) {
  R <- 6371  # km
  dlat <- (lat2 - lat1) * pi/180
  dlon <- (lon2 - lon1) * pi/180
  a <- sin(dlat/2)^2 + cos(lat1*pi/180) * cos(lat2*pi/180) * sin(dlon/2)^2
  c <- 2 * atan2(sqrt(a), sqrt(1-a))
  R * c
}

team_travel_df =
  szn_all_playoffs %>% 
  distinct(season, week, game_id, home_team, away_team) %>% 
  mutate(
    home_team = 
      case_when(
        season < 2017 & home_team == "LA" ~ "STL",
        season < 2017 & home_team == "LAC" ~ "SD",
        season < 2020 & home_team == "LV" ~ "OAK",
        .default = home_team
      ),
    away_team = 
      case_when(
        season < 2017 & away_team == "LA" ~ "STL",
        season < 2017 & away_team == "LAC" ~ "SD",
        season < 2020 & away_team == "LV" ~ "OAK",
        .default = away_team
      )
  ) %>% 
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  left_join(games_coords_df %>% select(game_id, location, stadium, game_lat, game_lon), by = "game_id") %>% 
  left_join(team_coords_df %>% select(-location), by = "team") %>% 
  mutate(
    travel_km = ifelse(home_away == "home" & location != "Neutral", 0, haversine(home_lat, home_lon, game_lat, game_lon)),
    team = 
      case_when(
        season < 2017 & team == "LA" ~ "STL",
        season < 2017 & team == "SD" ~ "LAC",
        season < 2020 & team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  select(season, week, team, game_id, travel_km)

# view(team_travel_df)

teams_df = 
  szn_all_playoffs %>% 
  tibble() %>% 
  distinct(home_team) %>% 
  rename(team = home_team) %>% 
  arrange(team) %>% 
  rowid_to_column("team_id")

division_df = 
  teams_df %>% 
  mutate(
    division = 
      case_match(
        team,
        c("BUF", "MIA", "NE", "NYJ") ~ "AFC East",
        c("PIT", "CIN", "BAL", "CLE") ~ "AFC North",
        c("IND", "JAX", "TEN", "HOU") ~ "AFC South",
        c("LAC", "KC", "DEN", "LV") ~ "AFC West",
        c("NYG", "DAL", "WAS", "PHI") ~ "NFC East",
        c("GB", "MIN", "CHI", "DET") ~ "NFC North",
        c("NO", "ATL", "CAR", "TB") ~ "NFC South",
        c("SF", "ARI", "SEA", "LA") ~ "NFC West"
      ),
    conf = str_extract(division, "^[A-Z]FC")
  )

playoffs_team_total_spread_rolling_df =
  szn_all_playoffs %>% 
  filter(season > 2008) %>% 
  distinct(season, week, game_id, home_team, away_team, total_line, total, spread_line, result, home_score, away_score) %>%
  left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
  left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
  mutate(division_game = ifelse(division_home == division_away, 1, 0)) %>%
  pivot_longer(
    ends_with("_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>% 
  mutate(home_away = str_remove(home_away, "_team$")) %>% 
  left_join(playoffs_rolling_epa_df, by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_pace_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_rz_eff_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_success_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_exp_plays_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_to_rate_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rolling_pen_yards_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_qb_cont_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(playoffs_rest_days_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  left_join(team_travel_df %>% select(-game_id), by = c("season", "week", "team")) %>% 
  select(season, week, game_id, team, total_line, total, spread_line, result, home_away, home_score, away_score, division_game, starts_with("prior_"), qb_cont, rest_days, travel_km) %>%
  mutate(
    travel_km = 
      case_when(
        travel_km == 0 ~ 0,
        .default = log(travel_km)
      ),
    total_team = 
      case_when(
        home_away == "home" ~ home_score,
        home_away == "away" ~ away_score,
        .default = NA
      )
  ) %>% 
  ungroup()

# view(team_total_spread_rolling_df)

field_game_df = 
  szn_all %>% 
  distinct(game_id, home_team, away_team, roof, surface, wind, temp, start_time, total) %>% 
  # pull(roof) %>% table(useNA = "ifany")
  mutate(
    time_start = 
      as.integer(str_remove(str_remove(str_extract(start_time, "\\d+:\\d+:\\d+$"), ":\\d+$"), ":")),
    international = ifelse(surface == "", 1, 0),
    enclosed_field = 
      case_when(
        roof %in% c("closed", "dome") ~ 1,
        roof %in% c("open", "outdoors") ~ 0,
        .default = NA
      ),
    turf_field = 
      case_when(
        str_detect(surface, "turf") | surface == "" | str_detect(surface, "astro") ~ 1,
        str_detect(surface, "grass") ~ 0, 
        .default = NA
      ),
    wind = 
      case_when(
        is.na(wind) & enclosed_field == 1 ~ 0,
        .default = wind
      ),
    temp = 
      case_when(
        is.na(temp) & enclosed_field == 1 ~ 72,
        .default = temp
      )
  ) %>% 
  # tbl_summary(by = turf_field, include = total) %>% add_p()
  # ggplot(aes(x = as.factor(turf_field), y = total)) + 
  # geom_boxplot()
  select(game_id, home_team, away_team, ends_with("_field"), international, time_start, wind, temp) %>%
  left_join(division_df %>% select(team, division) %>% rename(home_team = team, division_home = division), by = "home_team") %>%
  left_join(division_df %>% select(team, division) %>% rename(away_team = team, division_away = division), by = "away_team") %>% 
  mutate(division_game = ifelse(division_home == division_away, 1, 0))

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
ctrl2 = trainControl(method = "cv", number = 5)

playoffs_total_team_train_df =
  playoffs_team_total_spread_rolling_df %>% 
  left_join(
    playoffs_team_total_spread_rolling_df %>% 
      group_by(game_id) %>% 
      mutate(
        team_opp = 
          case_when(
            row_number() == 1 ~ lead(team),
            row_number() == 2 ~ lag(team),
            .default = NA
          )
      ) %>% 
      relocate(team_opp, .after = team) %>% 
      ungroup() %>% 
      select(game_id, team_opp, starts_with("prior_"), qb_cont, rest_days, travel_km) %>% 
      rename_with(~ str_c(., "_opp"), everything() & -c(game_id, team_opp)) %>% 
      rename(team = team_opp),
    by = c("game_id", "team")
  ) %>% 
  filter(season != 2025) %>% 
  left_join(
    szn_all_playoffs %>% 
      distinct(game_id, season_type),
    by = "game_id"
  ) %>% 
  filter(division_game == 1 | season_type == "POST") %>% 
  filter(qb_cont == 1 & qb_cont_opp == 1) %>% 
  select(total_team, starts_with("prior_"), rest_days, rest_days_opp, travel_km, travel_km_opp) %>% 
  drop_na()

# saveRDS(playoffs_total_team_train_df, "playoffs_total_team_train_df.rds")

# GLM
set.seed(37564)
mod_playoffs_total_team_glm = train(total_team ~ .,
                na.action = na.exclude, 
                data = playoffs_total_team_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_playoffs_total_team_glm

# ENET
set.seed(37564)
mod_playoffs_total_team_enet = train(total_team ~ .,
                 na.action = na.exclude, 
                 data = playoffs_total_team_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(#alpha = seq(0, 1, by = 0.2),
                                        alpha = 0,
                                        lambda = exp(seq(-2, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_playoffs_total_team_enet, highlight = T) + 
  ggtitle("ENET") +
  theme(plot.title = element_text(hjust = 0.5))
mod_playoffs_total_team_enet$bestTune
min(mod_playoffs_total_team_enet$results$RMSE)

# KNN
set.seed(37564)
mod_playoffs_total_team_knn = train(total_team ~ .,
                na.action = na.exclude, 
                data = playoffs_total_team_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(100, 130, by = 2)), 
                trControl = ctrl)
ggplot(mod_playoffs_total_team_knn, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_playoffs_total_team_knn$bestTune
min(mod_playoffs_total_team_knn$results$RMSE)

# MARS
set.seed(37564)
mod_playoffs_total_team_mars = train(total_team ~ .,
                 na.action = na.exclude, 
                 data = playoffs_total_team_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_playoffs_total_team_mars, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_playoffs_total_team_mars$bestTune
min(mod_playoffs_total_team_mars$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_playoffs_total_team_boost = train(total_team ~ .,
                  na.action = na.exclude, 
                  data = playoffs_total_team_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(1000, 4000, 7000),
                                         interaction.depth = 1:3,
                                         shrinkage = c(0.01, 0.03, 0.05), 
                                         n.minobsinnode = 10), 
                  trControl = ctrl2,
                  verbose = F)
ggplot(mod_playoffs_total_team_boost, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_playoffs_total_team_boost$bestTune
min(mod_playoffs_total_team_boost$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_playoffs_total_team_svm = train(total_team ~ .,
                na.action = na.exclude, 
                data = playoffs_total_team_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = #c(0.03877421, 0.08208500),
                                         exp(seq(-4, -1, len = 5)),
                                       sigma = #c(0.014264234, 0.030197383)),
                                         exp(seq(-5, -2, len = 5))),
                trControl = ctrl)
ggplot(mod_playoffs_total_team_svm, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_playoffs_total_team_svm$bestTune
min(mod_playoffs_total_team_svm$results$RMSE)

set.seed(37564)
vip(
  mod_playoffs_total_team_boost, 
  method = "permute", 
  train = playoffs_total_team_train_df,
  target = "total_team",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75),
  num_features = 40L
)

coef(mod_total_team_enet$finalModel, mod_total_team_enet$bestTune$lambda)

set.seed(37564)
res = resamples(list(GLM = mod_total_team_glm, ENET = mod_total_team_enet, MARS = mod_total_team_mars, KNN = mod_total_team_knn, BOOST = mod_total_team_boost, SVM = mod_total_team_svm))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

# save final SVM model:

# saveRDS(mod_playoffs_total_team_svm, glue::glue("mod_playoffs_total_team_svm_{format(Sys.Date(), '%Y_%m_%d')}.rds"))

```

## Fantasy

```{r 2025 fan}
week = 9
n_targets = week * 5
n_touches = round(week * 8, -1)
n_att = week * 20
n_rec = round(week * 3, -1)

wr_tar = 
  roster_all_df %>% 
  filter(season == 2025) %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2025, by = "receiver_id") %>% 
  filter(pass_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    targets = n()#,
    #mean_epa = mean(epa)
  ) %>% 
  filter(receiver %nin% NA) %>% 
  ungroup()

wr_epa = 
  roster_all_df %>% 
  filter(season == 2025) %>% 
  filter(position == "WR") %>% 
  mutate(receiver_id = gsis_id) %>% 
  select(receiver_id, position) %>% 
  inner_join(szn2025, by = "receiver_id") %>% 
  filter(complete_pass == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    epa = epa,
    mean_epa = mean(epa),
    med_epa = median(epa),
    n_rec = n()
  ) %>% 
  filter(receiver %nin% NA) %>% 
  ungroup() %>% 
  left_join(wr_tar) %>% 
  drop_na(targets) %>% 
  mutate(receiver = fct_reorder(receiver, epa, median))

wr_epa_cols = 
  wr_epa %>% 
  group_by(team_abbr, receiver) %>% 
  summarize(
    med_epa = median(epa)
  ) %>% 
  left_join(teams_colors_logos, by = "team_abbr") %>% 
  group_by(med_epa, team_abbr) %>% 
  mutate(receiver = fct_reorder(as.factor(receiver), med_epa)) %>% 
  arrange(med_epa) %>% 
  drop_na(receiver)

fantasy_df = 
  szn2025 %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(
    fpts = fantasy_points + 0.5 * receptions,
    fpts_ppr = fantasy_points + 1 * receptions
  ) %>% 
  rename(posteam = recent_team) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
    )

# WR
wr_rec = 
  szn2025 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
  )

wr_fpts = 
  fantasy_df %>% 
  group_by(posteam, player_name, player_id) %>% 
  mutate(targets = sum(targets)) %>% 
  filter(targets >= n_targets) %>% 
  left_join(wr_rec) %>% 
  inner_join(
    fast_scraper_roster(2025) %>% 
    filter(position == "WR") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, player_display_name, player_id, fpts, fpts_ppr, targets)

med_wr = 
  wr_fpts %>% 
  group_by(player_display_name, posteam, targets) %>% 
  summarize(med_pts = median(fpts)) %>%  
  arrange(-med_pts, -targets) %>% 
  rowid_to_column("rank") %>% 
  filter(rank <= 40) %>% 
  mutate(
    player_name_og = player_display_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts, targets) %>% 
  rename(player_display_name = player_name_og)
  
med_wr_ppr = 
  wr_fpts %>% 
  group_by(player_display_name, posteam, targets) %>% 
  summarize(med_pts = median(fpts_ppr)) %>%  
  arrange(-med_pts, -targets) %>% 
  rowid_to_column("rank") %>% 
  filter(rank <= 40) %>% 
  mutate(
    player_name_og = player_display_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts, targets) %>% 
  rename(player_display_name = player_name_og)

wr_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_wr, by = "posteam") %>% 
  # right_join(wr_fpts) %>% 
  group_by(med_pts, posteam) %>% 
  # mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts, targets) %>% 
  drop_na(player_display_name)

wr_fpts_ppr_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_wr_ppr, by = "posteam") %>% 
  # right_join(wr_fpts) %>% 
  group_by(med_pts, posteam) %>% 
  # mutate(player_name = fct_reorder(as.factor(player_name), med_pts)) %>% 
  arrange(med_pts, targets) %>% 
  drop_na(player_display_name)

fan_wr = 
  wr_fpts %>% 
  left_join(med_wr) %>% 
  drop_na() %>% 
  # mutate(rank_name = ) %>% 
  # left_join(wr_fpts_cols %>% select(player_display_name, team_color)) %>% 
  ggplot(aes(x = fpts, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = wr_fpts_cols$team_color, alpha = 0.75) +
  scale_color_identity() +
  labs(
    title = glue::glue("2025 WR PPG (Min. {n_targets} Targets)"), 
    x = "Fantasy PPG", 
    y = "WR"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

fan_wr_ppr = 
  wr_fpts %>% 
  left_join(med_wr_ppr) %>% 
  drop_na() %>% 
  # mutate(rank_name = ) %>% 
  # left_join(wr_fpts_cols %>% select(player_display_name, team_color)) %>% 
  ggplot(aes(x = fpts_ppr, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = wr_fpts_ppr_cols$team_color, alpha = 0.75) +
  scale_color_identity() +
  labs(
    title = glue::glue("2025 WR PPG (Min. {n_targets} Targets)"), 
    x = "PPR Fantasy PPG", 
    y = "WR"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

wr_mean_fpts = 
  wr_fpts %>% 
  group_by(posteam, player_name) %>% 
  mutate(sum_pts = sum(fpts), n_weeks = n()) %>% 
  distinct(posteam, player_name, sum_pts, targets, n_weeks) %>% 
  ungroup() %>% 
  mutate(
    mean_pts = sum_pts / n_weeks, 
    mean_tar = targets / n_weeks
  ) %>% 
  left_join(med_wr) %>% 
  filter(as.integer(str_extract(rank_name, "^[0-9]+")) <= 40)

# PPG by Targets

wr_fpts %>% 
  left_join(med_wr) %>% 
  drop_na() %>% 
  ungroup() %>% 
  group_by(posteam, player_name) %>% 
  mutate(n_weeks = n()) %>% 
  ungroup() %>% 
  distinct(posteam, player_name, med_pts, targets, n_weeks) %>% 
  mutate(tar_gm = targets / n_weeks) %>% 
  # left_join(wr_fpts_cols %>% select(player_name, team_color)) %>% 
  arrange(med_pts, player_name) %>% 
  ggplot(aes(x = tar_gm, y = med_pts)) +
  geom_point(color = wr_fpts_cols$team_color, alpha = 0.75, size = 3) +
  geom_text_repel(aes(label = player_name), alpha = 4) +
  geom_hline(yintercept = mean(wr_mean_fpts$mean_pts), color = "black", linetype = "dashed") + 
  geom_vline(xintercept = mean(wr_mean_fpts$mean_tar), color = "black", linetype = "dashed") + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = mean(wr_mean_fpts$mean_pts) - qnorm(0.975)*sd(wr_mean_fpts$mean_pts)/sqrt(length(wr_mean_fpts$mean_pts)), ymax = mean(wr_mean_fpts$mean_pts) + qnorm(0.975)*sd(wr_mean_fpts$mean_pts)/sqrt(length(wr_mean_fpts$mean_pts))), alpha = 0.005, fill = "yellow") + 
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = mean(wr_mean_fpts$mean_tar) - qnorm(0.975)*sd(wr_mean_fpts$mean_tar)/sqrt(length(wr_mean_fpts$mean_tar)), xmax = mean(wr_mean_fpts$mean_tar) + qnorm(0.975)*sd(wr_mean_fpts$mean_tar)/sqrt(length(wr_mean_fpts$mean_tar))), alpha = 0.005, fill = "yellow") + 
  scale_y_continuous(breaks = seq(0, 25, by = 5)) +
  # geom_smooth() +
  labs(
    title = "2025 WR Median Fantasy PPG vs Targets/Game (Min. 40 Targets)",
    x = "Targets/Game",
    y = "Median Fantasy PPG"
  ) + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.42)
  )

# Fantasy PPG and EPA
wr_fpts %>% 
  left_join(med_wr) %>% 
  drop_na() %>% 
  left_join(
    wr_epa %>% 
      distinct(team_abbr, receiver, mean_epa) %>% 
      rename(
        posteam = team_abbr,
        player_name = receiver
      ),
    by = c("posteam", "player_name")
  ) %>% 
  distinct(posteam, player_name, mean_epa, med_pts, targets) %>% 
  arrange(med_pts) %>% 
  ggplot(aes(x = mean_epa, y = med_pts)) +
  geom_point(aes(size = targets / 10), color = wr_fpts_cols$team_color, alpha = 0.75) +
  geom_text_repel(aes(label = player_name), alpha = 4) + 
  geom_smooth() +
  labs(
    title = "2025 WR Median Fantasy PPG vs EPA/Catch (Min. 40 Targets)",
    x = "Mean EPA/Catch",
    y = "Median Fantasy PPG"
  ) + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.42)
  )

# Fantasy PPG and EPA
wr_fpts %>% 
  left_join(med_wr) %>% 
  left_join(wr_adot) %>% 
  drop_na() %>% 
  left_join(
    wr_epa %>% 
      distinct(team_abbr, receiver, mean_epa) %>% 
      rename(
        posteam = team_abbr,
        player_name = receiver
      ),
    by = c("posteam", "player_name")
  ) %>% 
  distinct(posteam, player_name, adot, med_pts, targets) %>% 
  arrange(med_pts) %>% 
  ggplot(aes(x = adot, y = med_pts)) +
  geom_point(aes(size = targets / 10), color = wr_fpts_cols$team_color, alpha = 0.75) +
  geom_text_repel(aes(label = player_name), alpha = 4) + 
  geom_smooth() +
  labs(
    title = "2025 WR Median Fantasy PPG vs ADOT (Min. 40 Targets)",
    x = "ADOT",
    y = "Median Fantasy PPG"
  ) + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.42)
  )

# RB
rb_att = 
  szn2025 %>% 
  filter(rush_attempt == 1) %>% 
  group_by(posteam, rusher) %>% 
  summarize(n_att = n()) %>% 
  drop_na(rusher) %>% 
  rename(player_name = rusher) %>% 
  mutate(
    player_name = ifelse(player_name == "B.Robinson" & posteam == "ATL", "Bi.Robinson", player_name),
    player_name = ifelse(player_name == "B.Robinson" & posteam == "WAS", "Br.Robinson", player_name)
  )

rb_fpts = 
  fantasy_df %>% 
  group_by(player_id) %>% 
  mutate(n_rec = sum(receptions)) %>% 
  ungroup() %>% 
  left_join(rb_att) %>% 
  mutate(
    touches = n_att + n_rec
  ) %>% 
  filter(touches >= n_touches) %>% 
  inner_join(
    fast_scraper_roster(2025) %>% 
    filter(position == "RB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, player_display_name, fpts, fpts_ppr, touches)

med_rb = 
  rb_fpts %>% 
  group_by(player_display_name, posteam, touches) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts, -touches) %>% 
  rowid_to_column("rank") %>% 
  filter(rank <= 40) %>% 
  mutate(
    player_name_og = player_display_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts, touches) %>% 
  rename(player_display_name = player_name_og)

med_rb_ppr = 
  rb_fpts %>% 
  group_by(player_display_name, posteam, touches) %>% 
  summarize(med_pts = median(fpts_ppr)) %>% 
  arrange(-med_pts, -touches) %>% 
  rowid_to_column("rank") %>% 
  filter(rank <= 40) %>% 
  mutate(
    player_name_og = player_display_name,
    rank_og = rank
  ) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts, touches) %>% 
  rename(player_display_name = player_name_og)

# rb_fpts = 
#   rb_fpts %>% 
#   left_join(med_rb) %>% 
#   group_by(med_pts, posteam) %>% 
#   mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

rb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_rb, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_display_name = fct_reorder(as.factor(player_display_name), med_pts)) %>% 
  arrange(med_pts, touches) %>% 
  drop_na(player_display_name)

rb_fpts_ppr_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_rb_ppr, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_display_name = fct_reorder(as.factor(player_display_name), med_pts)) %>% 
  arrange(med_pts, touches) %>% 
  drop_na(player_display_name)

fan_rb = 
  rb_fpts %>% 
  left_join(med_rb) %>% 
  drop_na() %>% 
  ggplot(aes(x = fpts, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = rb_fpts_cols$team_color, alpha = 0.75) +
  labs(
    title = glue::glue("2025 RB PPG (Min. {n_touches} Touches)"), 
    x = "Fantasy PPG", 
    y = "RB"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

fan_rb_ppr = 
  rb_fpts %>% 
  left_join(med_rb_ppr) %>% 
  drop_na() %>% 
  ggplot(aes(x = fpts_ppr, y = fct_reorder(as.factor(rank_name), -rank_og))) +
  geom_boxplot(fill = rb_fpts_ppr_cols$team_color, alpha = 0.75) +
  labs(
    title = glue::glue("2025 RB PPG (Min. {n_touches} Touches)"),     
    x = "PPR Fantasy PPG", 
    y = "RB"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

# QB
qb_att = 
  szn2025 %>% 
  filter(pass_attempt == 1 & sack == 0) %>% 
  group_by(posteam, passer) %>% 
  summarize(n_att = n()) %>% 
  drop_na(passer) %>% 
  rename(player_name = passer)

qb_fpts = 
  fantasy_df %>% 
  left_join(qb_att) %>% 
  filter(n_att >= n_att) %>% 
  inner_join(
    fast_scraper_roster(2025) %>% 
    filter(position == "QB") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, player_display_name, fpts)

med_qb = 
  qb_fpts %>% 
  group_by(player_display_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  filter(rank <= 20) %>% 
  mutate(player_name_og = player_display_name) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_display_name = player_name_og)

qb_fpts = 
  qb_fpts %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

qb_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_qb) %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_display_name = fct_reorder(as.factor(player_display_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_display_name)

fan_qb = 
  qb_fpts %>% 
  drop_na() %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = qb_fpts_cols$team_color, alpha = 0.75) +
  labs(
    title = glue::glue("2025 QB PPG (Min. {n_att} Passing Attempts)"), 
    x = "Fantasy PPG", 
    y = "QB"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

# TE
te_rec = 
  szn2025 %>% 
  filter(complete_pass == 1) %>% 
  group_by(posteam, receiver) %>% 
  summarize(n_rec = n()) %>% 
  drop_na(receiver) %>% 
  rename(player_name = receiver)

te_fpts = 
  fantasy_df %>% 
  left_join(te_rec) %>% 
  filter(n_rec >= n_rec) %>% 
  inner_join(
    fast_scraper_roster(2025) %>% 
    filter(position == "TE") %>% 
    select(gsis_id),
      by = c("player_id" = "gsis_id")
  ) %>% 
  select(posteam, week, player_name, player_display_name, fpts, fpts_ppr)

med_te = 
  te_fpts %>% 
  group_by(player_display_name, posteam) %>% 
  summarize(med_pts = median(fpts)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_display_name) %>% 
  filter(rank <= 20) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_display_name = player_name_og)

med_te_ppr = 
  te_fpts %>% 
  group_by(player_display_name, posteam) %>% 
  summarize(med_pts = median(fpts_ppr)) %>% 
  arrange(-med_pts) %>% 
  rowid_to_column("rank") %>% 
  mutate(player_name_og = player_display_name) %>% 
  filter(rank <= 20) %>% 
  unite("rank_name", rank, player_display_name, sep = ". ") %>% 
  arrange(med_pts) %>% 
  rename(player_display_name = player_name_og)

# te_fpts = 
#   te_fpts %>% 
#   left_join(med_te) %>% 
#   group_by(med_pts, posteam) %>% 
#   mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts))

te_fpts_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_te, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_display_name = fct_reorder(as.factor(player_display_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_display_name)

te_fpts_ppr_cols = 
  teams_colors_logos %>% 
  mutate(posteam = team_abbr) %>% 
  left_join(med_te_ppr, by = "posteam") %>% 
  group_by(med_pts, posteam) %>% 
  mutate(player_display_name = fct_reorder(as.factor(player_display_name), med_pts)) %>% 
  arrange(med_pts) %>% 
  drop_na(player_display_name)

fan_te = 
  te_fpts %>% 
  left_join(med_te) %>% 
  group_by(med_pts, posteam) %>% 
  drop_na() %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts)) %>% 
  ggplot(aes(x = fpts, y = rank_name)) +
  geom_boxplot(fill = te_fpts_cols$team_color, alpha = 0.75) +
  labs(
    title = glue::glue("2025 TE PPG (Min. {n_rec} Receptions)"), 
    x = "Fantasy PPG", 
    y = "TE"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

fan_te_ppr = 
  te_fpts %>% 
  left_join(med_te_ppr) %>% 
  group_by(med_pts, posteam) %>% 
  drop_na() %>% 
  mutate(rank_name = fct_reorder(as.factor(rank_name), med_pts)) %>% 
  ggplot(aes(x = fpts_ppr, y = rank_name)) +
  geom_boxplot(fill = te_fpts_ppr_cols$team_color, alpha = 0.75) +
  labs(
    title = glue::glue("2025 TE PPG (Min. {n_rec} Receptions)"), 
    x = "PPR Fantasy PPG", 
    y = "TE"
  ) + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8)
  )

# fan_rb + fan_wr
# fan_qb + fan_te
(fan_rb + fan_wr) / (fan_qb + fan_te) + plot_layout(heights = c(0.65, 0.35))
(fan_rb_ppr + fan_wr_ppr) / (fan_qb + fan_te_ppr) + plot_layout(heights = c(0.65, 0.35))
```

# Fantasy Mods

## WR

### Get prior data

```{r get data}
games_missed_2025 = 
  szn_all %>% 
  filter(season <= 2024) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2025,
    years_exp = 2025 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2025 - 2021)) * 16 + (2025 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

# view(games_missed_2025)

games_missed_2024 = 
  szn_all %>% 
  filter(season <= 2023) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2024,
    years_exp = 2024 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2024 - 2021)) * 16 + (2024 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

view(games_missed_2024)

games_missed_2023 = 
  szn_all %>% 
  filter(season <= 2022) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2023,
    years_exp = 2023 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2023 - 2021)) * 16 + (2023 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2022 = 
  szn_all %>% 
  filter(season <= 2021) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2022,
    years_exp = 2022 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2022 - 2021)) * 16 + (2022 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2021 = 
  szn_all %>% 
  filter(season <= 2020) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2021,
    years_exp = 2021 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2021 - 2021)) * 16 + (2021 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2020 = 
  szn_all %>% 
  filter(season <= 2019) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2020,
    years_exp = 2020 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2019 = 
  szn_all %>% 
  filter(season <= 2018) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2019,
    years_exp = 2019 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2018 = 
  szn_all %>% 
  filter(season <= 2017) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2018,
    years_exp = 2018 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2017 = 
  szn_all %>% 
  filter(season <= 2016) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2017,
    years_exp = 2017 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_2016 = 
  szn_all %>% 
  filter(season <= 2015) %>% 
  calculate_player_stats() %>% 
  filter(position == "WR") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "WR") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2016,
    years_exp = 2016 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_all = 
  games_missed_2025 %>% 
  rbind(
    games_missed_2024,
    games_missed_2023,
    games_missed_2022,
    games_missed_2021,
    games_missed_2020,
    games_missed_2019,
    games_missed_2018,
    games_missed_2017,
    games_missed_2016
  )

view(games_missed_all)

fan_wr_all =
  szn_all %>% 
  filter(between(season, 2016, 2024)) %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5 * receptions) %>% 
  filter(position == "WR")

view(fan_wr_all)

roster_wr_all = 
  roster_all_df %>% 
  filter(between(season, 2016, 2025)) %>% 
  filter(position == "WR") %>% 
  rename(
    player_id = gsis_id
  )

view(roster_wr_all)

pass_rate_df =
  szn_all %>% 
  filter(between(season, 2016, 2025)) %>% 
  select(season, posteam, play_type) %>% 
  filter(play_type %in% c("pass", "run", "punt")) %>% 
  group_by(season, posteam, play_type) %>% 
  summarise(
    n_play = n()
  ) %>% 
  ungroup() %>% 
  group_by(season, posteam) %>% 
  mutate(
    prop_play = n_play / sum(n_play)
  ) %>% 
  ungroup() %>% 
  filter(play_type == "pass") %>% 
  rename(
    team = posteam,
    pass_rate = prop_play,
    n_pass = n_play
  ) %>% 
  mutate(
    n_pass = 
      case_when(
        season < 2021 ~ n_pass * 17 / 16,
        season >= 2021 ~ n_pass,
        .default = NA
      )
  ) %>% 
  select(-c(play_type)) %>% 
  rbind(
    tibble(
      season = 2025,
      team = szn_all %>% distinct(posteam) %>% drop_na() %>% pull(),
      pass_rate = NA,
      n_pass = NA
    )
  ) %>% 
  arrange(team, season) %>% 
  group_by(team) %>% 
  mutate(
    prior_pass_rate = lag(pass_rate),
    prior_n_pass = lag(n_pass)
  ) %>% 
  ungroup()

view(pass_rate_df)

qb_epa_df = 
  szn_all %>% 
  filter(between(season, 2016, 2025)) %>%
  filter(qb_dropback == 1) %>% 
  group_by(season, posteam, passer, passer_id) %>% 
  drop_na(epa) %>% 
  summarize(sum_epa = sum(qb_epa, na.rm = T)) %>% 
  ungroup() %>% 
  rename(player_id = passer_id) %>% 
  mutate(
    sum_fpts = 
       case_when(
         season < 2021 ~ sum_epa * 17 / 16,
         season >= 2021 ~ sum_epa,
         .default = NA
       )
  )

view(qb_epa_df)

qb_epa_teams_df = 
  roster_all_df %>% 
  filter(position == "QB") %>% 
  rename(player_id = gsis_id) %>% 
  left_join(qb_epa_df, by = c("player_id", "season")) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    prior_qb_epa = lag(sum_epa)
  ) %>% 
  ungroup() %>% 
  group_by(season, team) %>% 
  mutate(
    prior_qb_epa = ifelse(rookie_year == season, 0, prior_qb_epa)
  ) %>% 
  arrange(season, team, desc(prior_qb_epa)) %>% 
  slice(1) %>% 
  # filter(prior_qb_epa == max(prior_qb_epa, na.rm = T)) %>% 
  ungroup() %>% 
  drop_na(prior_qb_epa) %>% 
  filter(season != 2016) %>% 
  group_by(player_id) %>% 
  arrange(player_id, season) %>% 
  mutate(
    qb_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      )
  ) %>% 
  ungroup() %>% 
  select(season, team, prior_qb_epa, qb_new_team) %>% 
  left_join(
    pass_rate_df %>% 
      select(season, team, prior_n_pass),
    by = c("season", "team")
  )
  
view(qb_epa_teams_df)

fan_wr_season_finish = 
  fan_wr_all %>% 
  group_by(season, player_id) %>% 
  summarise(
    fpts_total = sum(fpts)
  ) %>% 
  ungroup() %>% 
  mutate(
    fpts_total = 
      case_when(
        season < 2021 ~ fpts_total * 17 / 16,
        season >= 2021 ~ fpts_total,
        .default = NA
      )
  ) %>% 
  group_by(season) %>% 
  arrange(season, desc(fpts_total)) %>% 
  drop_na() %>% 
  mutate(
    season_rank = row_number(),
    season_finish = 
      factor(
        case_when(
          between(season_rank, 1, 20) ~ "Top 20",
          between(season_rank, 21, 50) ~ "21 - 50",
          season_rank > 50 ~ "Over 50",
          .default = NA
        ),
        levels = c("Top 20", "21 - 50", "Over 50")
      )
  ) %>% 
  ungroup()
  
view(fan_wr_season_finish)

fan_wr_fin_all =
  fan_wr_all %>% 
  filter(between(season, 2016, 2025)) %>% 
  select(season, recent_team, position, player_id, player_display_name, receptions, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
  group_by(season, player_id, player_display_name, position) %>% 
  mutate(
    games_missed = 
      case_when(
        season < 2021 ~ 16 - n(),
        season >= 2021 ~ 17 - n()
      ),
    sum_yards = sum(receiving_yards, na.rm = T),
    sum_rec = sum(receptions, na.rm = T),
    sum_fpts = 
      case_when(
        season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
        season >= 2021 ~ sum(fpts, na.rm = T),
        .default = NA
      ),
    mean_racr = mean(racr, na.rm = T),
    mean_air_yards_share = mean(air_yards_share, na.rm = T),
    mean_target_share = mean(target_share, na.rm = T)
  ) %>% 
  ungroup() %>% 
  select(season, player_id, player_display_name, position, starts_with("sum_"), starts_with("mean_"), games_missed) %>% 
  distinct() %>% 
  # group_by(season) %>% 
  # mutate(season_rank = rank(desc(sum_fpts))) %>% 
  # ungroup() %>% 
  left_join(
    roster_wr_all %>% 
      select(season, player_id, team, birth_date, years_exp, draft_number) %>% 
      mutate(draft_number = replace_na(draft_number, 260)),
    by = c("season", "player_id")
  ) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    across(
      c(games_missed, mean_air_yards_share, mean_target_share, sum_fpts),
      ~ lag(.),
      .names = "prior_{col}"
    ),
    wr_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      ),
    new_qb_new_team = 
      case_when(
        qb_new_team == 1 | wr_new_team == 1 ~ 1,
        .default = 0
      )
  ) %>% 
  rename(
    prior_ays = prior_mean_air_yards_share,
    prior_tar_share = prior_mean_target_share,
    prior_fpts = prior_sum_fpts
  ) %>%
  ungroup() %>% 
  left_join(
    roster_wr_all %>% 
      left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, prior_fpts_other, prior_rank),
    by = c("player_id", "season")
  ) %>% 
  left_join(games_missed_all, by = c("player_id", "season")) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 & sum_fpts >= 100) | (is.na(prior_rank))) %>% 
  filter(prior_rank <= 100 | (is.na(prior_rank)))

view(fan_wr_fin_all)
  
# roster_wr_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
#   select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
#   mutate(
#     ind_top_20 = ifelse(season_rank <= 20, 1, 0)
#   ) %>% 
#   group_by(player_id) %>% 
#   arrange(player_id, season) %>% 
#   mutate(
#     prior_ind_top_20 = lag(ind_top_20),
#     prior_fpts = lag(fpts_total)
#   ) %>% 
#   ungroup() %>% 
#   group_by(season, team) %>% 
#   arrange(season, team) %>% 
#   filter(season != 2016) %>% 
#   mutate(
#     top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
#     prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
#   )
# 
# fan_wr_fin_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% view

# fan2023 = 
#   szn_all %>% 
#   filter(season == 2023) %>% 
#   calculate_player_stats(weekly = T) %>% 
#   mutate(fpts = fantasy_points + 0.5 * receptions)

# 
# roster2023 = 
#   fast_scraper_roster(2023)
# 
# view(roster2023)

# try to predict 2023 from 2022:

# view(fan2022)

# get players who switched teams:
# fan2022 %>% 
#   filter(position == "WR") %>% 
#   select(recent_team, position, player_id, player_name, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   # group_by(player_id, player_name, recent_team, position) %>% 
#   select(player_id, player_name, recent_team, position) %>% 
#   distinct() %>% 
#   group_by(player_id) %>% 
#   filter(n() > 1)
```

### Train models

```{r wr team prior}
load("mod_df_as_of_2023.Rdata")
load("coach_df_as_of_2025.Rdata")

fpts_wr_train_df = 
  fan_wr_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, sum_fpts, prior_ays, prior_tar_share, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team, games_missed_rate) %>% 
  select(-c(prior_qb_epa, coach_exp_off)) %>%
  drop_na() %>% 
  arrange(player_id) %>% 
  select(-player_id)

view(fpts_wr_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_wr = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_wr

# Lasso
set.seed(37564)
mod_lass_wr = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_wr_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-3, 1, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_wr, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_wr$bestTune
min(mod_lass_wr$results$RMSE)

# KNN
set.seed(37564)
mod_knn_wr = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(24, 68, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_wr, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_wr$bestTune
min(mod_knn_wr$results$RMSE)

# MARS
set.seed(37564)
mod_mars_wr = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_wr_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_wr, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_wr$bestTune
min(mod_mars_wr$results$RMSE)
#mod_mars_wr$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_wr = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_wr_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(11000, 13000, 15000),
                                         interaction.depth = c(1),
                                         shrinkage = c(0.0003, 0.0005, 0.0007),
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_wr, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_wr$bestTune
min(mod_boost_wr$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_wr = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-2, 0, len = 5)),
                                       sigma = exp(seq(-4,-2, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_wr, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_wr$bestTune
min(mod_svm_wr$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_wr, 
  method = "permute", 
  train = fpts_wr_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_wr$finalModel, mod_lass_wr$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_wr, LASSO = mod_lass_wr, MARS = mod_mars_wr, KNN = mod_knn_wr, BOOST = mod_boost_wr, SVM = mod_svm_wr))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

mod_errors = 
  tibble(
    resid_glm = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_glm_wr, newdata = fpts_wr_train_df)),
    resid_knn = fpts_wr_train_df$sum_fpts - predict(mod_knn_wr, newdata = fpts_wr_train_df),
    resid_lasso = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_lass_wr, newdata = fpts_wr_train_df)),
    resid_mars = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_mars_wr, newdata = fpts_wr_train_df)),
    resid_boost = fpts_wr_train_df$sum_fpts - predict(mod_boost_wr, newdata = fpts_wr_train_df),
    resid_svm = fpts_wr_train_df$sum_fpts - predict(mod_svm_wr, newdata = fpts_wr_train_df)
  )

corrplot(cor(mod_errors, use = "complete.obs"), diag = F, method = "shade", type = "lower")

# mod_glm_wr$finalModel$residuals %>% as.vector()




# fpts_wr_test_df = 
#   fan2023 %>% 
#   filter(position == "WR") %>% 
#   select(season, recent_team, position, player_id, player_display_name, receptions, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   group_by(season, player_id, player_display_name, position) %>% 
#   summarise(
#     sum_fpts = sum(fpts, na.rm = T)
#   ) %>% 
#   ungroup() %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       filter(position == "WR") %>% 
#       select(player_id, team, birth_date, years_exp),
#     by = "player_id"
#   ) %>% 
#   drop_na(team) %>% 
#   filter(player_id %in% c(fpts_wr_train_df %>% pull(player_id)))
# 
# players_diff = setdiff(fpts_wr_test_df$player_id, fpts_wr_train_df$player_id)
# 
# roster2023 %>% filter(gsis_id %in% c(players_diff)) %>% view
# 
# fpts_wr_train_df %>% 
#   cbind(
#     pred_fpts_glm = predict(mod_glm),
#     pred_fpts_lasso = predict(mod_lass),
#     pred_fpts_knn = predict(mod_knn),
#     pred_fpts_mars = predict(mod_mars),
#     pred_fpts_boost = predict(mod_boost)#,
#     #pred_fpts_svm = predict(mod_svm)
#   ) %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       select(player_id, full_name),
#     by = "player_id"
#   ) %>% 
#   view

```

### Make model for rookies

```{r wr rookie}
fpts_wr_rookie_train_df =
  roster_wr_all %>% 
  filter(rookie_year == season) %>% 
  select(season, player_id, full_name, team, birth_date, draft_number) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  left_join(
    fan_wr_all %>% 
      select(season, position, player_id, player_display_name, fpts) %>% 
      group_by(season, player_id, player_display_name, position) %>% 
      mutate(
        sum_fpts = 
          case_when(
            season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
            season >= 2021 ~ sum(fpts, na.rm = T),
            .default = NA
          )
      ) %>% 
      ungroup() %>% 
      select(season, player_id, sum_fpts) %>% 
      distinct(),
    by = c("season", "player_id")
  ) %>% 
  left_join(
    roster_wr_all %>% 
      left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct(),
    by = c("season", "team")
  ) %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>%
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  select(player_id, sum_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na() %>% 
  arrange(player_id) %>%
  select(-player_id)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_wr_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_rookie_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_wr_rook

# Lasso
set.seed(37564)
mod_lass_wr_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_wr_rookie_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-1, 3, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_wr_rook, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_wr_rook$bestTune
min(mod_lass_wr_rook$results$RMSE)

# KNN
set.seed(37564)
mod_knn_wr_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_rookie_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(20, 40, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_wr_rook, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_wr_rook$bestTune
min(mod_knn_wr_rook$results$RMSE)

# MARS
set.seed(37564)
mod_mars_wr_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_wr_rookie_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_wr_rook, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_wr_rook$bestTune
min(mod_mars_wr_rook$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_wr_rook = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_wr_rookie_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(5000, 7000, 9000),
                                         interaction.depth = 1,
                                         shrinkage = c(0.0003, 0.0005, 0.0007), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_wr_rook, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_wr_rook$bestTune
min(mod_boost_wr_rook$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_wr_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_wr_rookie_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-2, 2, len = 5)),
                                       sigma = exp(seq(-5,-1, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_wr_rook, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_wr_rook$bestTune
min(mod_svm_wr_rook$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_wr_rook, 
  method = "permute", 
  train = fpts_wr_rookie_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_wr_rook$finalModel, mod_lass_wr_rook$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_wr_rook, LASSO = mod_lass_wr_rook, MARS = mod_mars_wr_rook, KNN = mod_knn_wr_rook, BOOST = mod_boost_wr_rook, SVM = mod_svm_wr_rook))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")
```

### Run model on test data

```{r pred test}
fpts_wr_test_df =
  roster_wr_all %>% 
  filter(season %in% c(2024, 2025)) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    wr_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      ),
    draft_number = replace_na(as.integer(draft_number), 260)
  ) %>% 
  ungroup() %>% 
  filter(season %in% 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  left_join(
    fan_wr_fin_all %>% 
      filter(season == 2024) %>% 
      select(player_id, mean_air_yards_share, mean_target_share, sum_fpts, games_missed) %>% 
      rename(
        prior_games_missed = games_missed,
        prior_ays = mean_air_yards_share,
        prior_tar_share = mean_target_share,
        prior_fpts = sum_fpts
      ),
    by = "player_id"
  ) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_qb_epa, qb_new_team, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_wr_all %>% 
      left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, team, prior_fpts_other, prior_rank) %>% 
      filter(season == 2025),
    by = c("season", "player_id", "team")
  ) %>% 
  left_join(
    coach_df %>% 
      filter(season == 2025) %>% 
      select(season, team, coach_exp_off),
    by = c("season", "team")
  ) %>% 
  mutate(
    new_qb_new_team = 
      case_when(
        qb_new_team == 1 | wr_new_team == 1 ~ 1,
        .default = 0
      )
  ) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 | (is.na(prior_rank)))) %>% 
  left_join(games_missed_all, by = c("player_id", "season")) %>% 
  filter(prior_rank <= 100 | is.na(prior_rank)) %>% 
  select(player_id, full_name, team, prior_ays, prior_tar_share, games_missed_rate, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team) %>% 
  select(-c(prior_qb_epa, coach_exp_off)) %>% 
  drop_na()

view(fpts_wr_test_df)

fpts_wr_rookie_test_df = 
  roster_wr_all %>% 
  filter(rookie_year == 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_qb_epa, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_wr_all %>% 
      left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct() %>% 
      filter(season == 2025),
    by = c("season", "team")
  ) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>% 
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  select(player_id, full_name, team, prior_qb_epa, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na()

view(fpts_wr_rookie_test_df)

fpts_wr_2025 = 
  fpts_wr_test_df %>% 
  mutate(
    pred_fpts_mars = predict(mod_mars_wr, newdata = fpts_wr_test_df)[, 1],
    pred_fpts_boost = predict(mod_boost_wr, newdata = fpts_wr_test_df),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_svm = predict(mod_svm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
  mutate(
    cohort = "Non-Rookie"
  ) %>% 
  rbind(
    fpts_wr_rookie_test_df %>%
      mutate(
        pred_fpts_mars = predict(mod_mars_wr_rook, newdata = fpts_wr_rookie_test_df)[, 1],
        pred_fpts_boost = predict(mod_boost_wr_rook, newdata = fpts_wr_rookie_test_df),
        pred_fpts_svm = predict(mod_svm_wr_rook, newdata = fpts_wr_rookie_test_df)
      ) %>%
      select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
      mutate(
        cohort = "Rookie"
      )
  ) %>%
  mutate(
    pred_fpts_mars = round(pred_fpts_mars, 2),
    pred_fpts_boost = round(pred_fpts_boost, 2),
    pred_fpts_svm = round(pred_fpts_svm, 2),
    pred_fpts_fin_mod = 
      case_when(
        cohort == "Rookie" ~ pred_fpts_mars,
        cohort == "Non-Rookie" ~ pred_fpts_svm,
        .default = NA
      )
  ) %>% 
  arrange(-pred_fpts_fin_mod) %>% 
  rowid_to_column("wr_rank")

view(fpts_wr_2025)

# check mods w/ last year's data:
fan_wr_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  filter(season == 2024) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, team, player_display_name, sum_fpts, prior_ays, prior_tar_share, games_missed_rate, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team) %>% 
  select(-c(prior_qb_epa, coach_exp_off)) %>% 
  drop_na() %>% 
  arrange(player_id) %>% 
  mutate(
    pred_fpts_mars = predict(mod_mars_wr, newdata = .)[, 1],
    pred_fpts_boost = predict(mod_boost_wr, newdata = .),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_svm = predict(mod_svm_wr, newdata = .),
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, player_display_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
  # rbind(
  #   fpts_wr_rookie_test_df %>% 
  #     mutate(
  #       pred_fpts_mars = predict(mod_mars_wr_rook, newdata = fpts_wr_rookie_test_df)[, 1]
  #     ) %>% 
  #     select(team, full_name, pred_fpts_mars)
  # ) %>% 
  mutate(
    pred_fpts_mars = round(pred_fpts_mars, 2),
    pred_fpts_boost = round(pred_fpts_boost, 2),
    pred_fpts_svm = round(pred_fpts_svm, 2)
  ) %>% 
  arrange(-pred_fpts_svm) %>% 
  rowid_to_column("wr_rank") %>% 
  view

# write.csv(fpts_wr_2024, "fpts_wr_2024.csv", row.names = F)

set.seed(37564)
boot_splits = bootstraps(fpts_wr_train_df, times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    sum_fpts ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_svm_wr$bestTune[[1]],
      C = mod_svm_wr$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = fpts_wr_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
wr_boot_pred_bands = 
  fpts_wr_test_df %>%
  select(player_id, full_name) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(wr_boot_pred_bands)

set.seed(37564)
boot_splits_rook = bootstraps(fpts_wr_rookie_train_df, times = 100)

# Fit model to each resample and generate predictions
boot_preds_rook = 
  boot_splits_rook %>%
  mutate(
    preds = 
      map(
        splits, 
        ~ {
          model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_wr_rook$bestTune[[1]], degree = mod_mars_wr_rook$bestTune[[2]])
    predict(model, fpts_wr_rookie_test_df)
      }
    )
  )

# Convert predictions into long-format tibble
wr_boot_pred_bands_rook = 
  boot_preds_rook %>%
  select(preds) %>%
  unnest_longer(preds, indices_to = "player_index") %>%
  group_by(player_index) %>%
  summarise(
    pred_mean = mean(preds),
    pred_lower = quantile(preds, 0.10),
    pred_upper = quantile(preds, 0.90),
    .groups = "drop"
  ) %>%
  mutate(
    full_name = fpts_wr_rookie_test_df$full_name[player_index],
    player_id = fpts_wr_rookie_test_df$player_id[player_index],
    across(c(pred_mean, pred_lower, pred_upper), ~ round(., 2))
  ) %>%
  select(player_id, full_name, pred_mean, pred_lower, pred_upper)

view(wr_boot_pred_bands_rook)

fpts_wr_2025_fin_rank = 
  fpts_wr_2025 %>% 
  left_join(
    wr_boot_pred_bands %>% 
      rbind(wr_boot_pred_bands_rook), 
    by = c("player_id", "full_name")
  )

view(fpts_wr_2025_fin_rank)

fpts_wr_2025_fin_rank %>% 
  left_join(
    teams_colors_logos %>% 
      rename(team = team_abbr) %>% 
      select(team, team_color), 
    by = "team"
  ) %>% 
  filter(wr_rank <= 70) %>% 
  ggplot(aes(y = reorder(full_name, pred_fpts_fin_mod), x = pred_fpts_fin_mod)) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper, color = team_color), height = 1) +
  geom_point(aes(color = team_color), size = 2.4) +
  geom_text(aes(label = full_name, x = pred_upper + 1, color = team_color), hjust = 0, size = 3.15)+
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(0, 300, by = 25)) +
  labs(
    x = "Predicted Fantasy Points (0.5 PPR)",
    y = NULL,
    title = "WR Fantasy Point Predictions with 80% Confidence Bands"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(55, 245)
  )

# exporting rankings:

fpts_wr_2025_fin_rank_export = 
  fpts_wr_2025_fin_rank %>% 
  select(wr_rank, team, full_name, pred_fpts_fin_mod, pred_lower, pred_upper, cohort)# %>% 
  # mutate(
  #   pt_diff = pred_fpts_fin_mod - lag(pred_fpts_fin_mod),
  #   tier_init = ifelse(is.na(pt_diff) | pt_diff < -5, 1, 0)
  # )

write.csv(fpts_wr_2025_fin_rank_export, glue::glue("fpts_wr_2025_fin_rank_{format(Sys.Date(), '%Y_%m_%d')}.csv"), row.names = F)

# 
# # 1. Create 100 bootstrap samples
# set.seed(37564)
# boot_splits = bootstraps(fpts_wr_train_df, times = 100)
# 
# # 2. Predict for each bootstrap model
# boot_preds = map(boot_splits$splits, ~{
#   train_data = analysis(.x)
# 
#   # Fit GBM (tune params as needed)
#   model <- gbm(
#     formula = sum_fpts ~ .,
#     data = train_data,
#     distribution = "gaussian",
#     n.trees = mod_boost_wr$bestTune[[1]],
#     interaction.depth = mod_boost_wr$bestTune[[2]],
#     shrinkage = mod_boost_wr$bestTune[[3]],
#     # bag.fraction = 0.5,
#     # train.fraction = 1.0,
#     verbose = FALSE
#   )
# 
#   # Predict on same test set each time
#   predict(model, newdata = fpts_wr_test_df, n.trees = mod_boost_wr$bestTune[[1]])
# })
# 
# # 3. Combine predictions into a matrix
# pred_matrix = do.call(cbind, boot_preds)
# 
# # 4. Compute mean prediction and 95% prediction interval
# wr_boot_pred_bands = 
#   fpts_wr_test_df %>%
#   select(player_id, full_name) %>%
#   mutate(
#     pred_mean  = round(rowMeans(pred_matrix), 2), 
#     pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
#     pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
#   )
# 
# view(wr_boot_pred_bands)
# 
# fpts_wr_2025 %>% 
#   left_join(wr_boot_pred_bands, by = c("player_id", "full_name")) %>% 
#   select(-c(player_id, pred_mean)) %>% 
#   view
# 
# 
# 
# set.seed(37564)
# boot_splits = bootstraps(fpts_wr_train_df, times = 100)
# 
# # Fit model to each resample and generate predictions
# boot_preds = 
#   boot_splits %>%
#   mutate(
#     preds = 
#       map(
#         splits, 
#         ~ {
#           model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_wr$bestTune[[1]], degree = mod_mars_wr$bestTune[[2]])
#     predict(model, fpts_wr_test_df)
#       }
#     )
#   )
# 
# # Convert predictions into long-format tibble
# wr_boot_pred_bands = 
#   boot_preds %>%
#   select(preds) %>%
#   unnest_longer(preds, indices_to = "player_index") %>%
#   group_by(player_index) %>%
#   summarise(
#     pred_mean = mean(preds),
#     lower_band = quantile(preds, 0.10),
#     upper_band = quantile(preds, 0.90),
#     .groups = "drop"
#   ) %>%
#   mutate(
#     full_name = fpts_wr_test_df$full_name[player_index],
#     player_id = fpts_wr_test_df$player_id[player_index],
#     across(c(pred_mean, lower_band, upper_band), ~ round(., 2))
#   ) %>%
#   select(player_id, full_name, pred_mean, lower_band, upper_band)
# 
# view(wr_boot_pred_bands)
```

## RB

### Get prior data

```{r get data rb}
games_missed_rb_2025 = 
  szn_all %>% 
  filter(season <= 2024) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2025,
    years_exp = 2025 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2025 - 2021)) * 16 + (2025 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

# view(games_missed_rb_2025)

games_missed_rb_2024 = 
  szn_all %>% 
  filter(season <= 2023) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2024,
    years_exp = 2024 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2024 - 2021)) * 16 + (2024 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2023 = 
  szn_all %>% 
  filter(season <= 2022) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2023,
    years_exp = 2023 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2023 - 2021)) * 16 + (2023 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2022 = 
  szn_all %>% 
  filter(season <= 2021) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2022,
    years_exp = 2022 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2022 - 2021)) * 16 + (2022 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2021 = 
  szn_all %>% 
  filter(season <= 2020) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2021,
    years_exp = 2021 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2021 - 2021)) * 16 + (2021 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2020 = 
  szn_all %>% 
  filter(season <= 2019) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2020,
    years_exp = 2020 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2019 = 
  szn_all %>% 
  filter(season <= 2018) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2019,
    years_exp = 2019 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2018 = 
  szn_all %>% 
  filter(season <= 2017) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2018,
    years_exp = 2018 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2017 = 
  szn_all %>% 
  filter(season <= 2016) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2017,
    years_exp = 2017 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_2016 = 
  szn_all %>% 
  filter(season <= 2015) %>% 
  calculate_player_stats() %>% 
  filter(position == "RB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "RB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2016,
    years_exp = 2016 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_rb_all = 
  games_missed_rb_2025 %>% 
  rbind(
    games_missed_rb_2024,
    games_missed_rb_2023,
    games_missed_rb_2022,
    games_missed_rb_2021,
    games_missed_rb_2020,
    games_missed_rb_2019,
    games_missed_rb_2018,
    games_missed_rb_2017,
    games_missed_rb_2016
  )

view(games_missed_all)

fan_rb_all = 
  szn_all %>% 
  filter(between(season, 2016, 2024)) %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5 * receptions) %>% 
  filter(position == "RB")

view(fan_rb_all)

roster_rb_all = 
  roster_all_df %>% 
  filter(between(season, 2016, 2025)) %>% 
  filter(position == "RB") %>% 
  rename(
    player_id = gsis_id
  ) %>% 
  mutate(
    full_name = 
      case_when(
        season == 2024 & full_name == "Kenneth Walker III" ~ "Kenneth Walker",
        season == 2024 & full_name == "Tyrone Tracy Jr." ~ "Tyrone Tracy",
        .default = full_name
      )
  )

view(roster_rb_all)

df_ryoe_tjesh = 
  read.csv("ryoe_github.csv") %>% 
  janitor::clean_names() %>% 
  tibble() %>% 
  filter(season %in% c(2016, 2017)) %>% 
  group_by(season, player) %>% 
  summarise(
    n_att = n(),
    ryoe = sum(ryoe),
    ryoe_att = ryoe / n_att
  ) %>% 
  filter(n_att >= 80) %>% 
  rename(player_name = player)

df_ryoe_all = 
  read_xlsx("rb_next_gen_stats.xlsx", sheet = "2024") %>% 
  mutate(season = 2024) %>% 
  rbind(
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2023") %>% mutate(season = 2023),
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2022") %>% mutate(season = 2022),
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2021") %>% mutate(season = 2021),
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2020") %>% mutate(season = 2020),
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2019") %>% mutate(season = 2019),
    read_xlsx("rb_next_gen_stats.xlsx", sheet = "2018") %>% mutate(season = 2018)
  ) %>% 
  janitor::clean_names() %>% 
  rename(
    n_att = att
  ) %>% 
  select(season, player_name, n_att, ryoe, ryoe_att) %>% 
  rbind(
    df_ryoe_tjesh
  ) %>% 
  mutate(
    player_name = 
      case_when(
        player_name == "Mark Ingram II" ~ "Mark Ingram",
        player_name == "Melvin Gordon III" ~ "Melvin Gordon",
        player_name == "Todd Gurley II" ~ "Todd Gurley",
        player_name == "Devon Achane" ~ "De'Von Achane",
        .default = player_name
      ),
    player_name = ifelse(season == 2023 & player_name == "A.J. Dillon", "AJ Dillon", player_name)
  ) %>% 
  rename(full_name = player_name) %>% 
  left_join(roster_rb_all %>% select(season, full_name, player_id), by = c("season", "full_name"))

view(df_ryoe_all)

rb_epa_df = 
  szn_all %>% 
  filter(between(season, 2016, 2024)) %>% 
  # roster_rb_all %>% 
  # filter(position == "RB") %>% 
  # rename(rusher_id = player_id) %>% 
  # left_join(szn_all, by = "rusher_id") %>% 
  filter(rush_attempt == 1) %>% 
  rename(team_abbr = posteam) %>% 
  group_by(season, rusher_id) %>% 
  summarize(
    mean_epa = mean(epa),
    # med_epa = median(epa),
    n_rush = n()
  ) %>% 
  filter(rusher_id %nin% NA & n_rush >= 80) %>% 
  ungroup()

view(rb_epa_df)

rush_rate_df =
  szn_all %>% 
  filter(between(season, 2016, 2025)) %>% 
  select(season, posteam, play_type, qb_scramble) %>% 
  filter(play_type %in% c("pass", "run", "punt") & qb_scramble != 1) %>% 
  group_by(season, posteam, play_type) %>% 
  summarise(
    n_play = n()
  ) %>% 
  ungroup() %>% 
  group_by(season, posteam) %>% 
  mutate(
    prop_play = n_play / sum(n_play)
  ) %>% 
  ungroup() %>% 
  filter(play_type == "run") %>% 
  rename(
    team = posteam,
    rush_rate = prop_play,
    n_rush = n_play
  ) %>% 
  mutate(
    n_rush = 
      case_when(
        season < 2021 ~ n_rush * 17 / 16,
        season >= 2021 ~ n_rush,
        .default = NA
      )
  ) %>% 
  select(-c(play_type)) %>% 
  rbind(
    tibble(
      season = 2025,
      team = szn_all %>% distinct(posteam) %>% drop_na() %>% pull(),
      rush_rate = NA,
      n_rush = NA
    )
  ) %>% 
  arrange(team, season) %>% 
  group_by(team) %>% 
  mutate(
    prior_rush_rate = lag(rush_rate),
    prior_n_rush = lag(n_rush)
  ) %>% 
  ungroup()

view(rush_rate_df)

rb_new_team_df = 
  roster_all_df %>% 
  filter(position == "RB") %>% 
  rename(player_id = gsis_id) %>% 
  # filter(season != 2016) %>% 
  group_by(player_id) %>% 
  arrange(player_id, season) %>% 
  mutate(
    rb_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      )
  ) %>% 
  ungroup() %>% 
  select(season, team, player_id, rb_new_team)

fan_rb_season_finish = 
  fan_rb_all %>% 
  group_by(season, player_id) %>% 
  summarise(
    fpts_total = sum(fpts)
  ) %>% 
  ungroup() %>% 
  mutate(
    fpts_total = 
      case_when(
        season < 2021 ~ fpts_total * 17 / 16,
        season >= 2021 ~ fpts_total,
        .default = NA
      )
  ) %>% 
  group_by(season) %>% 
  arrange(season, desc(fpts_total)) %>% 
  drop_na() %>% 
  mutate(
    season_rank = row_number(),
    season_finish = 
      factor(
        case_when(
          between(season_rank, 1, 20) ~ "Top 20",
          between(season_rank, 21, 50) ~ "21 - 50",
          season_rank > 50 ~ "Over 50",
          .default = NA
        ),
        levels = c("Top 20", "21 - 50", "Over 50")
      )
  ) %>% 
  ungroup()
  
view(fan_rb_season_finish)

# route_data_all = 
#   load_participation(seasons = c(2016:2024))

rb_gl_rate_df = 
  roster_rb_all %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(rush == 1 & yardline_100 <= 5 & !is.na(rusher_player_id)) %>% 
        rename(player_id = rusher_player_id) %>% 
        group_by(player_id, season) %>% 
        summarise(
          n_gl_att = n()
        ) %>% 
        ungroup(),
      by = c("player_id", "season")
    ) %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(rush == 1 & yardline_100 <= 5 & !is.na(rusher_player_id)) %>% 
        rename(team = posteam) %>% 
        group_by(team, season) %>% 
        summarise(
          n_gl_att_team = n()
        ) %>% 
        ungroup(),
      by = c("season", "team")
    ) %>% 
    group_by(player_id) %>% 
    arrange(player_id, season) %>% 
    mutate(
      gl_rate = n_gl_att / n_gl_att_team,
      prior_gl_rate = lag(gl_rate)
    ) %>% 
    ungroup() %>% 
    select(season, player_id, prior_gl_rate)
  
fan_rb_fin_all = 
  fan_rb_all %>% 
  select(season, recent_team, position, player_id, player_display_name, fpts, target_share) %>% 
  group_by(season, player_id, player_display_name, position) %>% 
  mutate(
    games_missed = 
      case_when(
        season < 2021 ~ 16 - n(),
        season >= 2021 ~ 17 - n()
      ),
    sum_fpts = sum(fpts, na.rm = T),
    mean_target_share = mean(target_share, na.rm = T)
  ) %>% 
  ungroup() %>% 
  select(season, player_id, player_display_name, position, sum_fpts, mean_target_share, games_missed) %>% 
  distinct() %>% 
  left_join(
    roster_rb_all %>% 
      mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
      select(season, player_id, team, birth_date, years_exp, draft_number),
    by = c("season", "player_id")
  ) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(
    rb_epa_df %>% 
      rename(player_id = rusher_id),
    by = c("season", "player_id")
  ) %>% 
  left_join(
    df_ryoe_all,
    by = c("season", "player_id")
  ) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    prior_fpts = lag(sum_fpts),
    prior_games_missed = lag(games_missed),
    prior_rb_epa = lag(mean_epa),
    prior_ryoe_att = lag(ryoe_att),
    prior_ryoe = lag(ryoe),
    prior_tar_share = lag(mean_target_share)
  ) %>% 
  ungroup() %>% 
  left_join(games_missed_rb_all, by = c("player_id", "season")) %>% 
  left_join(rb_new_team_df, by = c("player_id", "season", "team")) %>% 
  left_join(rb_gl_rate_df, by = c("player_id", "season")) %>% 
  left_join(
    roster_rb_all %>% 
      left_join(fan_rb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, prior_fpts_other, prior_rank),
    by = c("player_id", "season")
  )

view(fan_rb_fin_all)
```

### Train models

```{r wr team prior}
load("mod_df_as_of_2023.Rdata")

fpts_rb_train_df = 
  fan_rb_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  left_join(rush_rate_df, by = c("team", "season")) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, sum_fpts, prior_fpts, prior_rb_epa, prior_ryoe_att, prior_off_rush_epa, prior_rush_rate, prior_gl_rate, prior_tar_share, prior_fpts_other, player_age, draft_number, games_missed_rate, coach_exp_off, rb_new_team) %>% 
  select(-c(coach_exp_off)) %>% 
  drop_na() %>% 
  arrange(player_id) %>% 
  select(-player_id)

view(fpts_rb_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_rb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_rb

# Lasso
set.seed(37564)
mod_lass_rb = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_rb_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-2, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_rb, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_rb$bestTune
min(mod_lass_rb$results$RMSE)

# KNN
set.seed(37564)
mod_knn_rb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(20, 60, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_rb, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_rb$bestTune
min(mod_knn_rb$results$RMSE)

# MARS
set.seed(37564)
mod_mars_rb = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_rb_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:2, nprune = 1:20), 
                 trControl = ctrl)
ggplot(mod_mars_rb, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_rb$bestTune
min(mod_mars_rb$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_rb = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_rb_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(7000, 9000, 11000),
                                         interaction.depth = 1,
                                         shrinkage = c(0.0007, 0.0009, 0.0011), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_rb, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_rb$bestTune
min(mod_boost_rb$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_rb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-1, 1, len = 5)),
                                       sigma = exp(seq(-7,-2, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_rb, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_rb$bestTune
min(mod_svm_rb$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_rb, 
  method = "permute", 
  train = fpts_rb_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_rb$finalModel, mod_lass_rb$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_rb, LASSO = mod_lass_rb, MARS = mod_mars_rb, KNN = mod_knn_rb, BOOST = mod_boost_rb, SVM = mod_svm_rb))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

```

### Make model for rookies

```{r rb rookie}
fpts_rb_rookie_train_df = 
  roster_rb_all %>% 
  filter(rookie_year == season) %>% 
  mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
  select(season, player_id, full_name, team, birth_date, draft_number) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(
    fan_rb_all %>% 
      select(season, position, player_id, player_display_name, fpts) %>% 
      group_by(season, player_id, player_display_name, position) %>% 
      mutate(sum_fpts = sum(fpts, na.rm = T)) %>% 
      ungroup() %>% 
      select(season, player_id, sum_fpts) %>% 
      distinct(),
    by = c("season", "player_id")
  ) %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  left_join(rush_rate_df, by = c("team", "season")) %>% 
  group_by(season) %>%
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  left_join(
    roster_rb_all %>% 
      left_join(fan_rb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T),
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct(),
    by = c("season", "team")
  ) %>% 
  select(player_id, sum_fpts, prior_off_rush_epa, prior_rush_rate, prior_fpts_other, coach_exp_off, player_age, draft_number) %>% 
  drop_na() %>% 
  arrange(player_id) %>%
  select(-player_id)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_rb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_rookie_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_rb_rook

# Lasso
set.seed(37564)
mod_lass_rb_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_rb_rookie_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-3, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_rb_rook, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_rb_rook$bestTune
min(mod_lass_rb_rook$results$RMSE)

# KNN
set.seed(37564)
mod_knn_rb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_rookie_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(2, 30, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_rb_rook, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_rb_rook$bestTune
min(mod_knn_rb_rook$results$RMSE)

# MARS
set.seed(37564)
mod_mars_rb_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_rb_rookie_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 2:4, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_rb_rook, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_rb_rook$bestTune
min(mod_mars_rb_rook$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_rb_rook = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_rb_rookie_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(7000, 9000, 11000),
                                         interaction.depth = 2:3,
                                         shrinkage = c(0.0001, 0.0003, 0.0005), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_rb_rook, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_rb_rook$bestTune
min(mod_boost_rb_rook$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_rb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_rb_rookie_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(2.4, 3, len = 6)),
                                       sigma = exp(seq(-7,-2, len = 10))),
                trControl = ctrl)
ggplot(mod_svm_rb_rook, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_rb_rook$bestTune
min(mod_svm_rb_rook$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_rb_rook, 
  method = "permute", 
  train = fpts_rb_rookie_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_rb_rook$finalModel, mod_lass_rb_rook$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_rb_rook, LASSO = mod_lass_rb_rook, MARS = mod_mars_rb_rook, KNN = mod_knn_rb_rook, BOOST = mod_boost_rb_rook, SVM = mod_svm_rb_rook))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

```


### Run model on test data

```{r pred test rb}
fpts_rb_test_df = 
  roster_rb_all %>% 
  filter(season == 2025) %>% 
  mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  left_join(
    fan_rb_fin_all %>% 
      filter(season == 2024) %>% 
      select(player_id, sum_fpts, games_missed, mean_target_share) %>% 
      rename(
        prior_games_missed = games_missed,
        prior_fpts = sum_fpts,
        prior_tar_share = mean_target_share
      ),
    by = "player_id"
  ) %>% 
  left_join(
    fin_df %>% 
      filter(season == 2024) %>% 
      select(team, off_rush_epa, off_pass_epa) %>% 
      rename(
        prior_off_pass_epa = off_pass_epa,
        prior_off_rush_epa = off_rush_epa
      ),
    by = "team"
  ) %>% 
  left_join(
    rb_epa_df %>% 
      filter(season == 2024) %>% 
      select(rusher_id, mean_epa) %>% 
      rename(
        player_id = rusher_id,
        prior_rb_epa = mean_epa
      ),
    by = "player_id"
  ) %>% 
  left_join(
    df_ryoe_all %>% 
      filter(season == 2024) %>% 
      select(player_id, ryoe_att) %>% 
      rename(prior_ryoe_att = ryoe_att) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  left_join(games_missed_rb_all, by = c("player_id", "season")) %>% 
  left_join(rush_rate_df, by = c("team", "season")) %>% 
  left_join(rb_gl_rate_df, by = c("player_id", "season")) %>% 
  left_join(rb_new_team_df, by = c("player_id", "season", "team")) %>% 
  left_join(
    roster_rb_all %>% 
      left_join(fan_rb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, prior_fpts_other, prior_rank) %>% 
      filter(season == 2025),
    by = c("player_id", "season")
  ) %>% 
  select(player_id, full_name, team, prior_fpts, prior_rb_epa, prior_ryoe_att, prior_off_rush_epa, prior_rush_rate, prior_gl_rate, prior_tar_share, prior_fpts_other, player_age, draft_number, games_missed_rate, coach_exp_off, rb_new_team) %>% 
  select(-c(coach_exp_off)) %>% 
  drop_na()

view(fpts_rb_test_df)

fpts_rb_rookie_test_df = 
  roster_rb_all %>% 
  filter(rookie_year == 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
  left_join(
    fin_df %>% 
      filter(season == 2024) %>% 
      select(team, off_rush_epa, off_pass_epa) %>% 
      rename(
        prior_off_pass_epa = off_pass_epa,
        prior_off_rush_epa = off_rush_epa
      ),
    by = "team"
  ) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  left_join(rush_rate_df, by = c("team", "season")) %>% 
  left_join(
    roster_rb_all %>% 
      left_join(fan_rb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T),
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      filter(season == 2025) %>% 
      distinct(),
    by = c("season", "team")
  ) %>% 
  group_by(season) %>% 
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  select(player_id, full_name, team, prior_off_rush_epa, prior_rush_rate, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  arrange(player_id) %>% 
  drop_na()

view(fpts_rb_rookie_test_df)

# test mods on 2024 data:
tst_rb_2024 = 
  fan_rb_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  left_join(rush_rate_df, by = c("team", "season")) %>% 
  filter(season == 2024) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, full_name, sum_fpts, prior_fpts, prior_rb_epa, prior_ryoe_att, prior_off_rush_epa, prior_rush_rate, prior_gl_rate, prior_tar_share, player_age, draft_number, games_missed_rate, coach_exp_off, rb_new_team) %>% 
  drop_na() %>% 
  arrange(player_id) %>% 
  select(-player_id)

# tst_rb_2024 %>% 
#   mutate(
#     pred_mod_svm = predict(mod_svm_rb, newdata = .)
#   ) %>% 
#   arrange(-pred_mod_svm) %>% 
#   rowid_to_column("rb_rank") %>% 
#   view

fpts_rb_2025 = 
  fpts_rb_test_df %>% 
  mutate(
    pred_fpts_svm = predict(mod_svm_rb, newdata = fpts_rb_test_df),
    pred_fpts_boost = predict(mod_boost_rb, newdata = fpts_rb_test_df),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_mars = predict(mod_mars_rb, newdata = fpts_rb_test_df)[, 1]
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, full_name, starts_with("pred_fpts")) %>% 
  mutate(
    cohort = "Non-Rookie"
  ) %>% 
  rbind(
    fpts_rb_rookie_test_df %>%
      mutate(
        pred_fpts_svm = predict(mod_svm_rb_rook, newdata = fpts_rb_rookie_test_df),
        pred_fpts_boost = predict(mod_boost_rb_rook, newdata = fpts_rb_rookie_test_df),
        pred_fpts_mars = predict(mod_mars_rb_rook, newdata = fpts_rb_rookie_test_df)[, 1]
      ) %>%
      select(team, player_id, full_name, starts_with("pred_fpts")) %>% 
      mutate(
        cohort = "Rookie"
      )
  ) %>%
  mutate(
    across(starts_with("pred_fpts"), ~ round(., 2)),
    pred_fpts_fin_mod = 
      case_when(
        cohort == "Rookie" ~ pred_fpts_mars,
        cohort == "Non-Rookie" ~ pred_fpts_svm,
        .default = NA
      )
  ) %>% 
  arrange(-pred_fpts_fin_mod) %>% 
  rowid_to_column("rb_rank")

view(fpts_rb_2025)

# write.csv(fpts_rb_2024, "fpts_rb_2024.csv", row.names = F)

set.seed(37564)
boot_splits = bootstraps(fpts_rb_train_df, times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    sum_fpts ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_svm_rb$bestTune[[1]],
      C = mod_svm_rb$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = fpts_rb_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
rb_boot_pred_bands = 
  fpts_rb_test_df %>%
  select(player_id, full_name) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(rb_boot_pred_bands)

set.seed(37564)
boot_splits_rook = bootstraps(fpts_rb_rookie_train_df, times = 100)

# Fit model to each resample and generate predictions
boot_preds_rook = 
  boot_splits_rook %>%
  mutate(
    preds = 
      map(
        splits, 
        ~ {
          model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_rb_rook$bestTune[[1]], degree = mod_mars_rb_rook$bestTune[[2]])
    predict(model, fpts_rb_rookie_test_df)
      }
    )
  )

# Convert predictions into long-format tibble
rb_boot_pred_bands_rook = 
  boot_preds_rook %>%
  select(preds) %>%
  unnest_longer(preds, indices_to = "player_index") %>%
  group_by(player_index) %>%
  summarise(
    pred_mean = mean(preds),
    pred_lower = quantile(preds, 0.10),
    pred_upper = quantile(preds, 0.90),
    .groups = "drop"
  ) %>%
  mutate(
    full_name = fpts_rb_rookie_test_df$full_name[player_index],
    player_id = fpts_rb_rookie_test_df$player_id[player_index],
    across(c(pred_mean, pred_lower, pred_upper), ~ round(., 2))
  ) %>%
  select(player_id, full_name, pred_mean, pred_lower, pred_upper)

view(rb_boot_pred_bands_rook)

# fpts_rb_2025 %>% 
#   left_join(
#     rb_boot_pred_bands %>% 
#       rbind(rb_boot_pred_bands_rook), 
#     by = c("player_id", "full_name")
#   ) %>% 
#   select(-c(player_id, pred_mean)) %>% 
#   view

fpts_rb_2025_fin_rank = 
  fpts_rb_2025 %>% 
  left_join(
    rb_boot_pred_bands %>% 
      rbind(rb_boot_pred_bands_rook), 
    by = c("player_id", "full_name")
  ) 

fpts_rb_2025_fin_rank %>% 
  left_join(
    teams_colors_logos %>% 
      rename(team = team_abbr) %>% 
      select(team, team_color), 
    by = "team"
  ) %>% 
  filter(rb_rank <= 50) %>%
  ggplot(aes(y = reorder(full_name, pred_fpts_fin_mod), x = pred_fpts_fin_mod)) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper, color = team_color), height = 1) +
  geom_point(aes(color = team_color), size = 2.4) +
  geom_text(aes(label = full_name, x = pred_upper + 1, color = team_color), hjust = 0, size = 3.15)+
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(0, 300, by = 25)) +
  labs(
    x = "Predicted Fantasy Points (0.5 PPR)",
    y = NULL,
    title = "RB Fantasy Point Predictions with 80% Confidence Bands"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(50, 280)
  )

fpts_rb_2025_fin_rank_export = 
  fpts_rb_2025_fin_rank %>% 
  select(rb_rank, team, full_name, pred_fpts_fin_mod, pred_lower, pred_upper, cohort)# %>% 
  # mutate(
  #   pt_diff = pred_fpts_fin_mod - lag(pred_fpts_fin_mod),
  #   tier_init = ifelse(is.na(pt_diff) | pt_diff < -5, 1, 0)
  # )

write.csv(fpts_rb_2025_fin_rank_export, glue::glue("fpts_rb_2025_fin_rank_{format(Sys.Date(), '%Y_%m_%d')}.csv"), row.names = F)
```

## TE

### Get prior data

```{r get data}
games_missed_te_2025 = 
  szn_all %>% 
  filter(season <= 2024) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2025,
    years_exp = 2025 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2025 - 2021)) * 16 + (2025 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

# view(games_missed_2025)

games_missed_te_2024 = 
  szn_all %>% 
  filter(season <= 2023) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2024,
    years_exp = 2024 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2024 - 2021)) * 16 + (2024 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

view(games_missed_2024)

games_missed_te_2023 = 
  szn_all %>% 
  filter(season <= 2022) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2023,
    years_exp = 2023 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2023 - 2021)) * 16 + (2023 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2022 = 
  szn_all %>% 
  filter(season <= 2021) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2022,
    years_exp = 2022 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2022 - 2021)) * 16 + (2022 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2021 = 
  szn_all %>% 
  filter(season <= 2020) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2021,
    years_exp = 2021 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2021 - 2021)) * 16 + (2021 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2020 = 
  szn_all %>% 
  filter(season <= 2019) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2020,
    years_exp = 2020 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2019 = 
  szn_all %>% 
  filter(season <= 2018) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2019,
    years_exp = 2019 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2018 = 
  szn_all %>% 
  filter(season <= 2017) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2018,
    years_exp = 2018 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2017 = 
  szn_all %>% 
  filter(season <= 2016) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2017,
    years_exp = 2017 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_2016 = 
  szn_all %>% 
  filter(season <= 2015) %>% 
  calculate_player_stats() %>% 
  filter(position == "TE") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "TE") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2016,
    years_exp = 2016 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_te_all = 
  games_missed_te_2025 %>% 
  rbind(
    games_missed_te_2024,
    games_missed_te_2023,
    games_missed_te_2022,
    games_missed_te_2021,
    games_missed_te_2020,
    games_missed_te_2019,
    games_missed_te_2018,
    games_missed_te_2017,
    games_missed_te_2016
  )

view(games_missed_te_all)

fan_te_all =
  szn_all %>% 
  filter(between(season, 2016, 2024)) %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5 * receptions) %>% 
  filter(position == "TE")

view(fan_te_all)

roster_te_all = 
  roster_all_df %>% 
  filter(between(season, 2016, 2025)) %>% 
  filter(position == "TE") %>% 
  rename(
    player_id = gsis_id
  )

view(roster_te_all)

fan_te_season_finish = 
  fan_te_all %>% 
  group_by(season, player_id) %>% 
  summarise(
    fpts_total = sum(fpts)
  ) %>% 
  ungroup() %>% 
  mutate(
    fpts_total = 
      case_when(
        season < 2021 ~ fpts_total * 17 / 16,
        season >= 2021 ~ fpts_total,
        .default = NA
      )
  ) %>% 
  group_by(season) %>% 
  arrange(season, desc(fpts_total)) %>% 
  drop_na() %>% 
  mutate(
    season_rank = row_number(),
    season_finish = 
      factor(
        case_when(
          between(season_rank, 1, 20) ~ "Top 20",
          between(season_rank, 21, 50) ~ "21 - 50",
          season_rank > 50 ~ "Over 50",
          .default = NA
        ),
        levels = c("Top 20", "21 - 50", "Over 50")
      )
  ) %>% 
  ungroup()
  
view(fan_te_season_finish)

te_rz_rate_df = 
  roster_te_all %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(pass == 1 & yardline_100 <= 20 & !is.na(receiver_player_id)) %>% 
        rename(player_id = receiver_player_id) %>% 
        group_by(player_id, season) %>% 
        summarise(
          n_rz_att = n()
        ) %>% 
        ungroup(),
      by = c("player_id", "season")
    ) %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(pass == 1 & yardline_100 <= 20 & !is.na(receiver_player_id)) %>% 
        rename(team = posteam) %>% 
        group_by(team, season) %>% 
        summarise(
          n_rz_att_team = n()
        ) %>% 
        ungroup(),
      by = c("season", "team")
    ) %>% 
    group_by(player_id) %>% 
    arrange(player_id, season) %>% 
    mutate(
      rz_rate = n_rz_att / n_rz_att_team,
      prior_rz_rate = lag(rz_rate)
    ) %>% 
    ungroup() %>% 
    select(season, player_id, prior_rz_rate)

view(te_rz_rate_df)

fan_te_fin_all =
  fan_te_all %>% 
  filter(between(season, 2016, 2025)) %>% 
  select(season, recent_team, position, player_id, player_display_name, receptions, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
  group_by(season, player_id, player_display_name, position) %>% 
  mutate(
    games_missed = 
      case_when(
        season < 2021 ~ 16 - n(),
        season >= 2021 ~ 17 - n()
      ),
    sum_yards = sum(receiving_yards, na.rm = T),
    sum_rec = sum(receptions, na.rm = T),
    sum_fpts = 
      case_when(
        season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
        season >= 2021 ~ sum(fpts, na.rm = T),
        .default = NA
      ),
    mean_racr = mean(racr, na.rm = T),
    mean_air_yards_share = mean(air_yards_share, na.rm = T),
    mean_target_share = mean(target_share, na.rm = T)
  ) %>% 
  ungroup() %>% 
  select(season, player_id, player_display_name, position, starts_with("sum_"), starts_with("mean_"), games_missed) %>% 
  distinct() %>% 
  # group_by(season) %>% 
  # mutate(season_rank = rank(desc(sum_fpts))) %>% 
  # ungroup() %>% 
  left_join(
    roster_te_all %>% 
      select(season, player_id, team, birth_date, years_exp, draft_number) %>% 
      mutate(draft_number = replace_na(as.integer(draft_number), 260)),
    by = c("season", "player_id")
  ) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    across(
      c(games_missed, mean_air_yards_share, mean_target_share, sum_fpts),
      ~ lag(.),
      .names = "prior_{col}"
    ),
    te_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      ),
    new_qb_new_team = 
      case_when(
        qb_new_team == 1 | te_new_team == 1 ~ 1,
        .default = 0
      )
  ) %>% 
  rename(
    prior_ays = prior_mean_air_yards_share,
    prior_tar_share = prior_mean_target_share,
    prior_fpts = prior_sum_fpts
  ) %>%
  ungroup() %>% 
  left_join(
    roster_te_all %>% 
      left_join(fan_te_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, prior_fpts_other, prior_rank),
    by = c("player_id", "season")
  ) %>% 
  left_join(games_missed_te_all, by = c("player_id", "season")) %>% 
  left_join(te_rz_rate_df, by = c("player_id", "season")) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 & sum_fpts >= 100) | (is.na(prior_rank))) %>% 
  filter(prior_rank <= 40 | (is.na(prior_rank)))

view(fan_te_fin_all)
  
# roster_wr_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
#   select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
#   mutate(
#     ind_top_20 = ifelse(season_rank <= 20, 1, 0)
#   ) %>% 
#   group_by(player_id) %>% 
#   arrange(player_id, season) %>% 
#   mutate(
#     prior_ind_top_20 = lag(ind_top_20),
#     prior_fpts = lag(fpts_total)
#   ) %>% 
#   ungroup() %>% 
#   group_by(season, team) %>% 
#   arrange(season, team) %>% 
#   filter(season != 2016) %>% 
#   mutate(
#     top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
#     prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
#   )
# 
# fan_wr_fin_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% view

# fan2023 = 
#   szn_all %>% 
#   filter(season == 2023) %>% 
#   calculate_player_stats(weekly = T) %>% 
#   mutate(fpts = fantasy_points + 0.5 * receptions)

# 
# roster2023 = 
#   fast_scraper_roster(2023)
# 
# view(roster2023)

# try to predict 2023 from 2022:

# view(fan2022)

# get players who switched teams:
# fan2022 %>% 
#   filter(position == "WR") %>% 
#   select(recent_team, position, player_id, player_name, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   # group_by(player_id, player_name, recent_team, position) %>% 
#   select(player_id, player_name, recent_team, position) %>% 
#   distinct() %>% 
#   group_by(player_id) %>% 
#   filter(n() > 1)
```

### Train models

```{r wr team prior}
load("mod_df_as_of_2023.Rdata")
load("coach_df_as_of_2025.Rdata")

fpts_te_train_df = 
  fan_te_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, sum_fpts, prior_ays, prior_tar_share,prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, prior_rz_rate, coach_exp_off, new_qb_new_team, games_missed_rate) %>% 
  select(-c(prior_n_pass, new_qb_new_team, coach_exp_off)) %>%
  drop_na() %>% 
  arrange(player_id) %>% 
  select(-player_id)

view(fpts_te_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_te = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_te

# Lasso
set.seed(37564)
mod_lass_te = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_te_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-3, 1, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_te, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_te$bestTune
min(mod_lass_te$results$RMSE)

# KNN
set.seed(37564)
mod_knn_te = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(10, 40, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_te, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_te$bestTune
min(mod_knn_te$results$RMSE)

# MARS
set.seed(37564)
mod_mars_te = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_te_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_te, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_te$bestTune
min(mod_mars_te$results$RMSE)
#mod_mars_wr$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_te = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_te_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(7000, 9000, 11000),
                                         interaction.depth = c(3:4),
                                         shrinkage = c(0.0002, 0.0003, 0.0004),
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_te, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_te$bestTune
min(mod_boost_te$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_te = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-2, 0, len = 5)),
                                       sigma = exp(seq(-4,-2, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_te, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_te$bestTune
min(mod_svm_te$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_te, 
  method = "permute", 
  train = fpts_te_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_te$finalModel, mod_lass_te$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_te, LASSO = mod_lass_te, MARS = mod_mars_te, KNN = mod_knn_te, BOOST = mod_boost_te, SVM = mod_svm_te))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

mod_errors = 
  tibble(
    resid_glm = as.vector(fpts_te_train_df$sum_fpts - predict(mod_glm_te, newdata = fpts_te_train_df)),
    resid_knn = fpts_te_train_df$sum_fpts - predict(mod_knn_te, newdata = fpts_te_train_df),
    resid_lasso = as.vector(fpts_te_train_df$sum_fpts - predict(mod_lass_te, newdata = fpts_te_train_df)),
    resid_mars = as.vector(fpts_te_train_df$sum_fpts - predict(mod_mars_te, newdata = fpts_te_train_df)),
    resid_boost = fpts_te_train_df$sum_fpts - predict(mod_boost_te, newdata = fpts_te_train_df),
    resid_svm = fpts_te_train_df$sum_fpts - predict(mod_svm_te, newdata = fpts_te_train_df)
  )

corrplot::corrplot(cor(mod_errors, use = "complete.obs"), diag = F, method = "shade", type = "lower")

# mod_glm_wr$finalModel$residuals %>% as.vector()




# fpts_wr_test_df = 
#   fan2023 %>% 
#   filter(position == "WR") %>% 
#   select(season, recent_team, position, player_id, player_display_name, receptions, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   group_by(season, player_id, player_display_name, position) %>% 
#   summarise(
#     sum_fpts = sum(fpts, na.rm = T)
#   ) %>% 
#   ungroup() %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       filter(position == "WR") %>% 
#       select(player_id, team, birth_date, years_exp),
#     by = "player_id"
#   ) %>% 
#   drop_na(team) %>% 
#   filter(player_id %in% c(fpts_wr_train_df %>% pull(player_id)))
# 
# players_diff = setdiff(fpts_wr_test_df$player_id, fpts_wr_train_df$player_id)
# 
# roster2023 %>% filter(gsis_id %in% c(players_diff)) %>% view
# 
# fpts_wr_train_df %>% 
#   cbind(
#     pred_fpts_glm = predict(mod_glm),
#     pred_fpts_lasso = predict(mod_lass),
#     pred_fpts_knn = predict(mod_knn),
#     pred_fpts_mars = predict(mod_mars),
#     pred_fpts_boost = predict(mod_boost)#,
#     #pred_fpts_svm = predict(mod_svm)
#   ) %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       select(player_id, full_name),
#     by = "player_id"
#   ) %>% 
#   view

```

### Make model for rookies

```{r wr rookie}
fpts_te_rookie_train_df =
  roster_te_all %>% 
  filter(rookie_year == season) %>% 
  select(season, player_id, full_name, team, birth_date, draft_number) %>% 
  mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  left_join(
    fan_te_all %>% 
      select(season, position, player_id, player_display_name, fpts) %>% 
      group_by(season, player_id, player_display_name, position) %>% 
      mutate(
        sum_fpts = 
          case_when(
            season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
            season >= 2021 ~ sum(fpts, na.rm = T),
            .default = NA
          )
      ) %>% 
      ungroup() %>% 
      select(season, player_id, sum_fpts) %>% 
      distinct(),
    by = c("season", "player_id")
  ) %>% 
  left_join(
    roster_te_all %>% 
      left_join(fan_te_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct(),
    by = c("season", "team")
  ) %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>%
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 10) %>% 
  ungroup() %>% 
  select(player_id, sum_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na() %>% 
  arrange(player_id) %>%
  select(-player_id)

view(fpts_te_rookie_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_te_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_rookie_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_te_rook

# Lasso
set.seed(37564)
mod_lass_te_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_te_rookie_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-1, 3, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_te_rook, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_te_rook$bestTune
min(mod_lass_te_rook$results$RMSE)

# KNN
set.seed(37564)
mod_knn_te_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_rookie_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(20, 40, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_te_rook, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_te_rook$bestTune
min(mod_knn_te_rook$results$RMSE)

# MARS
set.seed(37564)
mod_mars_te_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_te_rookie_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_te_rook, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_te_rook$bestTune
min(mod_mars_te_rook$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_te_rook = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_te_rookie_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(5000, 7000, 9000),
                                         interaction.depth = 1,
                                         shrinkage = c(0.0003, 0.0005, 0.0007), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_te_rook, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_te_rook$bestTune
min(mod_boost_te_rook$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_te_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_te_rookie_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-4, -2, len = 5)),
                                       sigma = exp(seq(-5,-1, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_te_rook, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_te_rook$bestTune
min(mod_svm_te_rook$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_te_rook, 
  method = "permute", 
  train = fpts_te_rookie_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_te_rook$finalModel, mod_lass_te_rook$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_te_rook, LASSO = mod_lass_te_rook, MARS = mod_mars_te_rook, KNN = mod_knn_te_rook, BOOST = mod_boost_te_rook, SVM = mod_svm_te_rook))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")
```

### Run model on test data

```{r pred test}
fpts_te_test_df =
  roster_te_all %>% 
  filter(season %in% c(2024, 2025)) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    te_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      ),
    draft_number = replace_na(as.integer(draft_number), 260)
  ) %>% 
  ungroup() %>% 
  filter(season %in% 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  left_join(
    fan_te_fin_all %>% 
      filter(season == 2024) %>% 
      select(player_id, mean_air_yards_share, mean_target_share, sum_fpts, games_missed) %>% 
      rename(
        prior_games_missed = games_missed,
        prior_ays = mean_air_yards_share,
        prior_tar_share = mean_target_share,
        prior_fpts = sum_fpts
      ),
    by = "player_id"
  ) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_qb_epa, qb_new_team, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_te_all %>% 
      left_join(fan_te_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, team, prior_fpts_other, prior_rank) %>% 
      filter(season == 2025),
    by = c("season", "player_id", "team")
  ) %>% 
  left_join(
    coach_df %>% 
      filter(season == 2025) %>% 
      select(season, team, coach_exp_off),
    by = c("season", "team")
  ) %>% 
  mutate(
    new_qb_new_team = 
      case_when(
        qb_new_team == 1 | te_new_team == 1 ~ 1,
        .default = 0
      )
  ) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 | (is.na(prior_rank)))) %>% 
  left_join(games_missed_te_all, by = c("player_id", "season")) %>% 
  left_join(te_rz_rate_df, by = c("player_id", "season")) %>% 
  filter(prior_rank <= 40 | is.na(prior_rank)) %>% 
  select(player_id, full_name, team, prior_ays, prior_tar_share, games_missed_rate, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, prior_rz_rate, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team) %>% 
  select(-c(prior_n_pass, new_qb_new_team, coach_exp_off)) %>%
  drop_na()

view(fpts_te_test_df)

fpts_te_rookie_test_df = 
  roster_te_all %>% 
  filter(rookie_year == 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  mutate(draft_number = replace_na(as.integer(draft_number), 260)) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_qb_epa, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_te_all %>% 
      left_join(fan_te_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct() %>% 
      filter(season == 2025),
    by = c("season", "team")
  ) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>% 
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  select(player_id, full_name, team, prior_qb_epa, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na()

view(fpts_te_rookie_test_df)

fpts_te_2025 = 
  fpts_te_test_df %>% 
  mutate(
    pred_fpts_mars = predict(mod_mars_te, newdata = fpts_te_test_df)[, 1],
    pred_fpts_boost = predict(mod_boost_te, newdata = fpts_te_test_df),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_svm = predict(mod_svm_te, newdata = fpts_te_test_df),
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
  mutate(
    cohort = "Non-Rookie"
  ) %>% 
  rbind(
    fpts_te_rookie_test_df %>%
      mutate(
        pred_fpts_mars = predict(mod_mars_te_rook, newdata = fpts_te_rookie_test_df)[, 1],
        pred_fpts_boost = predict(mod_boost_te_rook, newdata = fpts_te_rookie_test_df),
        pred_fpts_svm = predict(mod_svm_te_rook, newdata = fpts_te_rookie_test_df)
      ) %>%
      select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>%
      mutate(
        cohort = "Rookie"
      )
  ) %>%
  mutate(
    pred_fpts_mars = round(pred_fpts_mars, 2),
    pred_fpts_boost = round(pred_fpts_boost, 2),
    pred_fpts_svm = round(pred_fpts_svm, 2),
    pred_fpts_fin_mod = 
      case_when(
        cohort == "Rookie" ~ pred_fpts_mars,
        cohort == "Non-Rookie" ~ pred_fpts_svm,
        .default = NA
      )
  ) %>% 
  arrange(-pred_fpts_fin_mod) %>% 
  rowid_to_column("te_rank")

view(fpts_te_2025)

# # check mods w/ last year's data:
# fan_wr_fin_all %>% 
#   left_join(fin_df, by = c("team", "season")) %>% 
#   left_join(coach_df, by = c("team", "season")) %>% 
#   filter(season == 2024) %>% 
#   # left_join(mod_df, by = c("team", "season")) %>% 
#   select(player_id, team, player_display_name, sum_fpts, prior_ays, prior_tar_share, games_missed_rate, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team) %>% 
#   select(-c(prior_qb_epa, coach_exp_off)) %>% 
#   drop_na() %>% 
#   arrange(player_id) %>% 
#   mutate(
#     pred_fpts_mars = predict(mod_mars_wr, newdata = .)[, 1],
#     pred_fpts_boost = predict(mod_boost_wr, newdata = .),
#     # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
#     # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
#     pred_fpts_svm = predict(mod_svm_wr, newdata = .),
#     # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
#   ) %>% 
#   select(team, player_id, player_display_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
#   # rbind(
#   #   fpts_wr_rookie_test_df %>% 
#   #     mutate(
#   #       pred_fpts_mars = predict(mod_mars_wr_rook, newdata = fpts_wr_rookie_test_df)[, 1]
#   #     ) %>% 
#   #     select(team, full_name, pred_fpts_mars)
#   # ) %>% 
#   mutate(
#     pred_fpts_mars = round(pred_fpts_mars, 2),
#     pred_fpts_boost = round(pred_fpts_boost, 2),
#     pred_fpts_svm = round(pred_fpts_svm, 2)
#   ) %>% 
#   arrange(-pred_fpts_svm) %>% 
#   rowid_to_column("wr_rank") %>% 
#   view

# write.csv(fpts_wr_2024, "fpts_wr_2024.csv", row.names = F)

set.seed(37564)
boot_splits = bootstraps(fpts_te_train_df, times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    sum_fpts ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_svm_te$bestTune[[1]],
      C = mod_svm_te$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = fpts_te_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
te_boot_pred_bands = 
  fpts_te_test_df %>%
  select(player_id, full_name) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(te_boot_pred_bands)

set.seed(37564)
boot_splits_rook = bootstraps(fpts_te_rookie_train_df, times = 100)

# Fit model to each resample and generate predictions
boot_preds_rook = 
  boot_splits_rook %>%
  mutate(
    preds = 
      map(
        splits, 
        ~ {
          model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_te_rook$bestTune[[1]], degree = mod_mars_te_rook$bestTune[[2]])
    predict(model, fpts_te_rookie_test_df)
      }
    )
  )

# Convert predictions into long-format tibble
te_boot_pred_bands_rook = 
  boot_preds_rook %>%
  select(preds) %>%
  unnest_longer(preds, indices_to = "player_index") %>%
  group_by(player_index) %>%
  summarise(
    pred_mean = mean(preds),
    pred_lower = quantile(preds, 0.10),
    pred_upper = quantile(preds, 0.90),
    .groups = "drop"
  ) %>%
  mutate(
    full_name = fpts_te_rookie_test_df$full_name[player_index],
    player_id = fpts_te_rookie_test_df$player_id[player_index],
    across(c(pred_mean, pred_lower, pred_upper), ~ round(., 2))
  ) %>%
  select(player_id, full_name, pred_mean, pred_lower, pred_upper)

view(te_boot_pred_bands_rook)

fpts_te_2025_fin_rank = 
  fpts_te_2025 %>% 
  left_join(
    te_boot_pred_bands %>% 
      rbind(te_boot_pred_bands_rook), 
    by = c("player_id", "full_name")
  )

view(fpts_te_2025_fin_rank)

fpts_te_2025_fin_rank %>% 
  left_join(
    teams_colors_logos %>% 
      rename(team = team_abbr) %>% 
      select(team, team_color), 
    by = "team"
  ) %>% 
  filter(te_rank <= 20) %>% 
  ggplot(aes(y = reorder(full_name, pred_fpts_fin_mod), x = pred_fpts_fin_mod)) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper, color = team_color), height = 1) +
  geom_point(aes(color = team_color), size = 2.4) +
  geom_text(aes(label = full_name, x = pred_upper + 1, color = team_color), hjust = 0, size = 3.15)+
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(0, 300, by = 25)) +
  labs(
    x = "Predicted Fantasy Points (0.5 PPR)",
    y = NULL,
    title = "TE Fantasy Point Predictions with 80% Confidence Bands"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(60, 200)
  )

# exporting rankings:

fpts_te_2025_fin_rank_export = 
  fpts_te_2025_fin_rank %>% 
  select(te_rank, team, full_name, pred_fpts_fin_mod, pred_lower, pred_upper, cohort)

write.csv(fpts_te_2025_fin_rank_export, glue::glue("fpts_te_2025_fin_rank_{format(Sys.Date(), '%Y_%m_%d')}.csv"), row.names = F)

# 
# # 1. Create 100 bootstrap samples
# set.seed(37564)
# boot_splits = bootstraps(fpts_wr_train_df, times = 100)
# 
# # 2. Predict for each bootstrap model
# boot_preds = map(boot_splits$splits, ~{
#   train_data = analysis(.x)
# 
#   # Fit GBM (tune params as needed)
#   model <- gbm(
#     formula = sum_fpts ~ .,
#     data = train_data,
#     distribution = "gaussian",
#     n.trees = mod_boost_wr$bestTune[[1]],
#     interaction.depth = mod_boost_wr$bestTune[[2]],
#     shrinkage = mod_boost_wr$bestTune[[3]],
#     # bag.fraction = 0.5,
#     # train.fraction = 1.0,
#     verbose = FALSE
#   )
# 
#   # Predict on same test set each time
#   predict(model, newdata = fpts_wr_test_df, n.trees = mod_boost_wr$bestTune[[1]])
# })
# 
# # 3. Combine predictions into a matrix
# pred_matrix = do.call(cbind, boot_preds)
# 
# # 4. Compute mean prediction and 95% prediction interval
# wr_boot_pred_bands = 
#   fpts_wr_test_df %>%
#   select(player_id, full_name) %>%
#   mutate(
#     pred_mean  = round(rowMeans(pred_matrix), 2), 
#     pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
#     pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
#   )
# 
# view(wr_boot_pred_bands)
# 
# fpts_wr_2025 %>% 
#   left_join(wr_boot_pred_bands, by = c("player_id", "full_name")) %>% 
#   select(-c(player_id, pred_mean)) %>% 
#   view
# 
# 
# 
# set.seed(37564)
# boot_splits = bootstraps(fpts_wr_train_df, times = 100)
# 
# # Fit model to each resample and generate predictions
# boot_preds = 
#   boot_splits %>%
#   mutate(
#     preds = 
#       map(
#         splits, 
#         ~ {
#           model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_wr$bestTune[[1]], degree = mod_mars_wr$bestTune[[2]])
#     predict(model, fpts_wr_test_df)
#       }
#     )
#   )
# 
# # Convert predictions into long-format tibble
# wr_boot_pred_bands = 
#   boot_preds %>%
#   select(preds) %>%
#   unnest_longer(preds, indices_to = "player_index") %>%
#   group_by(player_index) %>%
#   summarise(
#     pred_mean = mean(preds),
#     lower_band = quantile(preds, 0.10),
#     upper_band = quantile(preds, 0.90),
#     .groups = "drop"
#   ) %>%
#   mutate(
#     full_name = fpts_wr_test_df$full_name[player_index],
#     player_id = fpts_wr_test_df$player_id[player_index],
#     across(c(pred_mean, lower_band, upper_band), ~ round(., 2))
#   ) %>%
#   select(player_id, full_name, pred_mean, lower_band, upper_band)
# 
# view(wr_boot_pred_bands)
```

## QB

### Get prior data

```{r get data}
games_missed_qb_2025 = 
  szn_all %>% 
  filter(season <= 2024) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2025,
    years_exp = 2025 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2025 - 2021)) * 16 + (2025 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

# view(games_missed_2025)

games_missed_qb_2024 = 
  szn_all %>% 
  filter(season <= 2023) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2024,
    years_exp = 2024 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2024 - 2021)) * 16 + (2024 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

# view(games_missed_2024)

games_missed_qb_2023 = 
  szn_all %>% 
  filter(season <= 2022) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2023,
    years_exp = 2023 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2023 - 2021)) * 16 + (2023 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2022 = 
  szn_all %>% 
  filter(season <= 2021) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2022,
    years_exp = 2022 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2022 - 2021)) * 16 + (2022 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2021 = 
  szn_all %>% 
  filter(season <= 2020) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2021,
    years_exp = 2021 - entry_year,
    games_total = 
      case_when(
        entry_year >= 2021 ~ years_exp * 17,
        entry_year < 2021 ~ (years_exp - (2021 - 2021)) * 16 + (2021 - 2021) * 17,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2020 = 
  szn_all %>% 
  filter(season <= 2019) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2020,
    years_exp = 2020 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2019 = 
  szn_all %>% 
  filter(season <= 2018) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2019,
    years_exp = 2019 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2018 = 
  szn_all %>% 
  filter(season <= 2017) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2018,
    years_exp = 2018 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2017 = 
  szn_all %>% 
  filter(season <= 2016) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2017,
    years_exp = 2017 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_2016 = 
  szn_all %>% 
  filter(season <= 2015) %>% 
  calculate_player_stats() %>% 
  filter(position == "QB") %>% 
  select(player_id, player_display_name, games) %>% 
  left_join(
    roster_all_df %>% 
      filter(position == "QB") %>% 
      rename(player_id = gsis_id) %>% 
      select(player_id, full_name, entry_year) %>% 
      distinct(),
    by = "player_id"
  ) %>% 
  mutate(
    season = 2016,
    years_exp = 2016 - entry_year,
    games_total = 
      case_when(
        entry_year < 2021 ~ years_exp * 16,
        .default = NA
      ),
    games_missed_career = games_total - games,
    games_missed_rate = games_missed_career / years_exp
  ) %>% 
  select(season, player_id, games_missed_rate) %>% 
  distinct() %>% 
  drop_na()

games_missed_qb_all = 
  games_missed_qb_2025 %>% 
  rbind(
    games_missed_qb_2024,
    games_missed_qb_2023,
    games_missed_qb_2022,
    games_missed_qb_2021,
    games_missed_qb_2020,
    games_missed_qb_2019,
    games_missed_qb_2018,
    games_missed_qb_2017,
    games_missed_qb_2016
  )

view(games_missed_qb_all)

fan_qb_all =
  szn_all %>% 
  filter(between(season, 2016, 2024)) %>% 
  calculate_player_stats(weekly = T) %>% 
  mutate(fpts = fantasy_points + 0.5 * receptions) %>% 
  filter(position == "QB")

view(fan_qb_all)

roster_qb_all = 
  roster_all_df %>% 
  filter(between(season, 2016, 2025)) %>% 
  filter(position == "QB") %>% 
  rename(
    player_id = gsis_id
  )

view(roster_qb_all)

qb_epa_df = 
  szn_all %>% 
  filter(between(season, 2016, 2025)) %>%
  filter(qb_dropback == 1) %>% 
  group_by(season, posteam, passer, passer_id) %>% 
  drop_na(epa) %>% 
  summarize(sum_epa = sum(qb_epa, na.rm = T)) %>% 
  ungroup() %>% 
  rename(player_id = passer_id) %>% 
  mutate(
    sum_fpts = 
       case_when(
         season < 2021 ~ sum_epa * 17 / 16,
         season >= 2021 ~ sum_epa,
         .default = NA
       )
  )

view(qb_epa_df)

qb_epa_teams_df = 
  roster_all_df %>% 
  filter(position == "QB") %>% 
  rename(player_id = gsis_id) %>% 
  left_join(qb_epa_df, by = c("player_id", "season")) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    prior_qb_epa = lag(sum_epa)
  ) %>% 
  ungroup() %>% 
  group_by(season, team) %>% 
  mutate(
    prior_qb_epa = ifelse(rookie_year == season, 0, prior_qb_epa)
  ) %>% 
  arrange(season, team, desc(prior_qb_epa)) %>% 
  slice(1) %>% 
  # filter(prior_qb_epa == max(prior_qb_epa, na.rm = T)) %>% 
  ungroup() %>% 
  drop_na(prior_qb_epa) %>% 
  filter(season != 2016) %>% 
  group_by(player_id) %>% 
  arrange(player_id, season) %>% 
  mutate(
    qb_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      )
  ) %>% 
  ungroup() %>% 
  select(season, team, prior_qb_epa, qb_new_team) %>% 
  left_join(
    pass_rate_df %>% 
      select(season, team, prior_n_pass),
    by = c("season", "team")
  )
  
view(qb_epa_teams_df)

fan_qb_season_finish = 
  fan_qb_all %>% 
  group_by(season, player_id) %>% 
  summarise(
    fpts_total = sum(fpts)
  ) %>% 
  ungroup() %>% 
  mutate(
    fpts_total = 
      case_when(
        season < 2021 ~ fpts_total * 17 / 16,
        season >= 2021 ~ fpts_total,
        .default = NA
      )
  ) %>% 
  group_by(season) %>% 
  arrange(season, desc(fpts_total)) %>% 
  drop_na() %>% 
  mutate(
    season_rank = row_number(),
    season_finish = 
      factor(
        case_when(
          between(season_rank, 1, 20) ~ "Top 20",
          between(season_rank, 21, 50) ~ "21 - 50",
          season_rank > 50 ~ "Over 50",
          .default = NA
        ),
        levels = c("Top 20", "21 - 50", "Over 50")
      )
  ) %>% 
  ungroup()
  
view(fan_qb_season_finish)

qb_cpoe_df =
  szn_all %>%
  filter(qb_dropback == 1) %>% 
  group_by(season, posteam, passer_player_id) %>% 
  drop_na(cpoe) %>% 
  summarize(mean_cpoe = mean(cpoe)) %>% 
  arrange(desc(mean_cpoe)) %>% 
  drop_na(passer_player_id) %>% 
  ungroup() %>% 
  rename(player_id = passer_player_id) %>% 
  select(player_id, season, mean_cpoe) %>% 
  rbind(
    tibble(
      player_id = roster_qb_all %>% filter(season == 2025) %>% distinct(player_id) %>% pull(),
      season = 2025,
      mean_cpoe = NA
    )
  ) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    prior_cpoe = lag(mean_cpoe)
  ) %>% 
  ungroup()

view(qb_cpoe_df)

qb_adot_df = 
  szn_all %>%
  filter(qb_dropback == 1) %>% 
  group_by(season, passer_player_id) %>% 
  drop_na(air_yards) %>% 
  summarize(adot = mean(air_yards)) %>% 
  arrange(desc(adot)) %>% 
  ungroup() %>% 
  rename(player_id = passer_player_id) %>% 
  select(player_id, season, adot) %>% 
  rbind(
    tibble(
      player_id = roster_qb_all %>% filter(season == 2025) %>% distinct(player_id) %>% pull(),
      season = 2025,
      adot = NA
    )
  ) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    prior_adot = lag(adot)
  ) %>% 
  ungroup()

view(qb_adot_df)

qb_gl_rate_df = 
  roster_qb_all %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(rush == 1 & yardline_100 <= 5 & !is.na(rusher_player_id)) %>% 
        rename(player_id = rusher_player_id) %>% 
        group_by(player_id, season) %>% 
        summarise(
          n_gl_att = n()
        ) %>% 
        ungroup(),
      by = c("player_id", "season")
    ) %>% 
    left_join(
      szn_all %>% 
        filter(between(season, 2016, 2024)) %>% 
        filter(rush == 1 & yardline_100 <= 5 & !is.na(rusher_player_id)) %>% 
        rename(team = posteam) %>% 
        group_by(team, season) %>% 
        summarise(
          n_gl_att_team = n()
        ) %>% 
        ungroup(),
      by = c("season", "team")
    ) %>% 
    arrange(player_id, season) %>% 
    group_by(player_id) %>% 
    mutate(
      gl_rate = n_gl_att / n_gl_att_team,
      prior_gl_rate = lag(gl_rate)
    ) %>% 
    ungroup() %>% 
    select(season, player_id, prior_gl_rate)

view(qb_gl_rate_df)

qb_rush_att_df =
  roster_qb_all %>% 
  left_join(
    szn_all %>% 
      filter(between(season, 2016, 2025)) %>% 
      select(season, posteam, play_type, rusher_player_id) %>% 
      filter(play_type %in% c("run")) %>%
      rename(
        team = posteam,
        player_id = rusher_player_id
      ) %>% 
      group_by(season, player_id) %>% 
      summarise(
        n_rush = n()
      ) %>% 
      ungroup() %>% 
      mutate(
        n_rush = 
          case_when(
            season < 2021 ~ n_rush * 17 / 16,
            season >= 2021 ~ n_rush,
            .default = NA
          )
      ),
    by = c("player_id", "season")
  ) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    # prior_pass_rate = lag(pass_rate),
    prior_n_rush = lag(n_rush)
  ) %>% 
  ungroup() %>% 
  select(player_id, season, prior_n_rush)

view(qb_rush_att_df)

fan_qb_fin_all =
  fan_qb_all %>% 
  filter(between(season, 2016, 2025)) %>% 
  select(season, recent_team, position, player_id, player_display_name, fpts) %>% 
  group_by(season, player_id, player_display_name, position) %>% 
  mutate(
    games_missed = 
      case_when(
        season < 2021 ~ 16 - n(),
        season >= 2021 ~ 17 - n()
      ),
    sum_fpts = 
      case_when(
        season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
        season >= 2021 ~ sum(fpts, na.rm = T),
        .default = NA
      )
  ) %>% 
  ungroup() %>% 
  select(season, player_id, player_display_name, position, starts_with("sum_"), starts_with("mean_"), games_missed) %>% 
  distinct() %>% 
  # group_by(season) %>% 
  # mutate(season_rank = rank(desc(sum_fpts))) %>% 
  # ungroup() %>% 
  left_join(
    roster_qb_all %>% 
      select(season, player_id, team, birth_date, years_exp, draft_number) %>% 
      mutate(draft_number = replace_na(as.integer(draft_number), 260)),
    by = c("season", "player_id")
  ) %>% 
  mutate(
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    across(
      c(games_missed, sum_fpts),
      ~ lag(.),
      .names = "prior_{col}"
    ),
    qb_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      )#,
    # new_qb_new_team = 
    #   case_when(
    #     qb_new_team == 1,
    #     .default = 0
    #   )
  ) %>% 
  rename(
    # prior_ays = prior_mean_air_yards_share,
    # prior_tar_share = prior_mean_target_share,
    prior_fpts = prior_sum_fpts
  ) %>%
  ungroup() %>% 
  left_join(
    roster_qb_all %>% 
      left_join(fan_qb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, prior_fpts_other, prior_rank),
    by = c("player_id", "season")
  ) %>% 
  left_join(games_missed_qb_all, by = c("player_id", "season")) %>% 
  left_join(qb_cpoe_df, by = c("player_id", "season")) %>% 
  left_join(qb_adot_df, by = c("player_id", "season")) %>% 
  left_join(qb_gl_rate_df, by = c("player_id", "season")) %>% 
  left_join(qb_rush_att_df, by = c("player_id", "season")) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 & sum_fpts >= 100) | (is.na(prior_rank))) %>% 
  filter(prior_rank <= 30 | (is.na(prior_rank)))

view(fan_qb_fin_all)
  
# roster_wr_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% 
#   select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
#   mutate(
#     ind_top_20 = ifelse(season_rank <= 20, 1, 0)
#   ) %>% 
#   group_by(player_id) %>% 
#   arrange(player_id, season) %>% 
#   mutate(
#     prior_ind_top_20 = lag(ind_top_20),
#     prior_fpts = lag(fpts_total)
#   ) %>% 
#   ungroup() %>% 
#   group_by(season, team) %>% 
#   arrange(season, team) %>% 
#   filter(season != 2016) %>% 
#   mutate(
#     top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
#     prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
#   )
# 
# fan_wr_fin_all %>% 
#   left_join(fan_wr_season_finish, by = c("player_id", "season")) %>% view

# fan2023 = 
#   szn_all %>% 
#   filter(season == 2023) %>% 
#   calculate_player_stats(weekly = T) %>% 
#   mutate(fpts = fantasy_points + 0.5 * receptions)

# 
# roster2023 = 
#   fast_scraper_roster(2023)
# 
# view(roster2023)

# try to predict 2023 from 2022:

# view(fan2022)

# get players who switched teams:
# fan2022 %>% 
#   filter(position == "WR") %>% 
#   select(recent_team, position, player_id, player_name, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   # group_by(player_id, player_name, recent_team, position) %>% 
#   select(player_id, player_name, recent_team, position) %>% 
#   distinct() %>% 
#   group_by(player_id) %>% 
#   filter(n() > 1)
```

### Train models

```{r wr team prior}
load("mod_df_as_of_2023.Rdata")
load("coach_df_as_of_2025.Rdata")

fpts_qb_train_df = 
  fan_qb_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, sum_fpts, prior_qb_epa, prior_n_pass, prior_n_rush, prior_fpts, prior_cpoe, prior_adot, prior_gl_rate, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, qb_new_team, games_missed_rate) %>% 
  select(-c(prior_n_pass, coach_exp_off, prior_qb_epa, player_age)) %>%
  drop_na() %>% 
  arrange(player_id) %>% 
  select(-player_id)

view(fpts_qb_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_qb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_qb

# Lasso
set.seed(37564)
mod_lass_qb = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_qb_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-1, 2, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_qb, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_qb$bestTune
min(mod_lass_qb$results$RMSE)

# KNN
set.seed(37564)
mod_knn_qb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(6, 30, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_qb, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_qb$bestTune
min(mod_knn_qb$results$RMSE)

# MARS
set.seed(37564)
mod_mars_qb = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_qb_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 3:12), 
                 trControl = ctrl)
ggplot(mod_mars_qb, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_qb$bestTune
min(mod_mars_qb$results$RMSE)
#mod_mars_wr$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_qb = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_qb_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(1000, 3000, 5000),
                                         interaction.depth = c(2:3),
                                         shrinkage = c(0.0007, 0.0011, 0.0015),
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_qb, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_qb$bestTune
min(mod_boost_qb$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_qb = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-2, 0, len = 5)),
                                       sigma = exp(seq(-5,-3, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_qb, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_qb$bestTune
min(mod_svm_qb$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_qb, 
  method = "permute", 
  train = fpts_qb_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_qb$finalModel, mod_lass_qb$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_wr, LASSO = mod_lass_wr, MARS = mod_mars_wr, KNN = mod_knn_wr, BOOST = mod_boost_wr, SVM = mod_svm_wr))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")

mod_errors = 
  tibble(
    resid_glm = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_glm_wr, newdata = fpts_wr_train_df)),
    resid_knn = fpts_wr_train_df$sum_fpts - predict(mod_knn_wr, newdata = fpts_wr_train_df),
    resid_lasso = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_lass_wr, newdata = fpts_wr_train_df)),
    resid_mars = as.vector(fpts_wr_train_df$sum_fpts - predict(mod_mars_wr, newdata = fpts_wr_train_df)),
    resid_boost = fpts_wr_train_df$sum_fpts - predict(mod_boost_wr, newdata = fpts_wr_train_df),
    resid_svm = fpts_wr_train_df$sum_fpts - predict(mod_svm_wr, newdata = fpts_wr_train_df)
  )

corrplot(cor(mod_errors, use = "complete.obs"), diag = F, method = "shade", type = "lower")

# mod_glm_wr$finalModel$residuals %>% as.vector()




# fpts_wr_test_df = 
#   fan2023 %>% 
#   filter(position == "WR") %>% 
#   select(season, recent_team, position, player_id, player_display_name, receptions, receiving_yards, receiving_air_yards, racr, air_yards_share, target_share, fpts) %>% 
#   group_by(season, player_id, player_display_name, position) %>% 
#   summarise(
#     sum_fpts = sum(fpts, na.rm = T)
#   ) %>% 
#   ungroup() %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       filter(position == "WR") %>% 
#       select(player_id, team, birth_date, years_exp),
#     by = "player_id"
#   ) %>% 
#   drop_na(team) %>% 
#   filter(player_id %in% c(fpts_wr_train_df %>% pull(player_id)))
# 
# players_diff = setdiff(fpts_wr_test_df$player_id, fpts_wr_train_df$player_id)
# 
# roster2023 %>% filter(gsis_id %in% c(players_diff)) %>% view
# 
# fpts_wr_train_df %>% 
#   cbind(
#     pred_fpts_glm = predict(mod_glm),
#     pred_fpts_lasso = predict(mod_lass),
#     pred_fpts_knn = predict(mod_knn),
#     pred_fpts_mars = predict(mod_mars),
#     pred_fpts_boost = predict(mod_boost)#,
#     #pred_fpts_svm = predict(mod_svm)
#   ) %>% 
#   left_join(
#     roster2023 %>% 
#       rename(player_id = gsis_id) %>% 
#       select(player_id, full_name),
#     by = "player_id"
#   ) %>% 
#   view

```

### Make model for rookies

```{r wr rookie}
fpts_qb_rookie_train_df =
  roster_qb_all %>% 
  filter(rookie_year == season) %>% 
  select(season, player_id, full_name, team, birth_date, draft_number) %>% 
  mutate(
    draft_number = replace_na(as.integer(draft_number), 260),
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25,
    team = 
      case_when(
        team == "SD" ~ "LAC",
        team == "OAK" ~ "LV",
        .default = team
      )
  ) %>% 
  drop_na(team) %>% 
  left_join(qb_epa_teams_df, by = c("season", "team")) %>% 
  left_join(
    fan_qb_all %>% 
      select(season, position, player_id, player_display_name, fpts) %>% 
      group_by(season, player_id, player_display_name, position) %>% 
      mutate(
        sum_fpts = 
          case_when(
            season < 2021 ~ sum(fpts, na.rm = T) * 17 / 16,
            season >= 2021 ~ sum(fpts, na.rm = T),
            .default = NA
          )
      ) %>% 
      ungroup() %>% 
      select(season, player_id, sum_fpts) %>% 
      distinct(),
    by = c("season", "player_id")
  ) %>% 
  left_join(
    roster_qb_all %>% 
      left_join(fan_qb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct(),
    by = c("season", "team")
  ) %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>%
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 15) %>% 
  ungroup() %>% 
  select(player_id, sum_fpts, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na() %>% 
  arrange(player_id) %>%
  select(-player_id)

view(fpts_qb_rookie_train_df)

ctrl = trainControl(method = "repeatedcv", number = 5, repeats = 10)
# ctrl = trainControl(method = "cv", number = 5)

# train_df = 
#   mod_df %>% 
#   filter(season != 2016) %>% 
#   select(wins, prior_off_rush_epa:prior_def_pass_epa, prior_opp_wins, prior_fum, prior_fgm, active_log, avg_age, grade_rank, prior_wins, coach_exp)

#trRows = createDataPartition(y = mod_df$wins, p = 0.75, list = FALSE)

#train_df = mod_df[trRows, ]
#test_df = mod_df[-trRows, ]

# GLM
set.seed(37564)
mod_glm_qb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_rookie_train_df, 
                #subset = season,
                method = "glm", 
                trControl = ctrl)
mod_glm_qb_rook

# Lasso
set.seed(37564)
mod_lass_qb_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_qb_rookie_train_df, 
                 method = "glmnet", 
                 tuneGrid = expand.grid(alpha = 1, 
                                        lambda = exp(seq(-1, 3, length = 50))),
                 trControl = ctrl)
ggplot(mod_lass_qb_rook, highlight = T) + 
  ggtitle("Lasso") +
  theme(plot.title = element_text(hjust = 0.5))
mod_lass_qb_rook$bestTune
min(mod_lass_qb_rook$results$RMSE)

# KNN
set.seed(37564)
mod_knn_qb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_rookie_train_df, 
                method = "knn", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(10, 30, by = 2)), 
                trControl = ctrl)
ggplot(mod_knn_qb_rook, highlight = T) + 
  ggtitle("KNN") +
  theme(plot.title = element_text(hjust = 0.5))
mod_knn_qb_rook$bestTune
min(mod_knn_qb_rook$results$RMSE)

# MARS
set.seed(37564)
mod_mars_qb_rook = train(sum_fpts ~ .,
                 na.action = na.exclude, 
                 data = fpts_qb_rookie_train_df, 
                 method = "earth", 
                 tuneGrid = expand.grid(degree = 1:3, nprune = 1:10), 
                 trControl = ctrl)
ggplot(mod_mars_qb_rook, highlight = T) + 
  ggtitle("MARS") +
  theme(plot.title = element_text(hjust = 0.5))
mod_mars_qb_rook$bestTune
min(mod_mars_qb_rook$results$RMSE)
#mod_mars$finalModel %>% summary

# Boost
set.seed(37564)
mod_boost_qb_rook = train(sum_fpts ~ .,
                  na.action = na.exclude, 
                  data = fpts_qb_rookie_train_df, 
                  method = "gbm", 
                  tuneGrid = expand.grid(n.trees = c(3000, 5000, 7000),
                                         interaction.depth = 1,
                                         shrinkage = c(0.0003, 0.0005, 0.0007), 
                                         n.minobsinnode = 1), 
                  trControl = ctrl,
                  verbose = F)
ggplot(mod_boost_qb_rook, highlight = T) + 
  ggtitle("Boost") +
  theme(plot.title = element_text(hjust = 0.5))
mod_boost_qb_rook$bestTune
min(mod_boost_qb_rook$results$RMSE)

#boost = tibble(wins_boost = predict(mod_boost, newdata = test_df))

# SVM
set.seed(37564)
mod_svm_qb_rook = train(sum_fpts ~ .,
                na.action = na.exclude, 
                data = fpts_qb_rookie_train_df,
                preProcess = c("scale", "center"),
                method = "svmRadialSigma",
                tuneGrid = expand.grid(C = exp(seq(-2, 2, len = 5)),
                                       sigma = exp(seq(-6,-3, len = 5))),
                trControl = ctrl)
ggplot(mod_svm_qb_rook, highlight = T) + 
  ggtitle("SVM Radial") +
  theme(plot.title = element_text(hjust = 0.5))
mod_svm_qb_rook$bestTune
min(mod_svm_qb_rook$results$RMSE)

#svm = tibble(wins_svm = predict(mod_svm, newdata = test_df))

# Variable Importance
set.seed(37564)
vip(
  mod_boost_qb_rook, 
  method = "permute", 
  train = fpts_qb_rookie_train_df,
  target = "sum_fpts",
  metric = "rmse",
  nsim = 50,
  pred_wrapper = predict,
  geom = "boxplot", 
  all_permutations = T,
  mapping = aes_string(fill = "Variable", alpha = 0.75)
)

coef(mod_lass_qb_rook$finalModel, mod_lass_qb_rook$bestTune$lambda)

# Resamples
set.seed(37564)
res = resamples(list(GLM = mod_glm_qb_rook, LASSO = mod_lass_qb_rook, MARS = mod_mars_qb_rook, KNN = mod_knn_qb_rook, BOOST = mod_boost_qb_rook, SVM = mod_svm_qb_rook))
summary(res)
bwplot(res, metric = "RMSE", main = "RMSE for Repeated 5-Fold CV Using Various Models")
```

### Run model on test data

```{r pred test}
fpts_qb_test_df =
  roster_qb_all %>% 
  filter(season %in% c(2024, 2025)) %>% 
  arrange(player_id, season) %>% 
  group_by(player_id) %>% 
  mutate(
    qb_new_team = 
      case_when(
        lag(team) != team ~ 1,
        .default = 0
      ),
    draft_number = replace_na(as.integer(draft_number), 260)
  ) %>% 
  ungroup() %>% 
  filter(season %in% 2025) %>% 
  mutate(player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25) %>% 
  left_join(
    fan_qb_fin_all %>% 
      filter(season == 2024) %>% 
      select(player_id, sum_fpts) %>% 
      rename(
        # prior_games_missed = games_missed,
        # prior_ays = mean_air_yards_share,
        # prior_tar_share = mean_target_share,
        prior_fpts = sum_fpts
      ),
    by = "player_id"
  ) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_qb_epa, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_qb_all %>% 
      left_join(fan_qb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        top_20_other = sum(prior_ind_top_20, na.rm = T) - prior_ind_top_20,
        prior_fpts_other = sum(prior_fpts, na.rm = T) - prior_fpts
      ) %>% 
      ungroup() %>% 
      select(player_id, season, team, prior_fpts_other, prior_rank) %>% 
      filter(season == 2025),
    by = c("season", "player_id", "team")
  ) %>% 
  left_join(
    coach_df %>% 
      filter(season == 2025) %>% 
      select(season, team, coach_exp_off),
    by = c("season", "team")
  ) %>% 
  # filter(prior_rank <= 100 | (prior_rank > 100 & prior_games_missed > 8 | (is.na(prior_rank)))) %>% 
  left_join(games_missed_qb_all, by = c("player_id", "season")) %>% 
  left_join(qb_cpoe_df, by = c("player_id", "season")) %>% 
  left_join(qb_adot_df, by = c("player_id", "season")) %>% 
  left_join(qb_gl_rate_df, by = c("player_id", "season")) %>% 
  left_join(qb_rush_att_df, by = c("player_id", "season")) %>% 
  mutate(
    across(c(prior_n_rush, prior_gl_rate), ~ replace_na(., 0))
  ) %>% 
  filter(prior_rank <= 30 | is.na(prior_rank)) %>% 
  select(player_id, full_name, team, prior_qb_epa, prior_n_pass, prior_n_rush, prior_fpts, prior_cpoe, prior_adot, prior_gl_rate, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, qb_new_team, games_missed_rate) %>% 
  select(-c(prior_n_pass, coach_exp_off, prior_qb_epa, player_age)) %>% 
  drop_na()

view(fpts_qb_test_df)

fpts_qb_rookie_test_df = 
  roster_qb_all %>% 
  filter(rookie_year == 2025) %>% 
  mutate(
    draft_number = replace_na(as.integer(draft_number), 260),
    player_age = as.double(as.Date(str_c(as.character(season), "-09-01")) - as.Date(birth_date)) / 365.25
  ) %>% 
  left_join(
    fin_df %>% 
    # mod_df %>% 
      filter(season == 2024) %>% 
      select(team, off_pass_epa) %>% 
      rename(prior_off_pass_epa = off_pass_epa),
    by = "team"
  ) %>% 
  left_join(
    qb_epa_teams_df %>% 
      filter(season == 2025) %>% 
      select(team, prior_n_pass),
    by = "team"
  ) %>% 
  left_join(
    roster_qb_all %>% 
      left_join(fan_qb_season_finish, by = c("player_id", "season")) %>% 
      select(player_id, season, team, full_name, fpts_total, season_rank) %>% 
      mutate(
        ind_top_20 = ifelse(season_rank <= 20, 1, 0)
      ) %>% 
      group_by(player_id) %>% 
      arrange(player_id, season) %>% 
      mutate(
        prior_ind_top_20 = lag(ind_top_20),
        prior_fpts = lag(fpts_total),
        prior_rank = lag(season_rank)
      ) %>% 
      ungroup() %>% 
      group_by(season, team) %>% 
      arrange(season, team) %>% 
      filter(season != 2016) %>% 
      mutate(
        prior_fpts_other = sum(prior_fpts, na.rm = T)
      ) %>% 
      ungroup() %>% 
      select(season, team, prior_fpts_other) %>% 
      distinct() %>% 
      filter(season == 2025),
    by = c("season", "team")
  ) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  group_by(season) %>% 
  arrange(season, draft_number) %>% 
  slice_min(draft_number, n = 10) %>%
  ungroup() %>% 
  select(player_id, full_name, team, prior_n_pass, prior_off_pass_epa, prior_fpts_other, player_age, draft_number, coach_exp_off) %>% 
  drop_na()

view(fpts_qb_rookie_test_df)

fpts_qb_2025 = 
  fpts_qb_test_df %>% 
  mutate(
    pred_fpts_mars = predict(mod_mars_qb, newdata = fpts_qb_test_df)[, 1],
    pred_fpts_boost = predict(mod_boost_qb, newdata = fpts_qb_test_df),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_svm = predict(mod_svm_qb, newdata = fpts_qb_test_df),
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
  mutate(
    cohort = "Non-Rookie"
  ) %>% 
  rbind(
    fpts_qb_rookie_test_df %>%
      mutate(
        pred_fpts_mars = predict(mod_mars_qb_rook, newdata = fpts_qb_rookie_test_df)[, 1],
        pred_fpts_boost = predict(mod_boost_qb_rook, newdata = fpts_qb_rookie_test_df),
        pred_fpts_svm = predict(mod_svm_qb_rook, newdata = fpts_qb_rookie_test_df)
      ) %>%
      select(team, player_id, full_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>%
      mutate(
        cohort = "Rookie"
      )
  ) %>%
  mutate(
    pred_fpts_mars = round(pred_fpts_mars, 2),
    pred_fpts_boost = round(pred_fpts_boost, 2),
    pred_fpts_svm = round(pred_fpts_svm, 2),
    pred_fpts_fin_mod = 
      case_when(
        cohort == "Rookie" ~ pred_fpts_mars,
        cohort == "Non-Rookie" ~ pred_fpts_svm,
        .default = NA
      )
  ) %>% 
  arrange(-pred_fpts_fin_mod) %>% 
  rowid_to_column("qb_rank")

view(fpts_qb_2025)

# check mods w/ last year's data:
fan_wr_fin_all %>% 
  left_join(fin_df, by = c("team", "season")) %>% 
  left_join(coach_df, by = c("team", "season")) %>% 
  filter(season == 2024) %>% 
  # left_join(mod_df, by = c("team", "season")) %>% 
  select(player_id, team, player_display_name, sum_fpts, prior_ays, prior_tar_share, games_missed_rate, prior_fpts, prior_qb_epa, prior_n_pass, prior_off_pass_epa, player_age, draft_number, prior_fpts_other, coach_exp_off, new_qb_new_team) %>% 
  select(-c(prior_qb_epa, coach_exp_off)) %>% 
  drop_na() %>% 
  arrange(player_id) %>% 
  mutate(
    pred_fpts_mars = predict(mod_mars_wr, newdata = .)[, 1],
    pred_fpts_boost = predict(mod_boost_wr, newdata = .),
    # pred_fpts_glm = predict(mod_glm_wr, newdata = fpts_wr_test_df),
    # pred_fpts_lass = predict(mod_lass_wr, newdata = fpts_wr_test_df),
    pred_fpts_svm = predict(mod_svm_wr, newdata = .),
    # pred_fpts_knn = predict(mod_knn_wr, newdata = fpts_wr_test_df)
  ) %>% 
  select(team, player_id, player_display_name, pred_fpts_boost, pred_fpts_mars, pred_fpts_svm) %>% 
  # rbind(
  #   fpts_wr_rookie_test_df %>% 
  #     mutate(
  #       pred_fpts_mars = predict(mod_mars_wr_rook, newdata = fpts_wr_rookie_test_df)[, 1]
  #     ) %>% 
  #     select(team, full_name, pred_fpts_mars)
  # ) %>% 
  mutate(
    pred_fpts_mars = round(pred_fpts_mars, 2),
    pred_fpts_boost = round(pred_fpts_boost, 2),
    pred_fpts_svm = round(pred_fpts_svm, 2)
  ) %>% 
  arrange(-pred_fpts_svm) %>% 
  rowid_to_column("wr_rank") %>% 
  view

# write.csv(fpts_wr_2024, "fpts_wr_2024.csv", row.names = F)

set.seed(37564)
boot_splits = bootstraps(fpts_qb_train_df, times = 100)

# 2. Predict for each bootstrap model
boot_preds = map(boot_splits$splits, ~ {
  train_data = analysis(.x)
  
  # Train SVM model
  svm_model = train(
    sum_fpts ~ ., 
    data = train_data,
    method = "svmRadial",
    trControl = trainControl(method = "none"),  # already tuned
    tuneGrid = tibble(
      sigma = mod_svm_qb$bestTune[[1]],
      C = mod_svm_qb$bestTune[[2]]
    )
  )
  
  # Predict on the fixed test set
  predict(svm_model, newdata = fpts_qb_test_df)
})

# 3. Combine predictions into a matrix
pred_matrix = do.call(cbind, boot_preds)

# 4. Compute mean prediction and 95% prediction interval
qb_boot_pred_bands = 
  fpts_qb_test_df %>%
  select(player_id, full_name) %>%
  mutate(
    pred_mean  = round(rowMeans(pred_matrix), 2), 
    pred_lower = round(apply(pred_matrix, 1, quantile, probs = 0.1), 2),
    pred_upper = round(apply(pred_matrix, 1, quantile, probs = 0.9), 2),
  )

view(qb_boot_pred_bands)

set.seed(37564)
boot_splits_rook = bootstraps(fpts_qb_rookie_train_df, times = 100)

# Fit model to each resample and generate predictions
boot_preds_rook = 
  boot_splits_rook %>%
  mutate(
    preds = 
      map(
        splits, 
        ~ {
          model = earth(sum_fpts ~ ., data = analysis(.x), nprune = mod_mars_qb_rook$bestTune[[1]], degree = mod_mars_qb_rook$bestTune[[2]])
    predict(model, fpts_qb_rookie_test_df)
      }
    )
  )

# Convert predictions into long-format tibble
qb_boot_pred_bands_rook = 
  boot_preds_rook %>%
  select(preds) %>%
  unnest_longer(preds, indices_to = "player_index") %>%
  group_by(player_index) %>%
  summarise(
    pred_mean = mean(preds),
    pred_lower = quantile(preds, 0.10),
    pred_upper = quantile(preds, 0.90),
    .groups = "drop"
  ) %>%
  mutate(
    full_name = fpts_qb_rookie_test_df$full_name[player_index],
    player_id = fpts_qb_rookie_test_df$player_id[player_index],
    across(c(pred_mean, pred_lower, pred_upper), ~ round(., 2))
  ) %>%
  select(player_id, full_name, pred_mean, pred_lower, pred_upper)

view(qb_boot_pred_bands_rook)

fpts_qb_2025_fin_rank = 
  fpts_qb_2025 %>% 
  left_join(
    qb_boot_pred_bands %>% 
      rbind(qb_boot_pred_bands_rook), 
    by = c("player_id", "full_name")
  )

view(fpts_qb_2025_fin_rank)

fpts_qb_2025_fin_rank %>% 
  left_join(
    teams_colors_logos %>% 
      rename(team = team_abbr) %>% 
      select(team, team_color), 
    by = "team"
  ) %>% 
  filter(qb_rank <= 20) %>% 
  ggplot(aes(y = reorder(full_name, pred_fpts_fin_mod), x = pred_fpts_fin_mod)) +
  geom_errorbarh(aes(xmin = pred_lower, xmax = pred_upper, color = team_color), height = 1) +
  geom_point(aes(color = team_color), size = 2.4) +
  geom_text(aes(label = full_name, x = pred_upper + 1, color = team_color), hjust = 0, size = 3.15)+
  scale_color_identity() + 
  scale_x_continuous(breaks = seq(0, 375, by = 25)) +
  labs(
    x = "Predicted Fantasy Points (0.5 PPR)",
    y = NULL,
    title = "QB Fantasy Point Predictions with 80% Confidence Bands"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank()
  ) +
  coord_cartesian(
    clip = "off",
    xlim = c(150, 365)
  )

# exporting rankings:

fpts_qb_2025_fin_rank_export = 
  fpts_qb_2025_fin_rank %>% 
  select(qb_rank, team, full_name, pred_fpts_fin_mod, pred_lower, pred_upper, cohort)# %>% 
  # mutate(
  #   pt_diff = pred_fpts_fin_mod - lag(pred_fpts_fin_mod),
  #   tier_init = ifelse(is.na(pt_diff) | pt_diff < -5, 1, 0)
  # )

write.csv(fpts_qb_2025_fin_rank_export, glue::glue("fpts_qb_2025_fin_rank_{format(Sys.Date(), '%Y_%m_%d')}.csv"), row.names = F)
```

## Combine All Rankings

```{r all pos ranks}
fpts_all_rank_export = 
  fpts_wr_2025_fin_rank_export %>% 
  mutate(
    pos_rank = str_c("WR", wr_rank)
  ) %>% 
  relocate(pos_rank, .after = full_name) %>% 
  select(-wr_rank) %>% 
  rbind(
    fpts_rb_2025_fin_rank_export %>% 
      mutate(
        pos_rank = str_c("RB", rb_rank)
      ) %>% 
      relocate(pos_rank, .after = full_name) %>% 
      select(-rb_rank)
  ) %>% 
  rbind(
    fpts_te_2025_fin_rank_export %>% 
      mutate(
        pos_rank = str_c("TE", te_rank)
      ) %>% 
      relocate(pos_rank, .after = full_name) %>% 
      select(-te_rank)
  ) %>% 
  rbind(
    fpts_qb_2025_fin_rank_export %>% 
      mutate(
        pos_rank = str_c("QB", qb_rank)
      ) %>% 
      relocate(pos_rank, .after = full_name) %>% 
      select(-qb_rank)
  ) %>% 
  mutate(
    pos = str_extract(pos_rank, "^[A-Z][A-z]")
  ) %>% 
  relocate(pos) #%>% 
  # arrange(pos, pos_rank) %>% 
  # group_by(pos) %>% 
  # mutate(
  #   pos_tier = 
  #     case_when(row_)
  # )

vegas_proj_df = 
  read.csv("season_long_proj_table.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    proj_vegas = projections - 0.5 * replace_na(receptions, 0)
  ) %>% 
  rename(full_name = name) %>% 
  arrange(pos, -proj_vegas) %>% 
  group_by(pos) %>% 
  mutate(
    pos_rank_vegas = str_c(pos, row_number())
  ) %>% 
  ungroup()

view(vegas_proj_df)

adp_df = 
  read.csv("FantasyPros_2025_Overall_ADP_Rankings.csv") %>% 
  janitor::clean_names() %>% 
  rename(
    full_name = player,
    pos_rank_adp = pos
  ) %>% 
  mutate(
    full_name = str_remove(str_remove(str_remove(full_name, " Sr.$"), " Jr.$"), " [I]+$"), 
    team = 
      case_when(
        team == "LAR" ~ "LA",
        team == "JAC" ~ "JAX",
        .default = team
      )
  )

view(adp_df)

fpts_all_rank_fin_export =
  fpts_all_rank_export %>% 
  mutate(
    full_name = str_remove(str_remove(full_name, " Sr.$"), " Jr.$"),
    full_name = 
      case_when(
        full_name == "Josh Palmer" ~ "Joshua Palmer",
        full_name == "Devon Achane" ~ "De'Von Achane",
        .default = full_name
      )
  ) %>% 
  left_join(
    vegas_proj_df %>% 
      select(pos, full_name, proj_vegas, pos_rank_vegas),
    by = c("full_name", "pos")
  ) %>% 
  left_join(
    adp_df %>% 
      select(full_name, team, pos_rank_adp),
    by = c("full_name", "team")
  ) %>% 
  mutate(
    diff_adp = as.integer(str_remove(pos_rank_adp, "^[A-Z]+")) - as.integer(str_remove(pos_rank, "^[A-Z]+")),
    diff_adp_vegas = as.integer(str_remove(pos_rank_adp, "^[A-Z]+")) - as.integer(str_remove(pos_rank_vegas, "^[A-Z]+")),
    draft_strat = 
      factor(
        case_when(
          diff_adp >= 5 & diff_adp_vegas >= 5 ~ "Elite Value",
          (diff_adp >= 5 & diff_adp_vegas > -5) | 
            (diff_adp > -5 & diff_adp_vegas >= 5) ~ "Good Value",
          diff_adp <= -5 & diff_adp_vegas <= -5 ~ "Horrible Value",
          (diff_adp <= -5 & diff_adp_vegas < 5) |
            (diff_adp < 5 & diff_adp_vegas <= -5) ~ "Bad Value",
          between(diff_adp, -4, 4) & between(diff_adp_vegas, -4, 4) ~ "At Value",
          .default = "Judgement Call"
        ),
        levels = c("Elite Value", "Good Value", "At Value", "Judgement Call", "Bad Value", "Horrible Value")
      ),
    full_name = 
      case_when(
        cohort == "Rookie" ~ str_c(full_name, " *"),
        .default = full_name
      )
  ) %>% 
  select(-c(cohort, starts_with("diff_adp"))) %>% 
  drop_na()

write.csv(fpts_all_rank_fin_export, glue::glue("fpts_all_rank_fin_export_{format(Sys.Date(), '%Y_%m_%d')}.csv"), row.names = F)
```

## Draft Order

```{r draft order}
set.seed(42069)
tibble(
  names = c("David", "Jon", "Chris", "Robbie", "Mike", "Bek", "Eddie", "Greg", "Pete", "Ron"),
  order = sample(1:length(names))
) %>% 
  arrange(order) %>% 
  relocate(order) %>% 
  labelled::set_variable_labels(
    names = "Name",
    order = "Pick"
  ) %>% 
  gtreg::tbl_listing() %>% 
  gtsummary::modify_caption("**Draft Order**")

```

